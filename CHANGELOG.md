# 2025-10-18
## 重演功能
### 使用场景
当你想要在老的楼层修正 LLM 犯蠢的结果，或是处理部分 extensible/required 相关的变量时，可以考虑使用这个功能。
### 作用
你可以从第 N 条消息开始，根据聊天内容中的变量更新语句重演所有变量变更，借此恢复指定楼层的变量状态，或是修复指定楼层的变量更新错误。
### 使用方式
在 扩展 栏的 `MVU 变量框架` 下，点击 `重演楼层` 按钮。之后你需要先输入 `对哪一层进行重演`；再输入 `从哪一层开始重演`。
确认后会从那一行的变量状态开始，重新进行演算，直到 `进行重演` 的那一层聊天记录为止。
### 写给角色卡制作者
这个功能的核心理念是 [FSM](https://zh.wikipedia.org/wiki/%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E6%9C%BA)，这意味着所有的回调(`SINGLE_VARIABLE_UPDATED` 等事件)中的修改操作必须是基于 initvar/聊天记录 的。具体而言可以参考下面的 CheckList:
- 如果在前端里对变量进行了修改，需要将进行的修改操作以 MVU修改语句 的形式存储到当前楼层中。（对用户透明的修改接口计划开发中）
  例: 前端里有一个按键，按了金钱 -114。需要在按的时候，往聊天记录里插一条 `_.add('money', -100);`
- 如果在事件回调中使用了全局变量，需要保证那些全局变量会在 `VARIABLE_UPDATE_STARTED` 或是 `COMMAND_PARSED` 时重新初始化。
  例：正确的用法是之前变量保护的实现，`VARIABLE_UPDATE_STARTED` 时在全局变量里记录变量的老值，`VARIABLE_UPDATE_ENDED` 时与老值对比。
- 事件回调的代码逻辑中，最好不要使用 `随机数` `当前系统时间` 等逻辑，请用 `伪随机` `当前楼层的创建时间` 作为代替。
  例：如果要在 `VARIABLE_UPDATE_ENDED` 做一些概率触发，需要使用 `当前楼层的创建时间` 作为种子来取伪随机数，而不是直接使用 `Math.random()`

## 快照功能
### 使用场景 & 作用
支持重演后，可以不再保留大部分楼层的变量，仅保留少数楼层作为快照，此功能可以直接指定某一楼层作为快照楼层，不会在清理操作中被删除变量状态。
### 使用方式
在 扩展 栏的 `MVU 变量框架` 下，点击 `快照楼层` 按钮。之后你需要输入 `保留哪一层作为快照`；之后这一个楼层始终不会被清理。

## 清除旧楼层变量
### 变更
现在默认会每 50 层保留一层作为快照楼层(可通过 `快照保留间隔` 配置)，且 0 层永远不会被清理。

# 2025-10-09
## 更新内容

### 额外模型解析
- 现在新增了标签 `[mvu_plot]`，名字包含这个标签的世界书条目，不会在更新变量的请求中发送。在 `随AI输出` 模式下会正常发送。

### 新增 `command_parsed` 事件
在这个事件里面，会传入从文本内容中解析出的 CommandInfo[] 指令列表。
开发者可以在这个事件中修改指令列表，进行路径的兜底等操作，如：
- 保护特定变量：扫描 Command 列表中，是否有对特定变量进行修改的，删除它们
- 兜底错误的llm输入：如 Gemini 在变量里面加横杠了 `悠-纪.好感度` 可以通过在这个回调里面调整 Path 来修改为正确的
- 给角色增加别名：如角色 `雪莲` 有时候 llm 飙繁体 `雪蓮`，可以通过这个回调，给角色增加若干个别名，保证各种情况都能正确更新变量。

下面是一个例子，会过滤掉所有对 `教堂.desc1` 变量的修改：
```javascript
eventOn('mag_command_parsed', commandParsed);

function commandParsed(_variables: MvuData, commands: CommandInfo[]) {
    // 移除所有对 教堂.desc1 的修改
    _.remove(commands, cmd => {
        if (cmd.type == 'set') {
            if (cmd.args[0].indexOf(`教堂.desc1`) !== -1) return true;
        }
        return false;
    });
}
```
相关类型的详细定义可以参考： https://github.com/MagicalAstrogy/MagVarUpdate/blob/beta/artifact/export_globals.d.ts

# 2025-10-08
## 更新内容
### 专门配置界面
将 MVU 相关的配置移动到了 `扩展` 界面上，且配置结果对全局生效

### 新增双模型风格变量更新方式
- 除了原本的 `随 AI 输出` 更新
- 你现在还可以选择 `额外模型解析` 来更新变量：**一个 AI 回复剧情，一个 AI 专门解析剧情、通过回复或函数调用来更新变量**
  这种 `额外模型解析` 更新方式只对适配了的角色卡有效，对没适配的角色卡依旧会使用 `随 AI 输出` 来更新
  ——**但适配非常简单**，你只需要拆分条目、更改条目名称，具体请__点击配置界面上的问号查看说明__ 和 参考最新圣女理理角色卡（[类脑](https://discord.com/channels/1134557553011998840/1381913493774536755) [旅程](https://discord.com/channels/1291925535324110879/1367723727827111998)  世界书内容: https://github.com/MagicalAstrogy/MagVarUpdate/tree/beta/example ）

为了能制作这些功能，MVU 所需要的酒馆最低版本变为 `1.13.4`

推荐版本为：
- 酒馆 `1.13.5`+ (下一个版本)
- 提示词模板 `1.15.2.1`+

### 酒馆助手最低版本要求
为了能制作这些功能，MVU 所需要的酒馆助手最低版本变为 `3.4.17`
如果你不希望进行升级酒馆助手，可以切换为下面的 MVU 版本，不过接下来不会对这个版本的 MVU 做进一步的维护：
```
import 'https://testingcf.jsdelivr.net/gh/MagicalAstrogy/MagVarUpdate@a30e5dcee286f3cb96c0914abd206641efa156f3/artifact/bundle.js';
```

感谢 <@796962656065028097> 对此功能的贡献
感谢 Hajimary(类脑ID未知) 对此功能的贡献

# 2025-10-03
## 缺陷修正
在 template 被添加后，立刻更新schema，使其可以在同一条消息内对template进行插入；修正了 template内的 $meta 不会被正确移除的问题。

具体的场景是：
```json5
{
root: {
                    $meta: {
                        extensible: true,
                        template: {
                            $meta: {
                                extensible: true,
                            },
                        },
                    },
                }
}
```
这样的结构，执行下面的语句:
```
_.insert('root', 'new_node', {"owo": 123});
_.insert('root.new_node', 'tvt', "234");
```
结果为:
```json5
{
  root: { /*extensible*/
    { owo: 123, tvt: '234'/*extensible*/ }
  }
}
```
在原本的老版本中，第二个语句会出错，且 `$meta` 不会被移除。
