{"version":3,"file":"bundle.js","mappings":"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","sources":["webpack://mag-variable-update/./src/variable_def.ts","webpack://mag-variable-update/./src/function.ts","webpack://mag-variable-update/./src/variable_init.ts","webpack://mag-variable-update/./src/main.ts"],"sourcesContent":["\n\nexport type GameData = {\n    initialized_lorebooks: string[];\n    stat_data: Record<string, any>;\n    display_data: Record<string, any>;\n    delta_data: Record<string, any>;\n};\n\nexport interface VariableData\n{\n    old_variables: GameData,\n    /**\n     * 输出变量，仅当实际产生了变量变更的场合，会产生 newVariables\n     */\n    new_variables?: GameData\n}\n\nexport const variable_events = {\n    SINGLE_VARIABLE_UPDATED: 'mag_variable_updated',\n    VARIABLE_UPDATE_ENDED: 'mag_variable_update_ended',\n    VARIABLE_UPDATE_STARTED: 'mag_variable_update_started',\n    INVOKE_MVU_PROCESS: 'mag_invoke_mvu'\n} as const;\n\nexport type ExtendedListenerType = {\n    [variable_events.SINGLE_VARIABLE_UPDATED]: (\n            stat_data: Record<string, any>,\n            path: string,\n            _oldValue: any,\n            _newValue: any\n    ) => void;\n    [variable_events.VARIABLE_UPDATE_STARTED]: (\n            variables: GameData,\n            out_is_updated: boolean\n    ) => void;\n    [variable_events.VARIABLE_UPDATE_ENDED]: (variables: GameData, out_is_updated: boolean) => void;\n    [variable_events.INVOKE_MVU_PROCESS]: (message_content: string, variable_info : VariableData) => void;\n};\n","import {variable_events, VariableData} from \"@/variable_def\";\n\n\nexport function trimQuotesAndBackslashes(str: string): string {\n    if (!_.isString(str)) return str;\n    // Regular expression to match backslashes and quotes (including backticks) at the beginning and end\n    return str.replace(/^[\\\\\"'` ]*(.*?)[\\\\\"'` ]*$/, '$1');\n}\n\n/**\n * 从大字符串中提取所有 .set(${path}, ${new_value});//${reason} 格式的模式\n * 并解析出每个匹配项的路径、新值和原因部分\n */\ninterface SetCommand {\n    fullMatch: string;\n    path: string;\n    oldValue: string;\n    newValue: string;\n    reason: string;\n}\n\n/**\n * 从输入文本中提取所有 _.set() 调用\n *\n * 问题背景：\n * 原本使用正则表达式 /_\\.set\\(([\\s\\S]*?)\\);/ 来匹配，但这种非贪婪匹配会在遇到\n * 嵌套的 ); 时提前结束。例如：\n * _.set('path', [\"text with _.set('inner',null);//comment\"], []);\n * 会在 \"comment\") 处错误地结束匹配\n *\n * 解决方案：\n * 使用状态机方法，通过计数括号配对来准确找到 _.set() 调用的结束位置\n */\nexport function extractSetCommands(inputText: string): SetCommand[] {\n    const results: SetCommand[] = [];\n    let i = 0;\n\n    while (i < inputText.length) {\n        // 步骤1: 查找 _.set( 的起始位置\n        const setStart = inputText.indexOf('_.set(', i);\n        if (setStart === -1) break;\n\n        // 步骤2: 定位开始括号\n        const openParen = setStart + 6; // '_.set(' 的长度\n\n        // 步骤3: 使用括号配对算法找到对应的闭括号\n        // 这个算法会正确处理引号内的括号，避免误匹配\n        const closeParen = findMatchingCloseParen(inputText, openParen);\n        if (closeParen === -1) {\n            // 如果找不到匹配的闭括号，跳过这个位置继续查找\n            i = openParen + 1;\n            continue;\n        }\n\n        // 步骤4: 检查闭括号后是否紧跟分号（_.set()调用的标准格式）\n        let endPos = closeParen + 1;\n        if (endPos < inputText.length && inputText[endPos] === ';') {\n            endPos++;\n\n            // 步骤5: 处理可能的注释部分\n            // 跳过分号后的空格\n            while (endPos < inputText.length && inputText[endPos] === ' ') {\n                endPos++;\n            }\n\n            // 检查是否有 // 注释\n            let comment = '';\n            if (\n                endPos + 1 < inputText.length &&\n                inputText[endPos] === '/' &&\n                inputText[endPos + 1] === '/'\n            ) {\n                // 找到注释的结束位置（换行符或文本结束）\n                const commentEnd = inputText.indexOf('\\n', endPos);\n                if (commentEnd !== -1) {\n                    comment = inputText.substring(endPos + 2, commentEnd).trim();\n                    endPos = commentEnd;\n                } else {\n                    // 注释延续到文本结尾\n                    comment = inputText.substring(endPos + 2).trim();\n                    endPos = inputText.length;\n                }\n            }\n\n            // 步骤6: 提取参数并解析\n            const paramsString = inputText.substring(openParen, closeParen);\n            const fullMatch = inputText.substring(setStart, endPos);\n\n            // 使用 parseParameters 解析参数，它能正确处理嵌套的数组、对象和引号\n            const params = parseParameters(paramsString);\n\n            // 步骤7: 根据参数数量构建结果\n            if (params.length >= 3) {\n                // 标准格式：_.set(path, oldValue, newValue)\n                results.push({\n                    fullMatch: fullMatch,\n                    path: trimQuotesAndBackslashes(params[0]),\n                    oldValue: trimQuotesAndBackslashes(params[1]),\n                    newValue: trimQuotesAndBackslashes(params[2]),\n                    reason: comment,\n                });\n            } else if (params.length === 2) {\n                // 简化格式：_.set(path, value)\n                // 在这种情况下，oldValue 和 newValue 都设为相同的值\n                results.push({\n                    fullMatch: fullMatch,\n                    path: trimQuotesAndBackslashes(params[0]),\n                    oldValue: trimQuotesAndBackslashes(params[1]),\n                    newValue: trimQuotesAndBackslashes(params[1]),\n                    reason: comment,\n                });\n            }\n\n            // 更新搜索位置，继续查找下一个 _.set() 调用\n            i = endPos;\n        } else {\n            // 如果没有分号，跳过这个位置\n            i = closeParen + 1;\n        }\n    }\n\n    return results;\n}\n\n/**\n * 辅助函数：找到匹配的闭括号\n *\n * 算法说明：\n * 1. 使用括号计数器，遇到 ( 加1，遇到 ) 减1\n * 2. 当计数器归零时，找到了匹配的闭括号\n * 3. 重要：忽略引号内的括号，避免字符串内容干扰匹配\n *\n * @param str 要搜索的字符串\n * @param startPos 开始括号的位置\n * @returns 匹配的闭括号位置，如果找不到返回 -1\n */\nfunction findMatchingCloseParen(str: string, startPos: number): number {\n    let parenCount = 1; // 从1开始，因为已经有一个开括号\n    let inQuote = false;\n    let quoteChar = '';\n\n    for (let i = startPos; i < str.length; i++) {\n        const char = str[i];\n        const prevChar = i > 0 ? str[i - 1] : '';\n\n        // 处理引号状态\n        // 支持三种引号：双引号、单引号和反引号（模板字符串）\n        // 注意：需要检查前一个字符不是反斜杠，以正确处理转义的引号\n        if ((char === '\"' || char === \"'\" || char === '`') && prevChar !== '\\\\') {\n            if (!inQuote) {\n                inQuote = true;\n                quoteChar = char;\n            } else if (char === quoteChar) {\n                inQuote = false;\n            }\n        }\n\n        // 只在不在引号内时计算括号\n        // 这确保了像 \"text with )\" 这样的字符串不会影响括号匹配\n        if (!inQuote) {\n            if (char === '(') {\n                parenCount++;\n            } else if (char === ')') {\n                parenCount--;\n                if (parenCount === 0) {\n                    return i;\n                }\n            }\n        }\n    }\n\n    return -1; // 没有找到匹配的闭括号\n}\n\n// 解析参数字符串，处理嵌套结构\nexport function parseParameters(paramsString: string): string[] {\n    const params: string[] = [];\n    let currentParam = '';\n    let inQuote = false;\n    let quoteChar = '';\n    let bracketCount = 0;\n    let braceCount = 0;\n\n    for (let i = 0; i < paramsString.length; i++) {\n        const char = paramsString[i];\n\n        // 处理引号（包括反引号）\n        if (\n            (char === '\"' || char === \"'\" || char === '`') &&\n            (i === 0 || paramsString[i - 1] !== '\\\\')\n        ) {\n            if (!inQuote) {\n                inQuote = true;\n                quoteChar = char;\n            } else if (char === quoteChar) {\n                inQuote = false;\n            }\n        }\n\n        // 处理方括号 (数组)\n        if (char === '[') bracketCount++;\n        if (char === ']') bracketCount--;\n\n        // 处理花括号 (对象)\n        if (char === '{') braceCount++;\n        if (char === '}') braceCount--;\n\n        // 处理参数分隔符\n        if (char === ',' && !inQuote && bracketCount === 0 && braceCount === 0) {\n            params.push(currentParam.trim());\n            currentParam = '';\n            continue;\n        }\n\n        currentParam += char;\n    }\n\n    // 添加最后一个参数\n    if (currentParam.trim()) {\n        params.push(currentParam.trim());\n    }\n\n    return params;\n}\n\nexport async function getLastValidVariable(message_id: number): Promise<Record<string, any>> {\n    return (\n        structuredClone(\n            SillyTavern.chat\n                .slice(0, message_id + 1)\n                .map(chat_message => _.get(chat_message, ['variables', chat_message.swipe_id ?? 0]))\n                .findLast(variables => _.has(variables, 'stat_data'))\n        ) ?? getVariables()\n    );\n}\n\nfunction pathFix(path: string): string {\n    const segments = [];\n    let currentSegment = '';\n    let inQuotes = false;\n    let quoteChar = '';\n\n    for (let i = 0; i < path.length; i++) {\n        const char = path[i];\n\n        // Handle quotes\n        if ((char === '\"' || char === \"'\") && (i === 0 || path[i - 1] !== '\\\\')) {\n            if (!inQuotes) {\n                inQuotes = true;\n                quoteChar = char;\n            } else if (char === quoteChar) {\n                inQuotes = false;\n            } else {\n                currentSegment += char;\n            }\n        } else if (char === '.' && !inQuotes) {\n            segments.push(currentSegment);\n            currentSegment = '';\n        } else {\n            currentSegment += char;\n        }\n    }\n\n    if (currentSegment) {\n        segments.push(currentSegment);\n    }\n\n    return segments.join('.');\n}\n\nexport async function updateVariables(\n    current_message_content: string,\n    variables: any\n): Promise<boolean> {\n    const out_is_modifed = false;\n    await eventEmit(variable_events.VARIABLE_UPDATE_STARTED, variables, out_is_modifed);\n    const out_status: Record<string, any> = _.cloneDeep(variables);\n    const delta_status: Record<string, any> = { stat_data: {} };\n    const matched_set = extractSetCommands(current_message_content);\n    let variable_modified = false;\n    for (const setCommand of matched_set) {\n        let { path, newValue, reason } = setCommand;\n        path = pathFix(path);\n\n        if (_.has(variables.stat_data, path)) {\n            const currentValue = _.get(variables.stat_data, path);\n            //有时候llm会返回整个数组，处理它\n            if (\n                _.isString(newValue) &&\n                newValue.trim().startsWith('[') &&\n                newValue.trim().endsWith(']')\n            ) {\n                try {\n                    const parsedArray = YAML.parse(newValue);\n                    if (Array.isArray(parsedArray) && parsedArray.length > 0) {\n                        newValue = parsedArray[0];\n                    }\n                } catch (error: any) {\n                    console.error(`Error parsing JSON array for '${path}': ${error.message}`);\n                }\n            }\n            // Check the type of the current value\n            if (typeof currentValue === 'number') {\n                // If the current value is a number, convert the new value to a number\n                const newValueNumber = Number(newValue);\n                const oldValue = currentValue;\n                _.set(variables.stat_data, path, newValueNumber);\n                const reason_str = reason ? `(${reason})` : '';\n                const display_str = `${oldValue}->${newValueNumber} ${reason_str}`;\n                _.set(out_status.stat_data, path, display_str);\n                _.set(delta_status.stat_data, path, display_str);\n                variable_modified = true;\n                console.info(`Set '${path}' to '${newValueNumber}' ${reason_str}`);\n                await eventEmit(\n                    variable_events.SINGLE_VARIABLE_UPDATED,\n                    variables.stat_data,\n                    path,\n                    oldValue,\n                    newValueNumber\n                );\n            } else if (Array.isArray(currentValue) && currentValue.length === 2) {\n                // If the current value is of type ValueWithDescription<T>\n                const newValueParsed =\n                    typeof currentValue[0] === 'number'\n                        ? Number(newValue)\n                        : trimQuotesAndBackslashes(newValue);\n                const oldValue = _.cloneDeep(currentValue[0]);\n                currentValue[0] = newValueParsed;\n                _.set(variables.stat_data, path, currentValue);\n                const reason_str = reason ? `(${reason})` : '';\n                const display_str = `${trimQuotesAndBackslashes(JSON.stringify(oldValue))}->${trimQuotesAndBackslashes(JSON.stringify(newValue))} ${reason_str}`;\n                _.set(out_status.stat_data, path, display_str);\n                _.set(delta_status.stat_data, path, display_str);\n                variable_modified = true;\n                console.info(`Set '${path}' to '${trimQuotesAndBackslashes(JSON.stringify(newValueParsed))}' ${reason_str}`);\n                // Call the onVariableUpdated function after updating the variable\n                await eventEmit(\n                    variable_events.SINGLE_VARIABLE_UPDATED,\n                    variables.stat_data,\n                    path,\n                    oldValue,\n                    newValueParsed\n                );\n            } else {\n                // Otherwise, set the new value directly\n                const trimmedNewValue = trimQuotesAndBackslashes(newValue);\n                const oldValue = _.cloneDeep(currentValue);\n                _.set(variables.stat_data, path, trimmedNewValue);\n                const reason_str = reason ? `(${reason})` : '';\n                const stringNewValue = trimQuotesAndBackslashes(JSON.stringify(trimmedNewValue));\n                const display_str = `${trimQuotesAndBackslashes(JSON.stringify(oldValue))}->${stringNewValue} ${reason_str}`;\n                _.set(out_status.stat_data, path, display_str);\n                _.set(delta_status.stat_data, path, display_str);\n                variable_modified = true;\n                console.info(`Set '${path}' to '${stringNewValue}' ${reason_str}`);\n                await eventEmit(\n                    variable_events.SINGLE_VARIABLE_UPDATED,\n                    variables.stat_data,\n                    path,\n                    oldValue,\n                    trimmedNewValue\n                );\n            }\n        } else {\n            const display_str = `undefined Path: ${path}->${newValue} (${reason})`;\n            console.error(display_str);\n        }\n    }\n\n    variables.display_data = out_status.stat_data;\n    variables.delta_data = delta_status.stat_data;\n    await eventEmit(variable_events.VARIABLE_UPDATE_ENDED, variables, out_is_modifed);\n    return variable_modified || out_is_modifed;\n}\n\nexport async function handleVariablesInMessage(message_id: number) {\n    const chat_message = getChatMessages(message_id).at(-1);\n    if (!chat_message) {\n        return;\n    }\n\n    const message_content = chat_message.message;\n    const variables = await getLastValidVariable(message_id);\n    if (!_.has(variables, 'stat_data')) {\n        console.error(`cannot found stat_data for ${message_id}`);\n        return;\n    }\n\n    const has_variable_modified = await updateVariables(message_content, variables);\n    if (has_variable_modified) {\n        await replaceVariables(variables, { type: 'chat' });\n    }\n    await replaceVariables(variables, { type: 'message', message_id: message_id });\n\n    if (chat_message.role !== 'user' && !message_content.includes('<StatusPlaceHolderImpl/>')) {\n        await setChatMessages(\n            [\n                {\n                    message_id: message_id,\n                    message: message_content + '\\n\\n<StatusPlaceHolderImpl/>',\n                },\n            ],\n            {\n                refresh: 'affected',\n            }\n        );\n    }\n}\n\n\nexport async function handleVariablesInCallback(message_content: string, variable_info : VariableData) {\n    if (variable_info.old_variables === undefined)\n    {\n        return;\n    }\n    variable_info.new_variables = _.cloneDeep(variable_info.old_variables);\n    const variables = variable_info.new_variables;\n\n    const modified = await updateVariables(message_content, variables);\n    //如果没有修改，则不产生 newVariable\n    if (!modified)\n        delete variable_info.new_variables;\n}\n","// 整体游戏数据类型\nimport { updateVariables } from '@/function';\nimport {GameData} from \"@/variable_def\";\n\ntype LorebookEntry = {\n    content: string;\n    comment?: string;\n};\n\nexport async function initCheck() {\n    //generation_started 的最新一条是正在生成的那条。\n    let last_chat_msg: ChatMessageSwiped[] = [];\n    try {\n        (await getChatMessages(-2, {\n            role: 'assistant',\n            include_swipes: true,\n        })) as ChatMessageSwiped[];\n    } catch (e) {\n        //在第一行时，必定发生异常。\n    }\n    if (!last_chat_msg) {\n        last_chat_msg = [];\n    }\n    if (last_chat_msg.length <= 0) {\n        const first_msg = await getChatMessages(0, {\n            include_swipes: true,\n        });\n        if (first_msg && first_msg.length > 0) {\n            last_chat_msg = first_msg;\n        } else {\n            console.error('不存在任何一条消息，退出');\n            return;\n        }\n    }\n    const last_msg = last_chat_msg[0];\n    //检查最近一条消息的当前swipe\n    let variables = last_msg.swipes_data[last_msg.swipe_id] as GameData & Record<string, any>;\n    const lorebook_settings = await getLorebookSettings();\n    const enabled_lorebook_list = lorebook_settings.selected_global_lorebooks;\n    const char_lorebook = await getCurrentCharPrimaryLorebook();\n    if (char_lorebook !== null) {\n        enabled_lorebook_list.push(char_lorebook);\n    }\n    if (variables === undefined) {\n        variables = { display_data: {}, initialized_lorebooks: [], stat_data: {}, delta_data: {} };\n    }\n    if (!_.has(variables, 'initialized_lorebooks')) {\n        variables.initialized_lorebooks = [];\n    }\n    if (!variables.stat_data) {\n        variables.stat_data = {};\n    }\n\n    let is_updated = false;\n    for (const current_lorebook of enabled_lorebook_list) {\n        if (variables.initialized_lorebooks.includes(current_lorebook)) continue;\n        variables.initialized_lorebooks.push(current_lorebook);\n        const init_entries = (await getLorebookEntries(current_lorebook)) as LorebookEntry[];\n\n        for (const entry of init_entries) {\n            if (entry.comment?.toLowerCase().includes('[initvar]')) {\n                try {\n                    const jsonData = YAML.parse(substitudeMacros(entry.content));\n                    variables.stat_data = _.merge(variables.stat_data, jsonData);\n                } catch (e) {\n                    console.error(`Failed to parse JSON from lorebook entry: ${e}`);\n                    // @ts-ignore\n                    toastr.error(e.message, 'Failed to parse JSON from lorebook entry', {\n                        timeOut: 5000,\n                    });\n                    return;\n                }\n            }\n        }\n        is_updated = true;\n    }\n    if (!is_updated) {\n        return;\n    }\n\n    console.info(`Init chat variables.`);\n    await insertOrAssignVariables(variables);\n\n    for (let i = 0; i < last_msg.swipes.length; i++) {\n        const current_swipe_data = _.cloneDeep(variables);\n        await updateVariables(substitudeMacros(last_msg.swipes[i]), current_swipe_data);\n        //新版本这个接口给deprecated了，但是新版本的接口不好用，先这样\n        //@ts-ignore\n        await setChatMessage({ data: current_swipe_data }, last_msg.message_id, {\n            refresh: 'none',\n            swipe_id: i,\n        });\n    }\n\n    const expected_settings = {\n        /*预期设置*/\n        context_percentage: 100,\n        recursive: true,\n    };\n    const settings = await getLorebookSettings();\n    if (_.isEqual(_.merge({}, settings, expected_settings), settings)) {\n        setLorebookSettings(expected_settings);\n    }\n}\n\n//window.initCheck = initCheck;\n","import { handleVariablesInMessage, handleVariablesInCallback} from '@/function';\nimport { initCheck } from '@/variable_init';\nimport {variable_events} from \"@/variable_def\";\n\n$(() => {\n    eventOn(tavern_events.GENERATION_STARTED, initCheck);\n    eventOn(tavern_events.MESSAGE_SENT, initCheck);\n    eventOn(tavern_events.MESSAGE_SENT, handleVariablesInMessage);\n    eventOn(tavern_events.MESSAGE_RECEIVED, handleVariablesInMessage);\n    eventOn(variable_events.INVOKE_MVU_PROCESS, handleVariablesInCallback);\n\n    // 导出到窗口，便于调试\n    _.set(window, 'handleVariablesInMessage', handleVariablesInMessage);\n});\n\n$(window).on('unload', () => {\n    eventRemoveListener(tavern_events.GENERATION_STARTED, initCheck);\n    eventRemoveListener(tavern_events.MESSAGE_SENT, initCheck);\n    eventRemoveListener(tavern_events.MESSAGE_SENT, handleVariablesInMessage);\n    eventRemoveListener(tavern_events.MESSAGE_RECEIVED, handleVariablesInMessage);\n    eventRemoveListener(variable_events.INVOKE_MVU_PROCESS, handleVariablesInCallback);\n});\n"],"names":["variable_events","trimQuotesAndBackslashes","str","_","isString","replace","findMatchingCloseParen","startPos","parenCount","inQuote","quoteChar","i","length","char","prevChar","parseParameters","paramsString","params","currentParam","bracketCount","braceCount","push","trim","pathFix","path","segments","currentSegment","inQuotes","join","async","updateVariables","current_message_content","variables","out_is_modifed","eventEmit","out_status","cloneDeep","delta_status","matched_set","inputText","results","setStart","indexOf","openParen","closeParen","endPos","comment","commentEnd","substring","fullMatch","oldValue","newValue","reason","extractSetCommands","variable_modified","setCommand","has","stat_data","currentValue","get","startsWith","endsWith","parsedArray","YAML","parse","Array","isArray","error","console","message","newValueNumber","Number","set","reason_str","display_str","info","newValueParsed","JSON","stringify","trimmedNewValue","stringNewValue","display_data","delta_data","handleVariablesInMessage","message_id","chat_message","getChatMessages","at","message_content","structuredClone","SillyTavern","chat","slice","map","swipe_id","findLast","getVariables","getLastValidVariable","replaceVariables","type","role","includes","setChatMessages","refresh","handleVariablesInCallback","variable_info","undefined","old_variables","new_variables","initCheck","last_chat_msg","include_swipes","e","first_msg","last_msg","swipes_data","enabled_lorebook_list","getLorebookSettings","selected_global_lorebooks","char_lorebook","getCurrentCharPrimaryLorebook","initialized_lorebooks","is_updated","current_lorebook","init_entries","getLorebookEntries","entry","toLowerCase","jsonData","substitudeMacros","content","merge","toastr","timeOut","insertOrAssignVariables","swipes","current_swipe_data","setChatMessage","data","expected_settings","context_percentage","recursive","settings","isEqual","setLorebookSettings","$","eventOn","tavern_events","GENERATION_STARTED","MESSAGE_SENT","MESSAGE_RECEIVED","window","on","eventRemoveListener"],"sourceRoot":""}