const e="mag_variable_updated",t="mag_variable_update_ended",a="mag_variable_update_started",s="mag_invoke_mvu";function n(e){return _.isString(e)?e.replace(/^[\\"'` ]*(.*?)[\\"'` ]*$/,"$1"):e}function i(e,t){let a=1,s=!1,n="";for(let i=t;i<e.length;i++){const t=e[i],o=i>0?e[i-1]:"";if('"'!==t&&"'"!==t&&"`"!==t||"\\"===o||(s?t===n&&(s=!1):(s=!0,n=t)),!s)if("("===t)a++;else if(")"===t&&(a--,0===a))return i}return-1}function o(e){const t=[];let a="",s=!1,n="",i=0,o=0;for(let r=0;r<e.length;r++){const l=e[r];'"'!==l&&"'"!==l&&"`"!==l||0!==r&&"\\"===e[r-1]||(s?l===n&&(s=!1):(s=!0,n=l)),"["===l&&i++,"]"===l&&i--,"{"===l&&o++,"}"===l&&o--,","!==l||s||0!==i||0!==o?a+=l:(t.push(a.trim()),a="")}return a.trim()&&t.push(a.trim()),t}function r(e){const t=[];let a="",s=!1,n="";for(let i=0;i<e.length;i++){const o=e[i];'"'!==o&&"'"!==o||0!==i&&"\\"===e[i-1]?"."!==o||s?a+=o:(t.push(a),a=""):s?o===n?s=!1:a+=o:(s=!0,n=o)}return a&&t.push(a),t.join(".")}async function l(s,l){const c=!1;await eventEmit(a,l,c);const d=_.cloneDeep(l),u={},g=function(e){const t=[];let a=0;for(;a<e.length;){const s=e.indexOf("_.set(",a);if(-1===s)break;const r=s+6,l=i(e,r);if(-1===l){a=r+1;continue}let c=l+1;if(c<e.length&&";"===e[c]){for(c++;c<e.length&&" "===e[c];)c++;let i="";if(c+1<e.length&&"/"===e[c]&&"/"===e[c+1]){const t=e.indexOf("\n",c);-1!==t?(i=e.substring(c+2,t).trim(),c=t):(i=e.substring(c+2).trim(),c=e.length)}const _=e.substring(r,l),d=e.substring(s,c),u=o(_);u.length>=3?t.push({fullMatch:d,path:n(u[0]),oldValue:n(u[1]),newValue:n(u[2]),reason:i}):2===u.length&&t.push({fullMatch:d,path:n(u[0]),oldValue:n(u[1]),newValue:n(u[1]),reason:i}),a=c}else a=l+1}return t}(s);let f=!1;for(const t of g){let{path:a,newValue:s,reason:i}=t;if(a=r(a),_.has(l.stat_data,a)){const t=_.get(l.stat_data,a);if(_.isString(s)&&s.trim().startsWith("[")&&s.trim().endsWith("]"))try{const e=YAML.parse(s);Array.isArray(e)&&e.length>0&&(s=e[0])}catch(e){console.error(`Error parsing JSON array for '${a}': ${e.message}`)}if("number"==typeof t){const n=Number(s),o=t;_.set(l.stat_data,a,n);const r=i?`(${i})`:"",c=`${o}->${n} ${r}`;_.set(d.stat_data,a,c),_.set(u,a,c),f=!0,console.info(`Set '${a}' to '${n}' ${r}`),await eventEmit(e,l.stat_data,a,o,n)}else if(Array.isArray(t)&&2===t.length){const o="number"==typeof t[0]?Number(s):n(s),r=_.cloneDeep(t[0]);t[0]=o,_.set(l.stat_data,a,t);const c=i?`(${i})`:"",g=`${n(JSON.stringify(r))}->${n(JSON.stringify(s))} ${c}`;_.set(d.stat_data,a,g),_.set(u,a,g),f=!0,console.info(`Set '${a}' to '${n(JSON.stringify(o))}' ${c}`),await eventEmit(e,l.stat_data,a,r,o)}else{const o=n(s),r=_.cloneDeep(t);_.set(l.stat_data,a,o);const c=i?`(${i})`:"",g=n(JSON.stringify(o)),v=`${n(JSON.stringify(r))}->${g} ${c}`;_.set(d.stat_data,a,v),_.set(u,a,v),f=!0,console.info(`Set '${a}' to '${g}' ${c}`),await eventEmit(e,l.stat_data,a,r,o)}}else{const e=`undefined Path: ${a}->${s} (${i})`;console.error(e)}}return l.display_data=d.stat_data,l.delta_data=u,await eventEmit(t,l,c),f||c}async function c(e){const t=getChatMessages(e).at(-1);if(!t)return;const a=t.message,s=await async function(e){return structuredClone(SillyTavern.chat.slice(0,e+1).map((e=>_.get(e,["variables",e.swipe_id??0]))).findLast((e=>_.has(e,"stat_data"))))??getVariables()}(e);if(!_.has(s,"stat_data"))return void console.error(`cannot found stat_data for ${e}`);await l(a,s)&&await replaceVariables(s,{type:"chat"}),await replaceVariables(s,{type:"message",message_id:e}),"user"===t.role||a.includes("<StatusPlaceHolderImpl/>")||await setChatMessages([{message_id:e,message:a+"\n\n<StatusPlaceHolderImpl/>"}],{refresh:"affected"})}async function d(e,t){if(void 0===t.old_variables)return;t.new_variables=_.cloneDeep(t.old_variables);const a=t.new_variables;await l(e,a)||delete t.new_variables}async function u(){let e=[];try{await getChatMessages(-2,{role:"assistant",include_swipes:!0})}catch(e){}if(e||(e=[]),e.length<=0){const t=await getChatMessages(0,{include_swipes:!0});if(!(t&&t.length>0))return void console.error("不存在任何一条消息，退出");e=t}const t=e[0];let a=t.swipes_data[t.swipe_id];const s=(await getLorebookSettings()).selected_global_lorebooks,n=await getCurrentCharPrimaryLorebook();null!==n&&s.push(n),void 0===a&&(a={display_data:{},initialized_lorebooks:[],stat_data:{},delta_data:{}}),_.has(a,"initialized_lorebooks")||(a.initialized_lorebooks=[]),a.stat_data||(a.stat_data={});let i=!1;for(const e of s){if(a.initialized_lorebooks.includes(e))continue;a.initialized_lorebooks.push(e);const t=await getLorebookEntries(e);for(const e of t)if(e.comment?.toLowerCase().includes("[initvar]"))try{const t=YAML.parse(substitudeMacros(e.content));a.stat_data=_.merge(a.stat_data,t)}catch(e){return console.error(`Failed to parse JSON from lorebook entry: ${e}`),void toastr.error(e.message,"Failed to parse JSON from lorebook entry",{timeOut:5e3})}i=!0}if(!i)return;console.info("Init chat variables."),await insertOrAssignVariables(a);for(let e=0;e<t.swipes.length;e++){const s=_.cloneDeep(a);await l(substitudeMacros(t.swipes[e]),s),await setChatMessage({data:s},t.message_id,{refresh:"none",swipe_id:e})}const o={context_percentage:100,recursive:!0},r=await getLorebookSettings();_.isEqual(_.merge({},r,o),r)&&setLorebookSettings(o)}$((()=>{eventOn(tavern_events.GENERATION_STARTED,u),eventOn(tavern_events.MESSAGE_SENT,u),eventOn(tavern_events.MESSAGE_SENT,c),eventOn(tavern_events.MESSAGE_RECEIVED,c),eventOn(s,d),_.set(window,"handleVariablesInMessage",c)})),$(window).on("unload",(()=>{eventRemoveListener(tavern_events.GENERATION_STARTED,u),eventRemoveListener(tavern_events.MESSAGE_SENT,u),eventRemoveListener(tavern_events.MESSAGE_SENT,c),eventRemoveListener(tavern_events.MESSAGE_RECEIVED,c),eventRemoveListener(s,d)})),eventOnButton("重新处理变量",(async function(){const e=getLastMessageId();e<1||0!==SillyTavern.chat.length&&(await deleteVariable("stat_data",{type:"message",message_id:e}),await c(getLastMessageId()))}));
//# sourceMappingURL=bundle.js.map