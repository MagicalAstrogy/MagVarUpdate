import*as t from'https://testingcf.jsdelivr.net/npm/json5/+esm';import*as e from'https://testingcf.jsdelivr.net/npm/toml/+esm';import*as a from'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';var s={d:(t,e)=>{for(var a in e)s.o(e,a)&&!s.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:e[a]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};const n={是否显示变量更新错误:'是'},r={type:'script',script_id:'function'==typeof getScriptId?getScriptId():'default-script-id'};function i(t){const e=['是否显示变量更新错误'];for(const a of e)if(a in t){const e=t[a];('string'!=typeof e||'是'!==e)&&(t[a]='否')}}async function o(){const t=getVariables(r)||{};if(!function(t){return!(!t||'object'!=typeof t)&&'是否显示变量更新错误'in t&&'string'==typeof t.是否显示变量更新错误}(t)){const e=_.merge({},n,t);return i(e),await replaceVariables(e,r),e}const e=_.merge({},n,t);return i(e),_.isEqual(t,e)||await replaceVariables(e,r),e}const c={SINGLE_VARIABLE_UPDATED:'mag_variable_updated',VARIABLE_UPDATE_ENDED:'mag_variable_update_ended',VARIABLE_UPDATE_STARTED:'mag_variable_update_started'},l='mag_invoke_mvu',d='mag_update_variable';function u(t){return _.isString(t)?t.replace(/^[\\"'` ]*(.*?)[\\"'` ]*$/,'$1'):t}function f(t,e){let a=1,s=!1,n='';for(let r=e;r<t.length;r++){const e=t[r],i=r>0?t[r-1]:'';if('"'!==e&&'\''!==e&&'`'!==e||'\\'===i||(s?e===n&&(s=!1):(s=!0,n=e)),!s)if('('===e)a++;else if(')'===e&&(a--,0===a))return r}return-1}function g(t){const e=[];let a='',s=!1,n='',r=0,i=0;for(let o=0;o<t.length;o++){const c=t[o];'"'!==c&&'\''!==c&&'`'!==c||0!==o&&'\\'===t[o-1]||(s?c===n&&(s=!1):(s=!0,n=c)),'['===c&&r++,']'===c&&r--,'{'===c&&i++,'}'===c&&i--,','!==c||s||0!==r||0!==i?a+=c:(e.push(a.trim()),a='')}return a.trim()&&e.push(a.trim()),e}async function p(t){return structuredClone(_(SillyTavern.chat).slice(0,t+1).map((t=>_.get(t,['variables',t.swipe_id??0]))).findLast((t=>_.has(t,'stat_data'))))??getVariables()}function h(t){const e=[];let a='',s=!1,n='';for(let r=0;r<t.length;r++){const i=t[r];'"'!==i&&'\''!==i||0!==r&&'\\'===t[r-1]?'.'!==i||s?a+=i:(e.push(a),a=''):s?i===n?s=!1:a+=i:(s=!0,n=i)}return a&&e.push(a),e.join('.')}async function y(t,e,a,s='',n=!1){const r=t.$internal?.display_data,i=t.$internal?.delta_data;if(_.has(t,e)){const o=_.get(t,e);if(Array.isArray(o)&&2===o.length){const l=_.cloneDeep(o[0]);o[0]=a,_.set(t,e,o);const d=s?`(${s})`:'',f=`${u(JSON.stringify(l))}->${u(JSON.stringify(a))} ${d}`;return r&&_.set(r,e,f),i&&_.set(i,e,f),console.info(`Set '${e}' to '${u(JSON.stringify(a))}' ${d}`),n&&await eventEmit(c.SINGLE_VARIABLE_UPDATED,t,e,l,a),!0}{const l=_.cloneDeep(o);_.set(t,e,a);const d=s?`(${s})`:'',f=u(JSON.stringify(a)),g=`${u(JSON.stringify(l))}->${f} ${d}`;return r&&_.set(r,e,g),i&&_.set(i,e,g),console.info(`Set '${e}' to '${f}' ${d}`),n&&await eventEmit(c.SINGLE_VARIABLE_UPDATED,t,e,l,a),!0}}return!1}async function m(t,e){const a=!1,s=_.cloneDeep(e),n={stat_data:{}},r=function(t){const e=[];let a=0;for(;a<t.length;){const s=t.indexOf('_.set(',a);if(-1===s)break;const n=s+6,r=f(t,n);if(-1===r){a=n+1;continue}let i=r+1;if(i<t.length&&';'===t[i]){for(i++;i<t.length&&' '===t[i];)i++;let o='';if(i+1<t.length&&'/'===t[i]&&'/'===t[i+1]){const e=t.indexOf('\n',i);-1!==e?(o=t.substring(i+2,e).trim(),i=e):(o=t.substring(i+2).trim(),i=t.length)}const c=t.substring(n,r),l=t.substring(s,i),d=g(c);d.length>=3?e.push({fullMatch:l,path:u(d[0]),oldValue:u(d[1]),newValue:u(d[2]),reason:o}):2===d.length&&e.push({fullMatch:l,path:u(d[0]),oldValue:u(d[1]),newValue:u(d[1]),reason:o}),a=i}else a=r+1}return e}(t),i=await o();e.stat_data.$internal={display_data:s.stat_data,delta_data:n.stat_data},await eventEmit(c.VARIABLE_UPDATE_STARTED,e,a);let l,d=!1,p=!1;for(const t of r){let{path:a,newValue:r,reason:i}=t;if(a=h(a),_.has(e.stat_data,a)){const t=_.get(e.stat_data,a);if(_.isString(r)&&r.trim().startsWith('[')&&r.trim().endsWith(']'))try{const t=YAML.parse(r);Array.isArray(t)&&t.length>0&&(r=t[0])}catch(t){console.error(`Error parsing JSON array for '${a}': ${t.message}`)}if('number'==typeof t){const o=Number(r),l=t;_.set(e.stat_data,a,o);const u=i?`(${i})`:'',f=`${l}->${o} ${u}`;_.set(s.stat_data,a,f),_.set(n.stat_data,a,f),d=!0,console.info(`Set '${a}' to '${o}' ${u}`),await eventEmit(c.SINGLE_VARIABLE_UPDATED,e.stat_data,a,l,o)}else if(Array.isArray(t)&&2===t.length){const o='number'==typeof t[0]?Number(r):u(r),l=_.cloneDeep(t[0]);t[0]=o,_.set(e.stat_data,a,t);const f=i?`(${i})`:'',g=`${u(JSON.stringify(l))}->${u(JSON.stringify(r))} ${f}`;_.set(s.stat_data,a,g),_.set(n.stat_data,a,g),d=!0,console.info(`Set '${a}' to '${u(JSON.stringify(o))}' ${f}`),await eventEmit(c.SINGLE_VARIABLE_UPDATED,e.stat_data,a,l,o)}else{const o=u(r),l=_.cloneDeep(t);_.set(e.stat_data,a,o);const f=i?`(${i})`:'',g=u(JSON.stringify(o)),p=`${u(JSON.stringify(l))}->${g} ${f}`;_.set(s.stat_data,a,p),_.set(n.stat_data,a,p),d=!0,console.info(`Set '${a}' to '${g}' ${f}`),await eventEmit(c.SINGLE_VARIABLE_UPDATED,e.stat_data,a,l,o)}}else{const t=`undefined Path: ${a}->${r} (${i})`;console.error(t),p=!0,l=t}}return p&&'是'===i.是否显示变量更新错误&&toastr.warning(`最近错误: ${l}`,'发生变量更新错误，可能需要重Roll',{timeOut:6e3}),e.display_data=s.stat_data,e.delta_data=n.stat_data,await eventEmit(c.VARIABLE_UPDATE_ENDED,e,a),delete e.stat_data.$internal,d||a}async function v(t){const e=getChatMessages(t).at(-1);if(!e)return;let a=e.message;if(a.length<5)return;const s=0===t?0:t-1,n=await p(s);if(!_.has(n,'stat_data'))return void console.error(`cannot found stat_data for ${s}`);const r=t=>(t.stat_data=n.stat_data,t.display_data=n.display_data,t.delta_data=n.delta_data,t.initialized_lorebooks=n.initialized_lorebooks,t);await m(a,n)&&await updateVariablesWith(r,{type:'chat'}),await updateVariablesWith(r,{type:'message',message_id:t}),'user'!==e.role&&(a.includes('<StatusPlaceHolderImpl/>')||(a+='\n\n<StatusPlaceHolderImpl/>'),await setChatMessages([{message_id:t,message:a}],{refresh:'affected'}))}async function b(t,e){if(void 0===e.old_variables)return;e.new_variables=_.cloneDeep(e.old_variables);const a=e.new_variables;await m(t,a)||delete e.new_variables}function w(t,e,a,s){_.forEach(e,((t,e)=>{const n=e;if(_.isArray(t)){if(2===t.length&&_.isString(t[1])){if(_.isArray(_.get(a,n))){const r=_.get(a,n);if(2===r.length)if(_.set(s,`${n}[1]`,t[1]),_.isObject(t[0])&&!_.isArray(t[0])){const a=_.get(s,`${e}[0]`);_.has(t[0],'description')&&_.isString(t[0].description)&&_.has(r[0],'description')&&_.set(s,`${n}[0].description`,t[0].description),w(`${n}[0]`,t[0],r[0],a)}else _.isArray(t[0])&&w(`${n}[0]`,t[0],r[0],s[0])}}else if(_.isArray(_.get(a,n))){const e=_.get(a,n);t.forEach(((a,r)=>{if(r<e.length&&_.isObject(a)){const i=_.get(s,`${n}[${r}]`);_.has(a,'description')&&_.isString(a.description)&&_.has(e[r],'description')&&_.set(i,'description',a.description),w(`${n}[${r}]`,t[r],e[r],i)}}))}}else if(_.isObject(t)){if(_.has(t,'description')&&_.isString(t.description)){const n=`${e}.description`;_.has(a,n)&&_.set(s,n,t.description)}_.has(a,e)&&_.isObject(a[e])&&w(n,t,a[e],s[e])}}))}const E=(t=>{var e={};return s.d(e,t),e})({default:()=>t.default});const S=(t=>{var e={};return s.d(e,t),e})({default:()=>e.default});async function A(t,e){const a=e||await async function(){const t=[...(await getLorebookSettings()).selected_global_lorebooks],e=await getCurrentCharPrimaryLorebook();return null!==e&&t.push(e),t}();let s=!1;for(const e of a){if(t.initialized_lorebooks.includes(e))continue;t.initialized_lorebooks.push(e);const a=await getLorebookEntries(e);for(const e of a)if(e.comment?.toLowerCase().includes('[initvar]')){const a=substitudeMacros(e.content);let s=null,n=null;try{s=YAML.parse(a)}catch(t){try{s=E.default.parse(a)}catch(t){try{s=S.default.parse(a)}catch(t){n=new Error(`Failed to parse content as YAML/JSON, JSON5, or TOML: ${t}`)}}}if(n)throw console.error(`Failed to parse lorebook entry: ${n}`),toastr.error(n.message,'Failed to parse lorebook entry',{timeOut:5e3}),n;s&&(t.stat_data=_.merge(t.stat_data,s))}s=!0}return s}async function V(){let t,e;try{const a=await async function(){let t=[];try{t=await getChatMessages(-2,{role:'assistant',include_swipes:!0})}catch(t){}if(!t||t.length<=0){const e=await getChatMessages(0,{include_swipes:!0});if(!(e&&e.length>0))throw new Error('不存在任何一条消息');t=e}const e=t[0];return{message:e,variables:e.swipes_data[e.swipe_id]}}();t=a.message,e=a.variables??{display_data:{},initialized_lorebooks:[],stat_data:{},delta_data:{}}}catch(t){return void console.error('不存在任何一条消息，退出')}void 0===e&&(e={display_data:{},initialized_lorebooks:[],stat_data:{},delta_data:{}}),_.has(e,'initialized_lorebooks')||(e.initialized_lorebooks=[]),e.stat_data||(e.stat_data={});await A(e)&&(console.info('Init chat variables.'),await updateVariablesWith((t=>_.assign(t,e))),await setChatMessages([{message_id:t.message_id,swipes_data:await Promise.all(t.swipes.map((async t=>{const a=_.cloneDeep(e);return await m(substitudeMacros(t),a),a})))}]),await async function(){const t={scan_depth:2,context_percentage:100,budget_cap:0,min_activations:0,max_depth:0,max_recursion_steps:0,insertion_strategy:'character_first',include_names:!1,recursive:!0,case_sensitive:!1,match_whole_words:!1,use_group_scoring:!1,overflow_alert:!1},e=getLorebookSettings();_.isEqual(_.merge({},e,t),e)||setLorebookSettings(t)}())}const O=['重新处理变量','重新读取初始变量','清除旧楼层变量'];function I(){!function(){const t=getScriptButtons(getScriptId()),e=t.map((t=>t.name));for(const a of O.filter((t=>!e.includes(t))))t.push({name:a,visible:!1});replaceScriptButtons(getScriptId(),t)}(),eventOnButton('重新处理变量',(async function(){const t=getLastMessageId();t<1||0!==SillyTavern.chat.length&&(await deleteVariable('stat_data',{type:'message',message_id:t}),await deleteVariable('delta_data',{type:'message',message_id:t}),await deleteVariable('display_data',{type:'message',message_id:t}),await v(getLastMessageId()))})),eventOnButton('重新读取初始变量',(async function(){const t={display_data:{},initialized_lorebooks:[],stat_data:{},delta_data:{}};try{if(!await A(t))return console.error('没有找到 InitVar 数据'),void toastr.error('没有找到 InitVar 数据','',{timeOut:3e3})}catch(t){return void console.error('加载 InitVar 数据失败:',t)}const e=getLastMessageId();if(e<0)return console.error('没有找到消息'),void toastr.error('没有找到消息','',{timeOut:3e3});const a=await p(e);if(!_.has(a,'stat_data'))return console.error('最新消息中没有找到 stat_data'),void toastr.error('最新消息中没有 stat_data','',{timeOut:3e3});const s=structuredClone(t);s.stat_data=_.merge(s.stat_data,a.stat_data),w(0,t.stat_data,a.stat_data,s.stat_data),await replaceVariables(s,{type:'message',message_id:e}),console.info('InitVar更新完成'),toastr.success('InitVar描述已更新','',{timeOut:3e3})})),eventOnButton('清除旧楼层变量',(async function(){const t=await SillyTavern.callGenericPopup('<h4>清除旧楼层变量信息以减小聊天文件大小避免手机崩溃</h4>请填写要保留变量信息的楼层数 (如 10 为保留最后 10 层)<br><strong>注意: 你将不能正常回退游玩到没保留变量信息的楼层</strong>',SillyTavern.POPUP_TYPE.INPUT,'10');if(!t)return;const e=parseInt(t);isNaN(e)?toastr.error(`请输入有效的楼层数, 你输入的是 '${t}'`,'清理旧楼层变量失败'):(SillyTavern.chat.slice(0,-e).forEach((t=>{void 0!==t.variables&&t.variables.forEach((t=>{_.unset(t,'stat_data'),_.unset(t,'display_data'),_.unset(t,'delta_data'),_.unset(t,'schema')}))})),SillyTavern.saveChat().then((()=>toastr.success(`已清理旧变量, 保留了最后 ${e} 层的变量`,'清理旧楼层变量成功'))))}))}function D(){return{events:c,parseMessage:async function(t,e){const a={old_variables:e};return await b(t,a),a.new_variables},getMvuData:function(t){return getVariables(t)},replaceMvuData:async function(t,e){await replaceVariables(t,e)},getCurrentMvuData:function(){return getVariables({type:'message',message_id:getCurrentMessageId()})},replaceCurrentMvuData:async function(t){await replaceVariables(t,{type:'message',message_id:getCurrentMessageId()})},reloadInitVar:async function(t){return await A(t)},setMvuVariable:async function(t,e,a,{reason:s='',is_recursive:n=!1}={}){return await y(t.stat_data,e,a,s,n)},getMvuVariable:function(t,e,{category:a='stat',default_value:s}={}){let n;switch(a){case'stat':n=t.stat_data;break;case'display':n=t.display_data;break;case'delta':n=t.delta_data}const r=_.get(n,e,s);return function(t){return Array.isArray(t)&&2===t.length&&'string'==typeof t[1]}(r)?r[0]:r},getRecordFromMvuData:function(t,e){return function(t,e){let a;switch(t){case'stat':a=e.stat_data;break;case'display':a=e.display_data;break;case'delta':a=e.delta_data}return a}(e,t)}}}const M=(t=>{var e={};return s.d(e,t),e})({compare:()=>a.compare});$((async()=>{I(),function(){const t=D();_.set(window,'Mvu',t),_.set(window.parent,'Mvu',t),eventEmit('global_Mvu_initialized')}(),eventOn(tavern_events.GENERATION_STARTED,V),eventOn(tavern_events.MESSAGE_SENT,V),eventOn(tavern_events.MESSAGE_SENT,v),eventOn(tavern_events.MESSAGE_RECEIVED,v),eventOn(l,b),eventOn(d,y),await o();try{_.set(parent.window,'handleVariablesInMessage',v)}catch(t){}try{const t=await getTavernHelperVersion();(0,M.compare)(t,'3.2.13','<')&&toastr.warning('酒馆助手版本过低, 可能无法正常处理, 请更新至 3.2.13 或更高版本（建议保持酒馆助手最新）')}catch(t){}}));
//# sourceMappingURL=bundle.js.map