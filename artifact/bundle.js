import*as t from'https://testingcf.jsdelivr.net/npm/json5/+esm';import*as e from'https://testingcf.jsdelivr.net/npm/toml/+esm';var a={};a.d=(t,e)=>{for(var s in e)a.o(e,s)&&!a.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},a.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);const s={SINGLE_VARIABLE_UPDATED:'mag_variable_updated',VARIABLE_UPDATE_ENDED:'mag_variable_update_ended',VARIABLE_UPDATE_STARTED:'mag_variable_update_started'},n='mag_invoke_mvu',i='mag_update_variable';function r(t){return _.isString(t)?t.replace(/^[\\"'` ]*(.*?)[\\"'` ]*$/,'$1'):t}function o(t,e){let a=1,s=!1,n='';for(let i=e;i<t.length;i++){const e=t[i],r=i>0?t[i-1]:'';if('"'!==e&&'\''!==e&&'`'!==e||'\\'===r||(s?e===n&&(s=!1):(s=!0,n=e)),!s)if('('===e)a++;else if(')'===e&&(a--,0===a))return i}return-1}function c(t){const e=[];let a='',s=!1,n='',i=0,r=0;for(let o=0;o<t.length;o++){const c=t[o];'"'!==c&&'\''!==c&&'`'!==c||0!==o&&'\\'===t[o-1]||(s?c===n&&(s=!1):(s=!0,n=c)),'['===c&&i++,']'===c&&i--,'{'===c&&r++,'}'===c&&r--,','!==c||s||0!==i||0!==r?a+=c:(e.push(a.trim()),a='')}return a.trim()&&e.push(a.trim()),e}async function l(t){return structuredClone(_(SillyTavern.chat).slice(0,t+1).map((t=>_.get(t,['variables',t.swipe_id??0]))).findLast((t=>_.has(t,'stat_data'))))??getVariables()}function d(t){const e=[];let a='',s=!1,n='';for(let i=0;i<t.length;i++){const r=t[i];'"'!==r&&'\''!==r||0!==i&&'\\'===t[i-1]?'.'!==r||s?a+=r:(e.push(a),a=''):s?r===n?s=!1:a+=r:(s=!0,n=r)}return a&&e.push(a),e.join('.')}async function u(t,e,a,n='',i=!1){const o=t.$internal?.display_data,c=t.$internal?.delta_data;if(_.has(t,e)){const l=_.get(t,e);if(Array.isArray(l)&&2===l.length){const d=_.cloneDeep(l[0]);l[0]=a,_.set(t,e,l);const u=n?`(${n})`:'',g=`${r(JSON.stringify(d))}->${r(JSON.stringify(a))} ${u}`;return o&&_.set(o,e,g),c&&_.set(c,e,g),console.info(`Set '${e}' to '${r(JSON.stringify(a))}' ${u}`),i&&await eventEmit(s.SINGLE_VARIABLE_UPDATED,t,e,d,a),!0}{const d=_.cloneDeep(l);_.set(t,e,a);const u=n?`(${n})`:'',g=r(JSON.stringify(a)),f=`${r(JSON.stringify(d))}->${g} ${u}`;return o&&_.set(o,e,f),c&&_.set(c,e,f),console.info(`Set '${e}' to '${g}' ${u}`),i&&await eventEmit(s.SINGLE_VARIABLE_UPDATED,t,e,d,a),!0}}return!1}async function g(t,e){const a=!1,n=_.cloneDeep(e),i={stat_data:{}},l=function(t){const e=[];let a=0;for(;a<t.length;){const s=t.indexOf('_.set(',a);if(-1===s)break;const n=s+6,i=o(t,n);if(-1===i){a=n+1;continue}let l=i+1;if(l<t.length&&';'===t[l]){for(l++;l<t.length&&' '===t[l];)l++;let o='';if(l+1<t.length&&'/'===t[l]&&'/'===t[l+1]){const e=t.indexOf('\n',l);-1!==e?(o=t.substring(l+2,e).trim(),l=e):(o=t.substring(l+2).trim(),l=t.length)}const d=t.substring(n,i),u=t.substring(s,l),g=c(d);g.length>=3?e.push({fullMatch:u,path:r(g[0]),oldValue:r(g[1]),newValue:r(g[2]),reason:o}):2===g.length&&e.push({fullMatch:u,path:r(g[0]),oldValue:r(g[1]),newValue:r(g[1]),reason:o}),a=l}else a=i+1}return e}(t);e.stat_data.$internal={display_data:n.stat_data,delta_data:i.stat_data},await eventEmit(s.VARIABLE_UPDATE_STARTED,e,a);let u=!1;for(const t of l){let{path:a,newValue:o,reason:c}=t;if(a=d(a),_.has(e.stat_data,a)){const t=_.get(e.stat_data,a);if(_.isString(o)&&o.trim().startsWith('[')&&o.trim().endsWith(']'))try{const t=YAML.parse(o);Array.isArray(t)&&t.length>0&&(o=t[0])}catch(t){console.error(`Error parsing JSON array for '${a}': ${t.message}`)}if('number'==typeof t){const r=Number(o),l=t;_.set(e.stat_data,a,r);const d=c?`(${c})`:'',g=`${l}->${r} ${d}`;_.set(n.stat_data,a,g),_.set(i.stat_data,a,g),u=!0,console.info(`Set '${a}' to '${r}' ${d}`),await eventEmit(s.SINGLE_VARIABLE_UPDATED,e.stat_data,a,l,r)}else if(Array.isArray(t)&&2===t.length){const l='number'==typeof t[0]?Number(o):r(o),d=_.cloneDeep(t[0]);t[0]=l,_.set(e.stat_data,a,t);const g=c?`(${c})`:'',f=`${r(JSON.stringify(d))}->${r(JSON.stringify(o))} ${g}`;_.set(n.stat_data,a,f),_.set(i.stat_data,a,f),u=!0,console.info(`Set '${a}' to '${r(JSON.stringify(l))}' ${g}`),await eventEmit(s.SINGLE_VARIABLE_UPDATED,e.stat_data,a,d,l)}else{const l=r(o),d=_.cloneDeep(t);_.set(e.stat_data,a,l);const g=c?`(${c})`:'',f=r(JSON.stringify(l)),p=`${r(JSON.stringify(d))}->${f} ${g}`;_.set(n.stat_data,a,p),_.set(i.stat_data,a,p),u=!0,console.info(`Set '${a}' to '${f}' ${g}`),await eventEmit(s.SINGLE_VARIABLE_UPDATED,e.stat_data,a,d,l)}}else{const t=`undefined Path: ${a}->${o} (${c})`;console.error(t)}}return e.display_data=n.stat_data,e.delta_data=i.stat_data,await eventEmit(s.VARIABLE_UPDATE_ENDED,e,a),delete e.stat_data.$internal,u||a}async function f(t){const e=getChatMessages(t).at(-1);if(!e)return;const a=e.message,s=await l(t);if(!_.has(s,'stat_data'))return void console.error(`cannot found stat_data for ${t}`);if(await g(a,s)){const t=getVariables({type:'chat'});t.stat_data=s.stat_data,t.display_data=s.display_data,t.delta_data=s.delta_data,t.initialized_lorebooks=s.initialized_lorebooks,await replaceVariables(t,{type:'chat'})}await insertOrAssignVariables({stat_data:s.stat_data,display_data:s.display_data,delta_data:s.delta_data,initialized_lorebooks:s.initialized_lorebooks},{type:'message',message_id:t}),'user'===e.role||a.includes('<StatusPlaceHolderImpl/>')||await setChatMessages([{message_id:t,message:a+'\n\n<StatusPlaceHolderImpl/>'}],{refresh:'affected'})}async function p(t,e){if(void 0===e.old_variables)return;e.new_variables=_.cloneDeep(e.old_variables);const a=e.new_variables;await g(t,a)||delete e.new_variables}function h(t,e,a,s){_.forEach(e,((t,e)=>{const n=e;if(_.isArray(t)){if(2===t.length&&_.isString(t[1])){if(_.isArray(_.get(a,n))){const i=_.get(a,n);if(2===i.length)if(_.set(s,`${n}[1]`,t[1]),_.isObject(t[0])&&!_.isArray(t[0])){const a=_.get(s,`${e}[0]`);_.has(t[0],'description')&&_.isString(t[0].description)&&_.has(i[0],'description')&&_.set(s,`${n}[0].description`,t[0].description),h(`${n}[0]`,t[0],i[0],a)}else _.isArray(t[0])&&h(`${n}[0]`,t[0],i[0],s[0])}}else if(_.isArray(_.get(a,n))){const e=_.get(a,n);t.forEach(((a,i)=>{if(i<e.length&&_.isObject(a)){const r=_.get(s,`${n}[${i}]`);_.has(a,'description')&&_.isString(a.description)&&_.has(e[i],'description')&&_.set(r,'description',a.description),h(`${n}[${i}]`,t[i],e[i],r)}}))}}else if(_.isObject(t)){if(_.has(t,'description')&&_.isString(t.description)){const n=`${e}.description`;_.has(a,n)&&_.set(s,n,t.description)}_.has(a,e)&&_.isObject(a[e])&&h(n,t,a[e],s[e])}}))}const y=(t=>{var e={};return a.d(e,t),e})({parse:()=>t.parse});const m=(t=>{var e={};return a.d(e,t),e})({parse:()=>e.parse});async function b(t,e){const a=e||await async function(){const t=[...(await getLorebookSettings()).selected_global_lorebooks],e=await getCurrentCharPrimaryLorebook();return null!==e&&t.push(e),t}();let s=!1;for(const e of a){if(t.initialized_lorebooks.includes(e))continue;t.initialized_lorebooks.push(e);const a=await getLorebookEntries(e);for(const e of a)if(e.comment?.toLowerCase().includes('[initvar]')){const a=substitudeMacros(e.content);let s=null,n=null;try{s=YAML.parse(a)}catch(t){try{s=y.parse(a)}catch(t){try{s=m.parse(a)}catch(t){n=new Error(`Failed to parse content as YAML/JSON, JSON5, or TOML: ${t}`)}}}if(n)throw console.error(`Failed to parse lorebook entry: ${n}`),toastr.error(n.message,'Failed to parse lorebook entry',{timeOut:5e3}),n;s&&(t.stat_data=_.merge(t.stat_data,s))}s=!0}return s}async function v(){let t,e;try{const a=await async function(){let t=[];try{t=await getChatMessages(-2,{role:'assistant',include_swipes:!0})}catch(t){}if(!t||t.length<=0){const e=await getChatMessages(0,{include_swipes:!0});if(!(e&&e.length>0))throw new Error('不存在任何一条消息');t=e}const e=t[0];return{message:e,variables:e.swipes_data[e.swipe_id]}}();t=a.message,e=a.variables??{display_data:{},initialized_lorebooks:[],stat_data:{},delta_data:{}}}catch(t){return void console.error('不存在任何一条消息，退出')}void 0===e&&(e={display_data:{},initialized_lorebooks:[],stat_data:{},delta_data:{}}),_.has(e,'initialized_lorebooks')||(e.initialized_lorebooks=[]),e.stat_data||(e.stat_data={});if(await b(e)){console.info('Init chat variables.'),await insertOrAssignVariables(e);for(let a=0;a<t.swipes.length;a++){const s=_.cloneDeep(e);await g(substitudeMacros(t.swipes[a]),s),await setChatMessage({data:s},t.message_id,{refresh:'none',swipe_id:a})}await async function(){const t={scan_depth:2,context_percentage:100,budget_cap:0,min_activations:0,max_depth:0,max_recursion_steps:0,insertion_strategy:'character_first',include_names:!1,recursive:!0,case_sensitive:!1,match_whole_words:!1,use_group_scoring:!1,overflow_alert:!1},e=getLorebookSettings();_.isEqual(_.merge({},e,t),e)||setLorebookSettings(t)}()}}const w=['重新处理变量','重新读取初始变量'];function E(){!function(){const t=getScriptButtons(getScriptId()),e=t.map((t=>t.name));for(const a of w.filter((t=>!e.includes(t))))t.push({name:a,visible:!1});replaceScriptButtons(getScriptId(),t)}(),eventOnButton('重新处理变量',(async function(){const t=getLastMessageId();t<1||0!==SillyTavern.chat.length&&(await deleteVariable('stat_data',{type:'message',message_id:t}),await deleteVariable('delta_data',{type:'message',message_id:t}),await deleteVariable('display_data',{type:'message',message_id:t}),await f(getLastMessageId()))})),eventOnButton('重新读取初始变量',(async function(){const t={display_data:{},initialized_lorebooks:[],stat_data:{},delta_data:{}};try{if(!await b(t))return console.error('没有找到 InitVar 数据'),void toastr.error('没有找到 InitVar 数据','',{timeOut:3e3})}catch(t){return void console.error('加载 InitVar 数据失败:',t)}const e=getLastMessageId();if(e<0)return console.error('没有找到消息'),void toastr.error('没有找到消息','',{timeOut:3e3});const a=await l(e);if(!_.has(a,'stat_data'))return console.error('最新消息中没有找到 stat_data'),void toastr.error('最新消息中没有 stat_data','',{timeOut:3e3});const s=structuredClone(t);s.stat_data=_.merge(s.stat_data,a.stat_data),h(0,t.stat_data,a.stat_data,s.stat_data),await replaceVariables(s,{type:'message',message_id:e}),console.info('InitVar更新完成'),toastr.success('InitVar描述已更新','',{timeOut:3e3})}))}function A(){return{events:s,parseMessage:async function(t,e){const a={old_variables:e};return await p(t,a),a.new_variables},getMvuData:function(t){return getVariables(t)},replaceMvuData:async function(t,e){await replaceVariables(t,e)},getCurrentMvuData:function(){return getVariables({type:'message',message_id:getCurrentMessageId()})},replaceCurrentMvuData:async function(t){await replaceVariables(t,{type:'message',message_id:getCurrentMessageId()})},reloadInitVar:async function(t){return await b(t)},setMvuVariable:async function(t,e,a,{reason:s='',is_recursive:n=!1}={}){return await u(t.stat_data,e,a,s,n)},getMvuVariable:function(t,e,{category:a='stat',default_value:s}={}){let n;switch(a){case'stat':n=t.stat_data;break;case'display':n=t.display_data;break;case'delta':n=t.delta_data}const i=_.get(n,e,s);return function(t){return Array.isArray(t)&&2===t.length&&'string'==typeof t[1]}(i)?i[0]:i},getRecordFromMvuData:function(t,e){return function(t,e){let a;switch(t){case'stat':a=e.stat_data;break;case'display':a=e.display_data;break;case'delta':a=e.delta_data}return a}(e,t)}}}$((()=>{E(),function(){const t=A();_.set(window,'Mvu',t),_.set(window.parent,'Mvu',t)}(),eventOn(tavern_events.GENERATION_STARTED,v),eventOn(tavern_events.MESSAGE_SENT,v),eventOn(tavern_events.MESSAGE_SENT,f),eventOn(tavern_events.MESSAGE_RECEIVED,f),eventOn(n,p),eventOn(i,u),_.set(window,'handleVariablesInMessage',f)}));
//# sourceMappingURL=bundle.js.map