import*as t from'https://testingcf.jsdelivr.net/npm/mathjs/+esm';import*as e from'https://testingcf.jsdelivr.net/npm/json5/+esm';import*as a from'https://testingcf.jsdelivr.net/npm/toml/+esm';import*as s from'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';var n={};function r(t){return'array'===t.type}function i(t){return'object'===t.type}n.d=(t,e)=>{for(var a in e)n.o(e,a)&&!n.o(t,a)&&Object.defineProperty(t,a,{enumerable:!0,get:e[a]})},n.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);const o={SINGLE_VARIABLE_UPDATED:'mag_variable_updated',VARIABLE_UPDATE_ENDED:'mag_variable_update_ended',VARIABLE_UPDATE_STARTED:'mag_variable_update_started'},c='mag_invoke_mvu',l='mag_update_variable';const d=t,p='$__META_EXTENSIBLE__$';function f(t,e,a=!1){if(Array.isArray(t)){let s,n,i=!1,o=a;e&&(r(e)?(i=!0===e.extensible,o=!0===e.recursiveExtensible||a,s=e.elementType,n=e.template):console.error(`Type mismatch: expected array schema but got ${e.type} at path`));const c=t.findIndex((t=>_.isObject(t)&&!_.isDate(t)&&'$arrayMeta'in t&&'$meta'in t&&!0===t.$arrayMeta));if(-1!==c){const e=t[c];void 0!==e.$meta.extensible&&(i=e.$meta.extensible),void 0!==e.$meta.template&&(n=e.$meta.template),t.splice(c,1),console.log('Array metadata element found and processed.')}const l=t.indexOf(p);l>-1&&(i=!0,t.splice(l,1),console.log('Extensible marker found and removed from an array.'));const d={type:'array',extensible:i||a,recursiveExtensible:o,elementType:t.length>0?f(t[0],s,o):{type:'any'}};return void 0!==n&&(d.template=n),d}if(_.isObject(t)&&!_.isDate(t)){const s=t;let n,r=!1,o=a;e&&(i(e)?(r=!0===e.extensible,o=!0===e.recursiveExtensible||a,n=e.properties):console.error(`Type mismatch: expected object schema but got ${e.type} at path`));const c={type:'object',properties:{},extensible:r||!0===s.$meta?.extensible||!0===s.$meta?.recursiveExtensible||a,recursiveExtensible:o||!0===s.$meta?.recursiveExtensible};void 0!==s.$meta?.template?c.template=s.$meta.template:e&&i(e)&&e.template&&(c.template=e.template);const l=s.$meta;s.$meta&&delete s.$meta;for(const e in t){const t=n?.[e],a=!1!==c.extensible&&c.recursiveExtensible,r=f(s[e],t,a);let i=!c.extensible;Array.isArray(l?.required)&&l.required.includes(e)&&(i=!0),!1===t?.required?i=!1:!0===t?.required&&(i=!0),c.properties[e]={...r,required:i}}return c}const s=typeof t;return'string'===s||'number'===s||'boolean'===s?{type:s}:{type:'any'}}function m(t,e){if(!e||!t)return t||null;const a=_.toPath(e);let s=t;for(const t of a){if(!s)return null;if(/^\d+$/.test(t)){if(!r(s))return null;s=s.elementType}else{if(!i(s)||!s.properties[t])return null;s=s.properties[t]}}return s}function u(t){console.log('Reconciling schema with current data state...');const e=f(_.cloneDeep(t.stat_data),t.schema);if(!i(e))return void console.error('Generated schema is not an object schema, which is unexpected for stat_data root');const a=e;void 0!==t.schema?.strictTemplate&&(a.strictTemplate=t.schema.strictTemplate),void 0!==t.schema?.concatTemplateArray&&(a.concatTemplateArray=t.schema.concatTemplateArray),_.has(t.stat_data,'$meta.strictTemplate')&&(a.strictTemplate=t.stat_data.$meta?.strictTemplate),_.has(t.stat_data,'$meta.concatTemplateArray')&&(a.concatTemplateArray=t.stat_data.$meta?.concatTemplateArray),t.schema=a,console.log('Schema reconciliation complete.')}function g(t){if(Array.isArray(t)){let e=t.length;for(;e--;)t[e]===p||_.isObject(t[e])&&!_.isDate(t[e])&&'$arrayMeta'in t[e]&&'$meta'in t[e]&&!0===t[e].$arrayMeta?t.splice(e,1):g(t[e])}else if(e=t,_.isObject(e)&&!_.isDate(e)){delete t.$meta;for(const e in t)g(t[e])}var e}const y={是否显示变量更新错误:'是'},h={type:'script',script_id:'function'==typeof getScriptId?getScriptId():'default-script-id'};function b(t){const e=['是否显示变量更新错误'];for(const a of e)if(a in t){const e=t[a];('string'!=typeof e||'是'!==e)&&(t[a]='否')}}async function A(){const t=getVariables(h)||{};if(!function(t){return!(!t||'object'!=typeof t)&&'是否显示变量更新错误'in t&&'string'==typeof t.是否显示变量更新错误}(t)){const e=_.merge({},y,t);return b(e),await replaceVariables(e,h),e}const e=_.merge({},y,t);return b(e),_.isEqual(t,e)||await replaceVariables(e,h),e}function v(t){return _.isString(t)?t.replace(/^[\\"'` ]*(.*?)[\\"'` ]*$/,'$1'):t}function E(t,e,a=!1,s=!0){if(!e)return t;const n=_.isObject(t)&&!Array.isArray(t)&&!_.isDate(t),r=Array.isArray(t),i=Array.isArray(e);return n&&!i?_.merge({},e,t):r&&i?s?_.concat(t,e):_.merge([],e,t):(n||r)&&i!==r||!n&&!r&&_.isObject(e)&&!Array.isArray(e)?(console.error(`Template type mismatch: template is ${i?'array':'object'}, but value is ${r?'array':'object'}. Skipping template merge.`),t):n||r||!i||a?t:s?_.concat([t],e):_.merge([],e,[t])}function S(t){if('string'!=typeof t)return t;const e=t.trim();if('true'===e)return!0;if('false'===e)return!1;if('null'===e)return null;if('undefined'!==e){try{return JSON.parse(e)}catch(t){if(e.startsWith('{')&&e.endsWith('}')||e.startsWith('[')&&e.endsWith(']'))try{const t=new Function(`return ${e};`)();if(_.isObject(t)||Array.isArray(t))return t}catch(t){}}try{const t={Math,math:d},a=d.evaluate(e,t);if(d.isComplex(a)||d.isMatrix(a))return a.toString();if(void 0===a&&!/^[a-zA-Z_]+$/.test(e))return e;if(void 0!==a)return parseFloat(a.toPrecision(12))}catch(t){}try{return YAML.parse(e)}catch(t){}return v(t)}}function w(t,e){let a=1,s=!1,n='';for(let r=e;r<t.length;r++){const e=t[r],i=r>0?t[r-1]:'';if('"'!==e&&'\''!==e&&'`'!==e||'\\'===i||(s?e===n&&(s=!1):(s=!0,n=e)),!s)if('('===e)a++;else if(')'===e&&(a--,0===a))return r}return-1}function O(t){const e=[];let a='',s=!1,n='',r=0,i=0,o=0;for(let c=0;c<t.length;c++){const l=t[c];'"'!==l&&'\''!==l&&'`'!==l||0!==c&&'\\'===t[c-1]||(s?l===n&&(s=!1):(s=!0,n=l)),s||('('===l&&o++,')'===l&&o--,'['===l&&r++,']'===l&&r--,'{'===l&&i++,'}'===l&&i--),','!==l||s||0!==o||0!==r||0!==i?a+=l:(e.push(a.trim()),a='')}return a.trim()&&e.push(a.trim()),e}async function D(t){return structuredClone(_(SillyTavern.chat).slice(0,t+1).map((t=>_.get(t,['variables',t.swipe_id??0]))).findLast((t=>_.has(t,'stat_data'))))??getVariables()}function I(t){const e=[];let a='',s=!1,n='';for(let r=0;r<t.length;r++){const i=t[r];'"'!==i&&'\''!==i||0!==r&&'\\'===t[r-1]?'.'!==i||s?a+=i:(e.push(a),a=''):s?i===n?s=!1:a+=i:(s=!0,n=i)}return a&&e.push(a),e.join('.')}async function T(t,e,a,s='',n=!1){const r=t.$internal?.display_data,i=t.$internal?.delta_data;if(_.has(t,e)){const c=_.get(t,e);if(Array.isArray(c)&&2===c.length){const l=_.cloneDeep(c[0]);c[0]=a,_.set(t,e,c);const d=s?`(${s})`:'',p=`${v(JSON.stringify(l))}->${v(JSON.stringify(a))} ${d}`;return r&&_.set(r,e,p),i&&_.set(i,e,p),console.info(`Set '${e}' to '${v(JSON.stringify(a))}' ${d}`),n&&await eventEmit(o.SINGLE_VARIABLE_UPDATED,t,e,l,a),!0}{const l=_.cloneDeep(c);_.set(t,e,a);const d=s?`(${s})`:'',p=v(JSON.stringify(a)),f=`${v(JSON.stringify(l))}->${p} ${d}`;return r&&_.set(r,e,f),i&&_.set(i,e,f),console.info(`Set '${e}' to '${p}' ${d}`),n&&await eventEmit(o.SINGLE_VARIABLE_UPDATED,t,e,l,a),!0}}return!1}async function N(t,e){const a=!1,s=_.cloneDeep(e),n={stat_data:{}},c=function(t){const e=[];let a=0;for(;a<t.length;){const s=t.substring(a).match(/_\.(set|insert|assign|remove|unset|delete|add)\(/);if(!s||void 0===s.index)break;const n=s[1],r=a+s.index,i=r+s[0].length,o=w(t,i);if(-1===o){a=i;continue}let c=o+1;if(c>=t.length||';'!==t[c]){a=o+1;continue}c++;let l='';const d=t.substring(c).match(/^\s*\/\/(.*)/);d&&(l=d[1].trim(),c+=d[0].length);const p=t.substring(r,c),f=O(t.substring(i,o));let m=!1;('set'===n&&f.length>=2||'assign'===n&&f.length>=2||'insert'===n&&f.length>=2||'remove'===n&&f.length>=1||'unset'===n&&f.length>=1||'delete'===n&&f.length>=1||'add'===n&&2===f.length)&&(m=!0),m&&e.push({command:n,fullMatch:p,args:f,reason:l}),a=c}return e}(substitudeMacros(t)),l=await A();e.stat_data.$internal={display_data:s.stat_data,delta_data:n.stat_data||{}},await eventEmit(o.VARIABLE_UPDATE_STARTED,e,a);let d,p,f=!1;const g=function(t){console.warn(t),d={error_last:t,error_command:p}},y=e.schema,h=y?.strictTemplate??!1,b=y?.concatTemplateArray??!0;for(const t of c){const a=I(v(t.args[0])),c=t.reason?`(${t.reason})`:'';let l='';switch(p=t,t.command){case'set':{if(!_.has(e.stat_data,a)){g(`Path '${a}' does not exist in stat_data, skipping set command ${c}`);continue}const s=_.get(e.stat_data,a);let n=S(t.args.length>=3?t.args[2]:t.args[1]);n instanceof Date&&(n=n.toISOString()),Array.isArray(s)&&2===s.length&&'string'==typeof s[1]&&!Array.isArray(s[0])?s[0]='number'==typeof s[0]&&null!==n?Number(n):n:'number'==typeof s&&null!==n?_.set(e.stat_data,a,Number(n)):_.set(e.stat_data,a,n);const r=_.get(e.stat_data,a);l=Array.isArray(s)&&2===s.length&&Array.isArray(r)?`${v(JSON.stringify(s[0]))}->${v(JSON.stringify(r[0]))} ${c}`:`${v(JSON.stringify(s))}->${v(JSON.stringify(r))} ${c}`,f=!0,console.info(`Set '${a}' to '${JSON.stringify(r)}' ${c}`),await eventEmit(o.SINGLE_VARIABLE_UPDATED,e.stat_data,a,s,r);break}case'insert':case'assign':{const s=a,n=''===s?e.stat_data:_.get(e.stat_data,s),d=m(y,s);if(null!==n&&!Array.isArray(n)&&!_.isObject(n)){g(`Cannot assign into path '${s}' because it holds a primitive value (${typeof n}). Operation skipped. ${c}`);continue}if(d){if('object'===d.type&&!1===d.extensible){if(2===t.args.length){g(`SCHEMA VIOLATION: Cannot merge data into non-extensible object at path '${s}'. ${c}`);continue}if(t.args.length>=3){const e=String(S(t.args[1]));if(!_.has(d.properties,e)){g(`SCHEMA VIOLATION: Cannot assign new key '${e}' into non-extensible object at path '${s}'. ${c}`);continue}}}else if('array'===d.type&&(!1===d.extensible||void 0===d.extensible)){g(`SCHEMA VIOLATION: Cannot assign elements into non-extensible array at path '${s}'. ${c}`);continue}}else if(''!==s&&!_.get(e.stat_data,_.toPath(s).slice(0,-1).join('.'))){g(`Cannot assign into non-existent path '${s}' without an extensible parent. ${c}`);continue}const p=_.cloneDeep(_.get(e.stat_data,a));let u=!1;if(2===t.args.length){let n=S(t.args[1]);n instanceof Date?n=n.toISOString():Array.isArray(n)&&(n=n.map((t=>t instanceof Date?t.toISOString():t)));let i=''===s?e.stat_data:_.get(e.stat_data,a);if(Array.isArray(i)||_.isObject(i)||(i=Array.isArray(n)?[]:{},_.set(e.stat_data,a,i)),Array.isArray(i)){n=E(n,d&&r(d)?d.template:void 0,h,b),i.push(n),l=`ASSIGNED ${JSON.stringify(n)} into array '${a}' ${c}`,u=!0}else if(_.isObject(i)){if(!_.isObject(n)||Array.isArray(n)){g(`Cannot merge ${Array.isArray(n)?'array':'non-object'} into object at '${a}'`);continue}_.merge(i,n),l=`MERGED object ${JSON.stringify(n)} into object '${a}' ${c}`,u=!0}}else if(t.args.length>=3){let n=S(t.args[2]);const o=S(t.args[1]);n instanceof Date?n=n.toISOString():Array.isArray(n)&&(n=n.map((t=>t instanceof Date?t.toISOString():t)));let p=''===s?e.stat_data:_.get(e.stat_data,a);const f=d&&(r(d)||i(d))?d.template:void 0;Array.isArray(p)&&'number'==typeof o?(n=E(n,f,h,b),p.splice(o,0,n),l=`ASSIGNED ${JSON.stringify(n)} into '${a}' at index ${o} ${c}`,u=!0):_.isObject(p)?(n=E(n,f,h,b),p[String(o)]=n,l=`ASSIGNED key '${o}' with value ${JSON.stringify(n)} into object '${a}' ${c}`,u=!0):(p={},_.set(e.stat_data,a,p),n=E(n,f,h,b),p[String(o)]=n,l=`CREATED object at '${a}' and ASSIGNED key '${o}' ${c}`,u=!0)}if(!u){g(`Invalid arguments for _.assign on path '${a}'`);continue}{const t=_.get(e.stat_data,a);f=!0,console.info(l),await eventEmit(o.SINGLE_VARIABLE_UPDATED,e.stat_data,a,p,t)}break}case'unset':case'delete':case'remove':{if(!_.has(e.stat_data,a)){g(`undefined Path: ${a} in _.remove command`);continue}let s,n=a;if(t.args.length>1)s=S(t.args[1]),'string'==typeof s&&(s=v(s));else{const t=_.toPath(a),e=t.pop();e&&(s=/^\d+$/.test(e)?Number(e):e,n=t.join('.'))}if(void 0===s){g(`Could not determine target for deletion for command on path '${a}' ${c}`);continue}if(''!==n&&!_.has(e.stat_data,n)){g(`Cannot remove from non-existent path '${n}'. ${c}`);continue}const r=m(y,n);if(r)if('array'===r.type){if(!0!==r.extensible){g(`SCHEMA VIOLATION: Cannot remove element from non-extensible array at path '${n}'. ${c}`);continue}}else if('object'===r.type){const t=String(s);if(_.has(r.properties,t)&&!0===r.properties[t].required){g(`SCHEMA VIOLATION: Cannot remove required key '${t}' from path '${n}'. ${c}`);continue}}const i=t.args.length>1?S(t.args[1]):void 0;let d=!1;if(void 0===i){const t=_.get(e.stat_data,a);_.unset(e.stat_data,a),l=`REMOVED path '${a}' ${c}`,d=!0,await eventEmit(o.SINGLE_VARIABLE_UPDATED,e.stat_data,a,t,void 0)}else{const t=_.get(e.stat_data,a);if(!Array.isArray(t)&&!_.isObject(t)){g(`Cannot remove from path '${a}' because it is not an array or object. Skipping command. ${c}`);continue}if(Array.isArray(t)){const s=_.cloneDeep(t);let n=-1;n='number'==typeof i?i:t.findIndex((t=>_.isEqual(t,i))),n>=0&&n<t.length&&(t.splice(n,1),d=!0,l=`REMOVED item from '${a}' ${c}`,await eventEmit(o.SINGLE_VARIABLE_UPDATED,e.stat_data,a,s,t))}else if(_.isObject(t))if('number'==typeof i){const e=Object.keys(t),s=i;if(s>=0&&s<e.length){const n=e[s];_.unset(t,n),d=!0,l=`REMOVED ${s+1}th entry ('${n}') from object '${a}' ${c}`}}else{const e=String(i);_.has(t,e)&&(delete t[e],d=!0,l=`REMOVED key '${e}' from object '${a}' ${c}`)}}if(!d){g(`Failed to execute remove on '${a}'`);continue}f=!0,console.info(l);break}case'add':{if(!_.has(e.stat_data,a)){g(`Path '${a}' does not exist in stat_data, skipping add command ${c}`);continue}const s=_.cloneDeep(_.get(e.stat_data,a)),n=_.get(e.stat_data,a);let r=n;const i=Array.isArray(n)&&2===n.length&&'object'!=typeof n[0];i&&(r=n[0]);let d=null;if(r instanceof Date)d=r;else if('string'==typeof r){const t=new Date(r);!isNaN(t.getTime())&&isNaN(Number(r))&&(d=t)}if(2!==t.args.length){g(`Invalid number of arguments for _.add on path '${a}' ${c}`);continue}{const p=S(t.args[1]);if(d){if('number'!=typeof p){g(`Delta '${t.args[1]}' for Date operation is not a number, skipping add command ${c}`);continue}const r=new Date(d.getTime()+p),m=r.toISOString();i?(n[0]=m,_.set(e.stat_data,a,n)):_.set(e.stat_data,a,m);const u=_.get(e.stat_data,a);l=i?`${JSON.stringify(s[0])}->${JSON.stringify(u[0])} ${c}`:`${JSON.stringify(s)}->${JSON.stringify(u)} ${c}`,f=!0,console.info(`ADDED date '${a}' from '${d.toISOString()}' to '${r.toISOString()}' by delta '${p}'ms ${c}`),await eventEmit(o.SINGLE_VARIABLE_UPDATED,e.stat_data,a,s,u)}else{if('number'!=typeof r){g(`Path '${a}' value is not a date or number; skipping add command ${c}`);continue}{if('number'!=typeof p){g(`Delta '${t.args[1]}' is not a number, skipping add command ${c}`);continue}let d=r+p;d=parseFloat(d.toPrecision(12)),i?(n[0]=d,_.set(e.stat_data,a,n)):_.set(e.stat_data,a,d);const m=_.get(e.stat_data,a);l=i?`${JSON.stringify(s[0])}->${JSON.stringify(m[0])} ${c}`:`${JSON.stringify(s)}->${JSON.stringify(m)} ${c}`,f=!0,console.info(`ADDED number '${a}' from '${r}' to '${d}' by delta '${p}' ${c}`),await eventEmit(o.SINGLE_VARIABLE_UPDATED,e.stat_data,a,s,m)}}}break}}l&&(_.set(s.stat_data,a,l),_.set(n.stat_data,a,l))}if(f&&u(e),d&&'是'===l.是否显示变量更新错误){const t=d.error_command.fullMatch;'undefined'!=typeof toastr&&toastr.warning(`最近错误: ${d.error_last}`,`发生变量更新错误，可能需要重Roll:${t}`,{timeOut:6e3})}return e.display_data=s.stat_data,e.delta_data=n.stat_data,await eventEmit(o.VARIABLE_UPDATE_ENDED,e,a),delete e.stat_data.$internal,f||a}let j=0;async function M(t){if(!('undefined'!=typeof jest||'undefined'!=typeof process&&!1)){const e=Date.now();if(e-j<3e3)return console.info(`Rate limit applied: handleVariablesInMessage skipped for message ${t}`),void toastr.warning('避免同时调用 MESSAGE_RECEIVED 多次','gemini轮询兼容',{timeOut:1e3});j=e}const e=getChatMessages(t).at(-1);if(!e)return;const a=e.message,s=await D(t);if(!_.has(s,'stat_data'))return void console.error(`cannot found stat_data for ${t}`);if(await N(a,s)){const t=getVariables({type:'chat'});t.stat_data=s.stat_data,t.display_data=s.display_data,t.delta_data=s.delta_data,t.schema=s.schema,t.initialized_lorebooks=s.initialized_lorebooks,await replaceVariables(t,{type:'chat'})}await insertOrAssignVariables({stat_data:s.stat_data,display_data:s.display_data,delta_data:s.delta_data,schema:s.schema,initialized_lorebooks:s.initialized_lorebooks},{type:'message',message_id:t}),'user'===e.role||a.includes('<StatusPlaceHolderImpl/>')||await setChatMessages([{message_id:t,message:a+'\n\n<StatusPlaceHolderImpl/>'}],{refresh:'affected'})}async function V(t,e){if(void 0===e.old_variables)return;e.new_variables=_.cloneDeep(e.old_variables);const a=e.new_variables;await N(t,a)||delete e.new_variables}function k(t,e,a,s){_.forEach(e,((t,e)=>{const n=e;if(_.isArray(t)){if(2===t.length&&_.isString(t[1])){if(_.isArray(_.get(a,n))){const r=_.get(a,n);if(2===r.length)if(_.set(s,`${n}[1]`,t[1]),_.isObject(t[0])&&!_.isArray(t[0])){const a=_.get(s,`${e}[0]`);_.has(t[0],'description')&&_.isString(t[0].description)&&_.has(r[0],'description')&&_.set(s,`${n}[0].description`,t[0].description),k(`${n}[0]`,t[0],r[0],a)}else _.isArray(t[0])&&k(`${n}[0]`,t[0],r[0],s[0])}}else if(_.isArray(_.get(a,n))){const e=_.get(a,n);t.forEach(((a,r)=>{if(r<e.length&&_.isObject(a)){const i=_.get(s,`${n}[${r}]`);_.has(a,'description')&&_.isString(a.description)&&_.has(e[r],'description')&&_.set(i,'description',a.description),k(`${n}[${r}]`,t[r],e[r],i)}}))}}else if(_.isObject(t)){if(_.has(t,'description')&&_.isString(t.description)){const n=`${e}.description`;_.has(a,n)&&_.set(s,n,t.description)}_.has(a,e)&&_.isObject(a[e])&&k(n,t,a[e],s[e])}}))}const x=(t=>{var e={};return n.d(e,t),e})({parse:()=>e.parse});const L=(t=>{var e={};return n.d(e,t),e})({parse:()=>a.parse});async function R(){let t,e;try{const a=await async function(){let t=[];try{t=await getChatMessages(-2,{role:'assistant',include_swipes:!0})}catch(t){}if(!t||t.length<=0){const e=await getChatMessages(0,{include_swipes:!0});if(!(e&&e.length>0))throw new Error('不存在任何一条消息');t=e}const e=t[0],a=e.swipes_data[e.swipe_id];return{message:e,variables:a}}();t=a.message,e=a.variables??{display_data:{},initialized_lorebooks:{},stat_data:{},delta_data:{},schema:{type:'object',properties:{}}}}catch(t){return void console.error('不存在任何一条消息，退出')}if(void 0===e&&(e={display_data:{},initialized_lorebooks:{},stat_data:{},delta_data:{},schema:{type:'object',properties:{}}}),_.has(e,'initialized_lorebooks')||(e.initialized_lorebooks={}),Array.isArray(e.initialized_lorebooks)){console.warn('Old "initialized_lorebooks" array format detected. Migrating to the new object format.');const t=e.initialized_lorebooks,a={};for(const e of t)a[e]=[];e.initialized_lorebooks=a}e.stat_data||(e.stat_data={}),e.schema||(e.schema={extensible:!1,properties:{},type:'object'});const a=await C(e);if(a){}if(a||!e.schema||_.isEmpty(e.schema)){const t=f(_.cloneDeep(e.stat_data));i(t)?(_.has(e.stat_data,'$meta.strictTemplate')&&(t.strictTemplate=e.stat_data.$meta?.strictTemplate),_.has(e.stat_data,'$meta.concatTemplateArray')&&(t.concatTemplateArray=e.stat_data.$meta?.concatTemplateArray),e.schema=t):console.error('Generated schema is not an object schema, which is unexpected for stat_data root'),g(e.stat_data)}if(a){console.info('Init chat variables.'),await insertOrAssignVariables(e);for(let a=0;a<t.swipes.length;a++){const s=_.cloneDeep(e);await N(t.swipes[a],s),await setChatMessage({data:s},t.message_id,{refresh:'none',swipe_id:a})}await async function(){const t={scan_depth:2,context_percentage:100,budget_cap:0,min_activations:0,max_depth:0,max_recursion_steps:0,insertion_strategy:'character_first',include_names:!1,recursive:!0,case_sensitive:!1,match_whole_words:!1,use_group_scoring:!1,overflow_alert:!1},e=getLorebookSettings();_.isEqual(_.merge({},e,t),e)||setLorebookSettings(t)}()}}async function C(t,e){const a=e||await async function(){const t=[...(await getLorebookSettings()).selected_global_lorebooks],e=await getCurrentCharPrimaryLorebook();return null!==e&&t.push(e),t}();let s=!1;t.initialized_lorebooks&&!Array.isArray(t.initialized_lorebooks)||(t.initialized_lorebooks={});for(const e of a){if(_.has(t.initialized_lorebooks,e))continue;t.initialized_lorebooks[e]=[];const a=await getLorebookEntries(e);for(const e of a)if(e.comment?.toLowerCase().includes('[initvar]')){const a=substitudeMacros(e.content);let s=null,n=null;try{s=YAML.parse(a)}catch(t){try{s=x.parse(a)}catch(t){try{s=L.parse(a)}catch(t){n=new Error(`Failed to parse content as YAML/JSON, JSON5, or TOML: ${t}`)}}}if(n)throw console.error(`Failed to parse lorebook entry[${e.comment}]: ${n}`),toastr.error(n.message,'Failed to parse lorebook entry',{timeOut:5e3}),n;s&&(t.stat_data=_.merge(t.stat_data,s))}s=!0}return s}const P=['重新处理变量','重新读取初始变量'];let G=0;function J(){!function(){const t=getScriptButtons(getScriptId()),e=t.map((t=>t.name));for(const a of P.filter((t=>!e.includes(t))))t.push({name:a,visible:!1});replaceScriptButtons(getScriptId(),t)}(),eventOnButton('重新处理变量',(async function(){if(!('undefined'!=typeof jest||'undefined'!=typeof process&&!1)){const t=Date.now();if(t-G<3e3)return console.info('Rate limit applied: 重新处理变量 button skipped'),void toastr.warning('避免重复点击','防止连点',{timeOut:1e3});G=t}const t=getLastMessageId();t<1||0!==SillyTavern.chat.length&&(await deleteVariable('stat_data',{type:'message',message_id:t}),await deleteVariable('delta_data',{type:'message',message_id:t}),await deleteVariable('display_data',{type:'message',message_id:t}),await deleteVariable('schema',{type:'message',message_id:t}),await M(getLastMessageId()))})),eventOnButton('重新读取初始变量',(async function(){const t={display_data:{},initialized_lorebooks:{},stat_data:{},delta_data:{},schema:{type:'object',properties:{}}};try{if(!await C(t))return console.error('没有找到 InitVar 数据'),void toastr.error('没有找到 InitVar 数据','',{timeOut:3e3})}catch(t){return void console.error('加载 InitVar 数据失败:',t)}const e=getLastMessageId();if(e<0)return console.error('没有找到消息'),void toastr.error('没有找到消息','',{timeOut:3e3});const a=await D(e);if(!_.has(a,'stat_data'))return console.error('最新消息中没有找到 stat_data'),void toastr.error('最新消息中没有 stat_data','',{timeOut:3e3});const s=structuredClone(t);s.stat_data=_.merge(s.stat_data,a.stat_data),k(0,t.stat_data,a.stat_data,s.stat_data),await u(s),g(s.stat_data),await replaceVariables(s,{type:'message',message_id:e}),await replaceVariables(s,{type:'chat'}),console.info('InitVar更新完成'),toastr.success('InitVar描述已更新','',{timeOut:3e3})}))}function B(){return{events:o,parseMessage:async function(t,e){const a={old_variables:e};return await V(t,a),a.new_variables},getMvuData:function(t){return getVariables(t)},replaceMvuData:async function(t,e){await replaceVariables(t,e)},getCurrentMvuData:function(){return getVariables({type:'message',message_id:getCurrentMessageId()})},replaceCurrentMvuData:async function(t){await replaceVariables(t,{type:'message',message_id:getCurrentMessageId()})},reloadInitVar:async function(t){return await C(t)},setMvuVariable:async function(t,e,a,{reason:s='',is_recursive:n=!1}={}){return await T(t.stat_data,e,a,s,n)},getMvuVariable:function(t,e,{category:a='stat',default_value:s}={}){let n;switch(a){case'stat':n=t.stat_data;break;case'display':n=t.display_data;break;case'delta':n=t.delta_data}const r=_.get(n,e,s);return function(t){return Array.isArray(t)&&2===t.length&&'string'==typeof t[1]}(r)?r[0]:r},getRecordFromMvuData:function(t,e){return function(t,e){let a;switch(t){case'stat':a=e.stat_data;break;case'display':a=e.display_data;break;case'delta':a=e.delta_data}return a}(e,t)}}}const U=(t=>{var e={};return n.d(e,t),e})({compare:()=>s.compare});$((async()=>{J(),function(){const t=B();_.set(window,'Mvu',t),_.set(window.parent,'Mvu',t)}(),eventOn(tavern_events.GENERATION_STARTED,R),eventOn(tavern_events.MESSAGE_SENT,R),eventOn(tavern_events.MESSAGE_SENT,M),eventOn(tavern_events.MESSAGE_RECEIVED,M),eventOn(c,V),eventOn(l,T),await A();try{_.set(parent.window,'handleVariablesInMessage',M)}catch(t){}try{const t=await getTavernHelperVersion();(0,U.compare)(t,'3.2.13','<')&&toastr.warning('酒馆助手版本过低, 可能无法正常处理, 请更新至 3.2.13 或更高版本（建议保持酒馆助手最新）')}catch(t){}})),$(window).on('unload',(()=>{eventRemoveListener(tavern_events.GENERATION_STARTED,R),eventRemoveListener(tavern_events.MESSAGE_SENT,R),eventRemoveListener(tavern_events.MESSAGE_SENT,M),eventRemoveListener(tavern_events.MESSAGE_RECEIVED,M),eventRemoveListener(c,V)}));
//# sourceMappingURL=bundle.js.map