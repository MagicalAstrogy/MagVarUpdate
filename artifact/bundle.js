import{klona as e}from'https://testingcf.jsdelivr.net/npm/klona/+esm';import{default as t}from'https://testingcf.jsdelivr.net/npm/json5/+esm';import{default as a}from'https://testingcf.jsdelivr.net/npm/toml/+esm';import{createPinia as n,defineStore as s}from'https://testingcf.jsdelivr.net/npm/pinia/+esm';import*as i from'https://testingcf.jsdelivr.net/npm/mathjs/+esm';import{compare as o}from'https://testingcf.jsdelivr.net/npm/compare-versions/+esm';var r={262:(e,t)=>{t.A=(e,t)=>{const a=e.__vccOpts||e;for(const[e,n]of t)a[e]=n;return a}},314:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map(function(t){var a='',n=void 0!==t[5];return t[4]&&(a+='@supports ('.concat(t[4],') {')),t[2]&&(a+='@media '.concat(t[2],' {')),n&&(a+='@layer'.concat(t[5].length>0?' '.concat(t[5]):'',' {')),a+=e(t),n&&(a+='}'),t[2]&&(a+='}'),t[4]&&(a+='}'),a}).join('')},t.i=function(e,a,n,s,i){'string'==typeof e&&(e=[[null,e,void 0]]);var o={};if(n)for(var r=0;r<this.length;r++){var l=this[r][0];null!=l&&(o[l]=!0)}for(var c=0;c<e.length;c++){var d=[].concat(e[c]);n&&o[d[0]]||(void 0!==i&&(void 0===d[5]||(d[1]='@layer'.concat(d[5].length>0?' '.concat(d[5]):'',' {').concat(d[1],'}')),d[5]=i),a&&(d[2]?(d[1]='@media '.concat(d[2],' {').concat(d[1],'}'),d[2]=a):d[2]=a),s&&(d[4]?(d[1]='@supports ('.concat(d[4],') {').concat(d[1],'}'),d[4]=s):d[4]=''.concat(s)),t.push(d))}},t}},354:e=>{e.exports=function(e){var t=e[1],a=e[3];if(!a)return t;if('function'==typeof btoa){var n=btoa(unescape(encodeURIComponent(JSON.stringify(a)))),s='sourceMappingURL=data:application/json;charset=utf-8;base64,'.concat(n),i='/*# '.concat(s,' */');return[t].concat([i]).join('\n')}return[t].join('\n')}},534:(e,t,a)=>{function n(e,t){for(var a=[],n={},s=0;s<t.length;s++){var i=t[s],o=i[0],r={id:e+':'+s,css:i[1],media:i[2],sourceMap:i[3]};n[o]?n[o].parts.push(r):a.push(n[o]={id:o,parts:[r]})}return a}a.d(t,{A:()=>f});var s='undefined'!=typeof document;if('undefined'!=typeof DEBUG&&DEBUG&&!s)throw new Error('vue-style-loader cannot be used in a non-browser environment. Use { target: \'node\' } in your Webpack config to indicate a server-rendering environment.');var i={},o=s&&(document.head||document.getElementsByTagName('head')[0]),r=null,l=0,c=!1,d=function(){},u=null,p='data-vue-ssr-id',m='undefined'!=typeof navigator&&/msie [6-9]\b/.test(navigator.userAgent.toLowerCase());function f(e,t,a,s){c=a,u=s||{};var o=n(e,t);return v(o),function(t){for(var a=[],s=0;s<o.length;s++){var r=o[s];(l=i[r.id]).refs--,a.push(l)}t?v(o=n(e,t)):o=[];for(s=0;s<a.length;s++){var l;if(0===(l=a[s]).refs){for(var c=0;c<l.parts.length;c++)l.parts[c]();delete i[l.id]}}}}function v(e){for(var t=0;t<e.length;t++){var a=e[t],n=i[a.id];if(n){n.refs++;for(var s=0;s<n.parts.length;s++)n.parts[s](a.parts[s]);for(;s<a.parts.length;s++)n.parts.push(h(a.parts[s]));n.parts.length>a.parts.length&&(n.parts.length=a.parts.length)}else{var o=[];for(s=0;s<a.parts.length;s++)o.push(h(a.parts[s]));i[a.id]={id:a.id,refs:1,parts:o}}}}function g(){var e=document.createElement('style');return e.type='text/css',o.appendChild(e),e}function h(e){var t,a,n=document.querySelector('style['+p+'~="'+e.id+'"]');if(n){if(c)return d;n.parentNode.removeChild(n)}if(m){var s=l++;n=r||(r=g()),t=E.bind(null,n,s,!1),a=E.bind(null,n,s,!0)}else n=g(),t=x.bind(null,n),a=function(){n.parentNode.removeChild(n)};return t(e),function(n){if(n){if(n.css===e.css&&n.media===e.media&&n.sourceMap===e.sourceMap)return;t(e=n)}else a()}}var b,y=(b=[],function(e,t){return b[e]=t,b.filter(Boolean).join('\n')});function E(e,t,a,n){var s=a?'':n.css;if(e.styleSheet)e.styleSheet.cssText=y(t,s);else{var i=document.createTextNode(s),o=e.childNodes;o[t]&&e.removeChild(o[t]),o.length?e.insertBefore(i,o[t]):e.appendChild(i)}}function x(e,t){var a=t.css,n=t.media,s=t.sourceMap;if(n&&e.setAttribute('media',n),u.ssrId&&e.setAttribute(p,t.id),s&&(a+='\n/*# sourceURL='+s.sources[0]+' */',a+='\n/*# sourceMappingURL=data:application/json;base64,'+btoa(unescape(encodeURIComponent(JSON.stringify(s))))+' */'),e.styleSheet)e.styleSheet.cssText=a;else{for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(document.createTextNode(a))}}},859:(e,t,a)=>{a.r(t),a.d(t,{default:()=>r});var n=a(354),s=a.n(n),i=a(314),o=a.n(i)()(s());o.push([e.id,'.collapse-container[data-v-5fd73bac]{border:1px solid #ccc;border-radius:4px;padding:2px;background:transparent}.collapse-enter-from[data-v-5fd73bac],.collapse-leave-to[data-v-5fd73bac]{max-height:0;opacity:0;overflow:hidden}.collapse-enter-to[data-v-5fd73bac],.collapse-leave-from[data-v-5fd73bac]{max-height:240px;opacity:1}.collapse-enter-active[data-v-5fd73bac],.collapse-leave-active[data-v-5fd73bac]{transition:all 0.3s ease}.collapse-content[data-v-5fd73bac]{margin-top:2px;padding:2px;background-color:transparent;border-radius:4px}\n','',{version:3,sources:['webpack://./src/Panel.vue'],names:[],mappings:'AA2YA,qCACI,qBAAsB,CACtB,iBAAkB,CAClB,WAAY,CACZ,sBACJ,CAGA,0EAEI,YAAa,CACb,SAAU,CACV,eACJ,CAEA,0EAEI,gBAAiB,CACjB,SACJ,CAEA,gFAEI,wBACJ,CAEA,mCACI,cAAe,CACf,WAAY,CACZ,4BAA6B,CAC7B,iBACJ',sourcesContent:['<template>\n    <div class="inline-drawer">\n        <div class="inline-drawer-toggle inline-drawer-header">\n            <b>MVU 变量框架</b>\n            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>\n        </div>\n\n        <div class="inline-drawer-content">\n            <div class="flex-container flexFlowColumn">\n                <div><strong>通知设置</strong></div>\n                <label class="checkbox_label" for="mvu_notification_error">\n                    <input\n                        id="mvu_notification_error"\n                        v-model="store.settings.通知.变量更新出错"\n                        type="checkbox"\n                    />\n                    <span>变量更新出错时通知</span>\n                </label>\n                <label class="checkbox_label" for="mvu_notification_extra_model_parsing">\n                    <input\n                        id="mvu_notification_extra_model_parsing"\n                        v-model="store.settings.通知.额外模型解析中"\n                        type="checkbox"\n                    />\n                    <span>额外模型解析中通知</span>\n                </label>\n            </div>\n\n            <hr />\n\n            <div class="flex-container flexFlowColumn">\n                <div>\n                    <strong>变量更新方式</strong>\n                    <i\n                        class="fa-solid fa-circle-question fa-sm note-link-span"\n                        style="cursor: pointer"\n                        @click="showMethodHelp"\n                    />\n                </div>\n                <select id="mvu_update_method" v-model="store.settings.更新方式" class="text_pole">\n                    <option value="随AI输出">随AI输出</option>\n                    <option value="额外模型解析">额外模型解析</option>\n                </select>\n\n                <template v-if="store.settings.更新方式 === \'额外模型解析\'">\n                    <label>\n                        解析方式\n                        <i\n                            class="fa-solid fa-circle-question fa-sm note-link-span"\n                            style="cursor: pointer"\n                            @click="showExtraModeHelp"\n                        />\n                    </label>\n                    <label class="checkbox_label" for="mvu_extra_model_send_preset">\n                        <input\n                            id="mvu_extra_model_send_preset"\n                            v-model="store.settings.额外模型解析配置.发送预设"\n                            type="checkbox"\n                        />\n                        <span>发送预设</span>\n                    </label>\n                    <label class="checkbox_label" for="mvu_extra_model_use_function_calling">\n                        <input\n                            id="mvu_extra_model_use_function_calling"\n                            v-model="store.settings.额外模型解析配置.使用函数调用"\n                            type="checkbox"\n                        />\n                        <span>使用函数调用</span>\n                    </label>\n\n                    <label for="mvu_extra_model_source">模型来源</label>\n                    <select\n                        id="mvu_extra_model_source"\n                        v-model="store.settings.额外模型解析配置.模型来源"\n                        class="text_pole"\n                    >\n                        <option value="与插头相同">与插头相同</option>\n                        <option value="自定义">自定义</option>\n                    </select>\n\n                    <template v-if="store.settings.额外模型解析配置.模型来源 === \'自定义\'">\n                        <div class="flex-container flexFlowColumn">\n                            <label for="mvu_api_url">API 地址</label>\n                            <input\n                                id="mvu_api_url"\n                                v-model="store.settings.额外模型解析配置.api地址"\n                                type="text"\n                                class="text_pole"\n                                placeholder="http://localhost:1234/v1"\n                            />\n                        </div>\n\n                        <div class="flex-container flexFlowColumn">\n                            <label for="mvu_api_key">API 密钥</label>\n                            <input\n                                id="mvu_api_key"\n                                v-model="store.settings.额外模型解析配置.密钥"\n                                type="password"\n                                class="text_pole"\n                                placeholder="留空表示无需密钥"\n                            />\n                        </div>\n\n                        <div class="flex-container flexFlowColumn">\n                            <label for="mvu_model_name">模型名称</label>\n                            <input\n                                id="mvu_model_name"\n                                v-model="store.settings.额外模型解析配置.模型名称"\n                                type="text"\n                                class="text_pole"\n                                placeholder="gemini-2.5-flash"\n                            />\n                        </div>\n\n                        <div v-if="!additional_extra_configuration_supported">\n                            <hr />\n                            ⚠️酒馆助手版本过低, 不支持以下配置⚠️\n                        </div>\n\n                        <div class="flex-container flexFlowColumn">\n                            <label for="mvu_max_tokens">最大回复token数</label>\n                            <input\n                                id="mvu_max_tokens"\n                                v-model="store.settings.额外模型解析配置.最大回复token数"\n                                :disabled="!additional_extra_configuration_supported"\n                                type="number"\n                                class="text_pole"\n                                min="0"\n                                step="128"\n                                placeholder="1000"\n                            />\n                        </div>\n\n                        <div class="flex-container flexFlowColumn">\n                            <label for="mvu_temperature">温度</label>\n                            <input\n                                id="mvu_temperature"\n                                v-model="store.settings.额外模型解析配置.温度"\n                                :disabled="!additional_extra_configuration_supported"\n                                type="number"\n                                class="text_pole"\n                                min="0"\n                                max="2"\n                                step="0.01"\n                                placeholder="1.0"\n                            />\n                        </div>\n\n                        <div class="flex-container flexFlowColumn">\n                            <label for="mvu_frequency_penalty">频率惩罚</label>\n                            <input\n                                id="mvu_frequency_penalty"\n                                v-model="store.settings.额外模型解析配置.频率惩罚"\n                                :disabled="!additional_extra_configuration_supported"\n                                type="number"\n                                class="text_pole"\n                                min="-2"\n                                max="2"\n                                step="0.01"\n                                placeholder="0.0"\n                            />\n                        </div>\n\n                        <div class="flex-container flexFlowColumn">\n                            <label for="mvu_presence_penalty">存在惩罚</label>\n                            <input\n                                id="mvu_presence_penalty"\n                                v-model="store.settings.额外模型解析配置.存在惩罚"\n                                :disabled="!additional_extra_configuration_supported"\n                                type="number"\n                                class="text_pole"\n                                min="-2"\n                                max="2"\n                                step="0.01"\n                                placeholder="0.0"\n                            />\n                        </div>\n\n                        <div class="flex-container flexFlowColumn">\n                            <label for="mvu_presence_penalty">Top P</label>\n                            <input\n                                id="mvu_presence_penalty"\n                                v-model="store.settings.额外模型解析配置.top_p"\n                                :disabled="!additional_extra_configuration_supported"\n                                type="number"\n                                class="text_pole"\n                                min="0"\n                                max="1"\n                                step="0.01"\n                                placeholder="1.0"\n                            />\n                        </div>\n                    </template>\n                </template>\n            </div>\n\n            <hr />\n\n            <div class="flex-container flexFlowColumn">\n                <div>\n                    <strong>杂项配置</strong>\n                </div>\n                <div class="collapse-container">\n                    <button\n                        style="background: transparent"\n                        @click="cleanup_is_open = !cleanup_is_open"\n                    >\n                        {{ cleanup_is_open ? \'收起-变量清理配置\' : \'展开-变量清理配置\' }}\n                    </button>\n\n                    <Transition name="collapse">\n                        <div v-show="cleanup_is_open" class="collapse-content">\n                            <div class="flex-container flexFlowColumn">\n                                <label for="mvu_snapshot_interval">快照保留间隔</label>\n                                <input\n                                    id="mvu_snapshot_interval"\n                                    v-model.number="store.settings.快照保留间隔"\n                                    type="number"\n                                    min="1"\n                                    step="1"\n                                    class="text_pole"\n                                    placeholder="50"\n                                />\n                            </div>\n\n                            <div class="flex-container flexFlowColumn">\n                                <label for="mvu_snapshot_interval">要保留变量的最近楼层数</label>\n                                <input\n                                    id="mvu_snapshot_interval"\n                                    v-model.number="\n                                        store.settings.auto_cleanup.要保留变量的最近楼层数\n                                    "\n                                    type="number"\n                                    min="1"\n                                    step="1"\n                                    class="text_pole"\n                                    placeholder="50"\n                                />\n                            </div>\n\n                            <div class="flex-container flexFlowColumn">\n                                <label for="mvu_snapshot_interval">触发恢复变量的最近楼层数</label>\n                                <input\n                                    id="mvu_snapshot_interval"\n                                    v-model.number="\n                                        store.settings.auto_cleanup.触发恢复变量的最近楼层数\n                                    "\n                                    type="number"\n                                    min="1"\n                                    step="1"\n                                    class="text_pole"\n                                    placeholder="50"\n                                />\n                            </div>\n                        </div>\n                    </Transition>\n                </div>\n\n                <div class="collapse-container">\n                    <button\n                        style="background: transparent"\n                        @click="compatibility_is_open = !compatibility_is_open"\n                    >\n                        {{ compatibility_is_open ? \'收起-兼容配置\' : \'展开-兼容配置\' }}\n                    </button>\n                    <Transition name="collapse">\n                        <div v-show="compatibility_is_open" class="collapse-content">\n                            <label class="checkbox_label" for="mvu_update_to_chat">\n                                <input\n                                    id="mvu_update_to_chat"\n                                    v-model="store.settings.更新到聊天变量"\n                                    type="checkbox"\n                                />\n                                <span>变量更新到聊天变量</span>\n                                <i\n                                    class="fa-solid fa-circle-question fa-sm note-link-span"\n                                    style="cursor: pointer"\n                                    @click="showChatVarHelp"\n                                />\n                            </label>\n                        </div>\n                    </Transition>\n                </div>\n\n                <label class="checkbox_label" for="mvu_auto_clean_checkbox">\n                    <input\n                        id="mvu_auto_clean_checkbox"\n                        v-model="store.settings.auto_cleanup.启用"\n                        type="checkbox"\n                    />\n                    <span>变量自动清理</span>\n                </label>\n            </div>\n\n            <hr />\n\n            <div class="flex-container flexFlowColumn">\n                <div><strong>修复按钮</strong></div>\n                <div class="flex-container flex">\n                    <div\n                        v-for="button in buttons"\n                        :key="button.name"\n                        class="menu_button menu_button_icon interactable"\n                        tabindex="0"\n                        role="button"\n                        @click="button.function"\n                    >\n                        {{ button.name }}\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n</template>\n\n<script setup lang="ts">\nimport { buttons } from \'@/button\';\nimport chat_variable_help from \'@/chat_variable_help.md\';\nimport panel_extra_mode_help from \'@/panel_extra_mode_help.md\';\nimport panel_method_help from \'@/panel_method_help.md\';\nimport { useSettingsStore } from \'@/settings\';\nimport { getSillyTavernVersion, getTavernHelperVersion } from \'@/util\';\nimport { compare } from \'compare-versions\';\nimport { ref, watch } from \'vue\';\n\nconst store = useSettingsStore();\n\nconst additional_extra_configuration_supported = compare(getTavernHelperVersion(), \'4.0.14\', \'>=\');\n\nconst cleanup_is_open = ref(false);\nconst compatibility_is_open = ref(false);\n\nwatch(\n    () => store.settings.更新方式,\n    value => {\n        if (value === \'额外模型解析\' && compare(getSillyTavernVersion(), \'1.13.4\', \'<\')) {\n            toastr.error(\n                "检查到酒馆版本过低，要使用\'额外模型解析\'请保证酒馆版本大于等于 1.13.4",\n                "[MVU]无法使用\'额外模型解析\'",\n                { timeOut: 5000 }\n            );\n            store.settings.更新方式 = \'随AI输出\';\n        }\n    }\n);\n\nwatch(\n    () => store.settings.额外模型解析配置.使用函数调用,\n    value => {\n        if (value === true) {\n            if (!SillyTavern.ToolManager.isToolCallingSupported()) {\n                toastr.error(\n                    "请在 API 配置 (插头) 处将提示词后处理改为\'含工具\'的选项",\n                    "[MVU]无法使用\'函数调用\'",\n                    {\n                        timeOut: 5000,\n                    }\n                );\n            }\n            if (SillyTavern.chatCompletionSettings.function_calling === false) {\n                toastr.error("请在预设面板勾选\'启用函数调用\'选项", "[MVU]无法使用\'函数调用\'", {\n                    timeOut: 5000,\n                });\n            }\n            store.settings.额外模型解析配置.使用函数调用 = true;\n        }\n    }\n);\n\nasync function showMethodHelp() {\n    SillyTavern.callGenericPopup(panel_method_help, SillyTavern.POPUP_TYPE.TEXT, \'\', {\n        allowVerticalScrolling: true,\n        leftAlign: true,\n        wide: true,\n    });\n}\n\nasync function showChatVarHelp() {\n    SillyTavern.callGenericPopup(chat_variable_help, SillyTavern.POPUP_TYPE.TEXT, \'\', {\n        allowVerticalScrolling: true,\n        leftAlign: true,\n        wide: true,\n    });\n}\n\nasync function showExtraModeHelp() {\n    SillyTavern.callGenericPopup(panel_extra_mode_help, SillyTavern.POPUP_TYPE.TEXT, \'\', {\n        allowVerticalScrolling: true,\n        leftAlign: true,\n        wide: true,\n    });\n}\n<\/script>\n\n<style scoped>\n.collapse-container {\n    border: 1px solid #ccc;\n    border-radius: 4px;\n    padding: 2px;\n    background: transparent;\n}\n\n/* 过渡动画定义 */\n.collapse-enter-from,\n.collapse-leave-to {\n    max-height: 0;\n    opacity: 0;\n    overflow: hidden;\n}\n\n.collapse-enter-to,\n.collapse-leave-from {\n    max-height: 240px; /* 根据内容调整 */\n    opacity: 1;\n}\n\n.collapse-enter-active,\n.collapse-leave-active {\n    transition: all 0.3s ease;\n}\n\n.collapse-content {\n    margin-top: 2px;\n    padding: 2px;\n    background-color: transparent;\n    border-radius: 4px;\n}\n</style>\n'],sourceRoot:''}]);const r=o},866:(e,t,a)=>{var n=a(859);n.__esModule&&(n=n.default),'string'==typeof n&&(n=[[e.id,n,'']]),n.locals&&(e.exports=n.locals);(0,a(534).A)('c9bf3204',n,!1,{ssrId:!0})}},l={};function c(e){var t=l[e];if(void 0!==t)return t.exports;var a=l[e]={id:e,exports:{}};return r[e](a,a.exports,c),a.exports}function d(e,t){}function u(e){return Array.isArray(e)&&2===e.length&&'string'==typeof e[1]}function p(e){return'array'===e.type}function m(e){return'object'===e.type}c.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return c.d(t,{a:t}),t},c.d=(e,t)=>{for(var a in t)c.o(t,a)&&!c.o(e,a)&&Object.defineProperty(e,a,{enumerable:!0,get:t[a]})},c.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),c.r=e=>{'undefined'!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:'Module'}),Object.defineProperty(e,'__esModule',{value:!0})};const f={VARIABLE_INITIALIZED:'mag_variable_initialized',SINGLE_VARIABLE_UPDATED:'mag_variable_updated',VARIABLE_UPDATE_ENDED:'mag_variable_update_ended',VARIABLE_UPDATE_STARTED:'mag_variable_update_started',COMMAND_PARSED:'mag_command_parsed',BEFORE_MESSAGE_UPDATE:'mag_before_message_update'},v='mag_invoke_mvu',g='mag_update_variable';const h='$__META_EXTENSIBLE__$';function b(e,t,a=!1){if(Array.isArray(e)){let n,s,i=!1,o=a;t&&(p(t)?(i=!0===t.extensible,o=!0===t.recursiveExtensible||a,n=t.elementType,s=t.template):console.error(`Type mismatch: expected array schema but got ${t.type} at path`));const r=e.findIndex(e=>_.isObject(e)&&!_.isDate(e)&&'$arrayMeta'in e&&'$meta'in e&&!0===e.$arrayMeta);if(-1!==r){const t=e[r];void 0!==t.$meta.extensible&&(i=t.$meta.extensible),void 0!==t.$meta.template&&(s=t.$meta.template),e.splice(r,1),console.log('Array metadata element found and processed.')}const l=e.indexOf(h);l>-1&&(i=!0,e.splice(l,1),console.log('Extensible marker found and removed from an array.'));const c={type:'array',extensible:i||a,recursiveExtensible:o,elementType:e.length>0?b(e[0],n,o):{type:'any'}};return void 0!==s&&(c.template=s),c}if(_.isObject(e)&&!_.isDate(e)){const n=e;let s,i=!1,o=a;t&&(m(t)?(i=!0===t.extensible,o=!0===t.recursiveExtensible||a,s=t.properties):console.error(`Type mismatch: expected object schema but got ${t.type} at path`));const r={type:'object',properties:{},extensible:i||!0===n.$meta?.extensible||!0===n.$meta?.recursiveExtensible||a,recursiveExtensible:o||!0===n.$meta?.recursiveExtensible};void 0!==n.$meta?.template?r.template=n.$meta.template:t&&m(t)&&t.template&&(r.template=t.template);const l=n.$meta;n.$meta&&delete n.$meta;for(const t in e){const e=s?.[t],a=!1!==r.extensible&&r.recursiveExtensible,i=b(n[t],e,a);let o=!r.extensible;Array.isArray(l?.required)&&l.required.includes(t)&&(o=!0),!1===e?.required?o=!1:!0===e?.required&&(o=!0),r.properties[t]={...i,required:o}}return r}const n=typeof e;return'string'===n||'number'===n||'boolean'===n?{type:n}:{type:'any'}}function y(e,t){if(!t||!e)return e||null;const a=_.toPath(t);let n=e;for(const e of a){if(!n)return null;if(/^\d+$/.test(e)){if(!p(n))return null;n=n.elementType}else{if(!m(n)||!n.properties[e])return null;n=n.properties[e]}}return n}function E(t){console.log('Reconciling schema with current data state...');const a=b(e(t.stat_data),t.schema);if(!m(a))return void console.error('Generated schema is not an object schema, which is unexpected for stat_data root');const n=a;void 0!==t.schema?.strictTemplate&&(n.strictTemplate=t.schema.strictTemplate),void 0!==t.schema?.strictSet&&(n.strictSet=t.schema.strictSet),void 0!==t.schema?.concatTemplateArray&&(n.concatTemplateArray=t.schema.concatTemplateArray),_.has(t.stat_data,'$meta.strictTemplate')&&(n.strictTemplate=t.stat_data.$meta?.strictTemplate),_.has(t.stat_data,'$meta.strictSet')&&(n.strictSet=t.stat_data.$meta?.strictSet),_.has(t.stat_data,'$meta.concatTemplateArray')&&(n.concatTemplateArray=t.stat_data.$meta?.concatTemplateArray),t.schema=n,console.log('Schema reconciliation complete.')}function x(e){if(Array.isArray(e)){let t=e.length;for(;t--;)e[t]===h||_.isObject(e[t])&&!_.isDate(e[t])&&'$arrayMeta'in e[t]&&'$meta'in e[t]&&!0===e[t].$arrayMeta?e.splice(t,1):x(e[t])}else if(t=e,_.isObject(t)&&!_.isDate(t)){delete e.$meta;for(const t in e)x(e[t])}var t}var A=globalThis.TavernHelper;let S='1.0.0';function V(){return S}let w='1.0.0';function T(){return w}function N(){return!!SillyTavern.ToolManager.isToolCallingSupported()&&!1!==SillyTavern.chatCompletionSettings.function_calling}const M='undefined'!=typeof jest||'undefined'!=typeof process&&!1,C=_.debounce(SillyTavern.saveChat,1e3);function k(e){return _(SillyTavern.chat).slice(0,e).findLastIndex(e=>void 0!==_.get(e,['variables',e.swipe_id??0,'stat_data'])&&void 0!==_.get(e,['variables',e.swipe_id??0,'schema']))}const I=[];function U(e,t){eventOn(e,t),I.push(()=>eventRemoveListener(e,t))}function O(e){try{return YAML.parseDocument(e,{merge:!0}).toJS()}catch(n){try{return t.parse(e)}catch(t){try{return a.parse(e)}catch(e){throw new Error(`initvar 不是有效的 YAML/JSON/JSON5/TOML 格式: ${e}`)}}}}const P=Vue,D=z,j=D.object({更新方式:D.enum(['随AI输出','额外模型解析']).default('随AI输出'),额外模型解析配置:D.object({发送预设:D.boolean().default(!0),使用函数调用:D.boolean().default(!1),模型来源:D.enum(['与插头相同','自定义']).default('与插头相同'),api地址:D.string().default('http://localhost:1234/v1'),密钥:D.string().default(''),模型名称:D.string().default('gemini-2.5-flash'),温度:D.coerce.number().default(1).transform(e=>_.clamp(e,0,2)),频率惩罚:D.coerce.number().default(0).transform(e=>_.clamp(e,-2,2)),存在惩罚:D.coerce.number().default(0).transform(e=>_.clamp(e,-2,2)),top_p:D.coerce.number().default(1).transform(e=>_.clamp(e,0,1)),最大回复token数:D.coerce.number().default(4096).transform(e=>Math.max(0,e))}).prefault({}),通知:D.object({变量更新出错:D.boolean().default(!1),额外模型解析中:D.boolean().default(!0)}).prefault({}),快照保留间隔:D.number().default(50),更新到聊天变量:D.boolean().default(!1),auto_cleanup:D.object({启用:D.boolean().default(!1),要保留变量的最近楼层数:D.number().default(20),触发恢复变量的最近楼层数:D.number().default(10)}).prefault({}),internal:D.object({已提醒更新了配置界面:D.boolean().default(!1),已提醒自动清理旧变量功能:D.boolean().default(!1),已提醒更新了API温度等配置:D.boolean().default(!1),已默认开启自动清理旧变量功能:D.boolean().default(!1)}).prefault({})}).prefault({}),L=s('settings',()=>{const e=(0,P.ref)(j.parse(_.get(SillyTavern.extensionSettings,'mvu_settings',{})));return(0,P.watch)(e,e=>{_.set(SillyTavern.extensionSettings,'mvu_settings',(0,P.toRaw)(e)),M||SillyTavern.saveSettingsDebounced()},{deep:!0}),{settings:e}}),R=i;function B(e){return _.isString(e)?e.replace(/^[\\"'` ]*(.*?)[\\"'` ]*$/,'$1'):e}function F(e,t,a=!1,n=!0){if(!t)return e;const s=_.isObject(e)&&!Array.isArray(e)&&!_.isDate(e),i=Array.isArray(e),o=Array.isArray(t);return s&&!o?_.merge({},t,e):i&&o?n?_.concat(e,t):_.merge([],t,e):(s||i)&&o!==i||!s&&!i&&_.isObject(t)&&!Array.isArray(t)?(console.error(`Template type mismatch: template is ${o?'array':'object'}, but value is ${i?'array':'object'}. Skipping template merge.`),e):s||i||!o||a?e:n?_.concat([e],t):_.merge([],t,[e])}function G(e){if('string'!=typeof e)return e;const t=e.trim();if('true'===t)return!0;if('false'===t)return!1;if('null'===t)return null;if('undefined'!==t){try{return JSON.parse(t)}catch(e){if(t.startsWith('{')&&t.endsWith('}')||t.startsWith('[')&&t.endsWith(']'))try{const e=new Function(`return ${t};`)();if(_.isObject(e)||Array.isArray(e))return e}catch(e){}}try{const e={Math,math:R},a=R.evaluate(t,e);if(R.isComplex(a)||R.isMatrix(a))return a.toString();if(void 0===a&&!/^[a-zA-Z_]+$/.test(t))return t;if(void 0!==a)return parseFloat(a.toPrecision(12))}catch(e){}try{return YAML.parse(t)}catch(e){}return B(e)}}function J(e){const t=_.concat([...e.matchAll(/<(json_?patch)>(?:\s*```.*)?((?:(?!<json_?patch>)[\s\S])*?)(?:```\s*)?<\/\1>/gim)].map(e=>({index:e.index??0,string:e[2].trim()})).flatMap(({index:e,string:t})=>{try{const a=O(t);if(function(e){return!!Array.isArray(e)&&(0===e.length||e.every(e=>'object'==typeof e&&null!==e&&'string'==typeof e.op&&'string'==typeof e.path))}(a))return function(e){const t=[];for(const a of e){const e=a.path.substring(1).replace(/\//g,'.');switch(a.op){case'replace':t.push({type:'set',full_match:JSON.stringify(a),args:[e,JSON.stringify(a.value)],reason:'json_patch'});break;case'add':{const n=_.toPath(e),s=n[n.length-1],i=n.slice(0,-1).join('.'),o=/^\d+$/.test(s)?s:`'${s}'`;t.push({type:'insert',full_match:JSON.stringify(a),args:[i,o,JSON.stringify(a.value)],reason:'json_patch'});break}case'remove':t.push({type:'delete',full_match:JSON.stringify(a),args:[e],reason:'json_patch'})}}return t}(a).map(t=>({$index:e,...t}))}catch{}return[]}));let a=0;for(;a<e.length;){const n=e.substring(a).match(/_\.(set|insert|assign|remove|unset|delete|add)\(/);if(!n||void 0===n.index)break;const s=n[1],i=a+n.index,o=i+n[0].length,r=q(e,o);if(-1===r){a=o;continue}let l=r+1;if(l>=e.length||';'!==e[l]){a=r+1;continue}l++;let c='';const d=e.substring(l).match(/^\s*\/\/(.*)/);d&&(c=d[1].trim(),l+=d[0].length);const u=e.substring(i,l),p=H(e.substring(o,r));let m=!1;('set'===s&&p.length>=2||'assign'===s&&p.length>=2||'insert'===s&&p.length>=2||'remove'===s&&p.length>=1||'unset'===s&&p.length>=1||'delete'===s&&p.length>=1||'add'===s&&2===p.length)&&(m=!0),m&&t.push({$index:i,type:s,full_match:u,args:p,reason:c}),a=l}return _(t).sortBy('$index').map(e=>_.omit(e,'$index')).value()}function q(e,t){let a=1,n=!1,s='';for(let i=t;i<e.length;i++){const t=e[i],o=i>0?e[i-1]:'';if('"'!==t&&'\''!==t&&'`'!==t||'\\'===o||(n?t===s&&(n=!1):(n=!0,s=t)),!n)if('('===t)a++;else if(')'===t&&(a--,0===a))return i}return-1}function H(e){const t=[];let a='',n=!1,s='',i=0,o=0,r=0;for(let l=0;l<e.length;l++){const c=e[l];'"'!==c&&'\''!==c&&'`'!==c||0!==l&&'\\'===e[l-1]||(n?c===s&&(n=!1):(n=!0,s=c)),n||('('===c&&r++,')'===c&&r--,'['===c&&i++,']'===c&&i--,'{'===c&&o++,'}'===c&&o--),','!==c||n||0!==r||0!==i||0!==o?a+=c:(t.push(a.trim()),a='')}return a.trim()&&t.push(a.trim()),t}async function Y(t){return e(_(SillyTavern.chat).slice(0,t+1).map(e=>_.get(e,['variables',e.swipe_id??0])).findLast(e=>_.has(e,'stat_data')))??getVariables()}function W(e){if(!e)return e;return e.replace(/\[([^\]]*)\]/g,(e,t)=>{let a=t.trim();if(!a)return'[]';let n=!1;const s=a[0],i=a[a.length-1];a.length>=2&&('"'===s||'\''===s)&&s===i&&(n=!0,a=a.slice(1,-1));const o=/^\d+$/.test(a),r=/\s/.test(a);if(o){if(n){return`["${a.replace(/"/g,'\\"')}"]`}return`[${a}]`}if(r){return`["${a.replace(/"/g,'\\"')}"]`}return`[${a}]`}).replace(/(^|\.)(["'])([^"']*)\2(?=\.|\[|$)/g,(e,t,a,n)=>{const s=/\s/.test(n),i=/[.[\]]/.test(n);if(s||i){const e=n.replace(/"/g,'\\"');return'.'===t?`["${e}"]`:`${t}["${e}"]`}return t+n})}async function X(t,a,n,s='',i=!1){const o=t.$internal?.display_data,r=t.$internal?.delta_data;if(_.has(t,a)){const l=_.get(t,a);if(Array.isArray(l)&&2===l.length){const c=e(l[0]);l[0]=n,_.set(t,a,l);const d=s?`(${s})`:'',u=`${B(JSON.stringify(c))}->${B(JSON.stringify(n))} ${d}`;return o&&_.set(o,a,u),r&&_.set(r,a,u),console.info(`Set '${a}' to '${B(JSON.stringify(n))}' ${d}`),i&&await eventEmit(f.SINGLE_VARIABLE_UPDATED,t,a,c,n),!0}{const c=e(l);_.set(t,a,n);const d=s?`(${s})`:'',u=B(JSON.stringify(n)),p=`${B(JSON.stringify(c))}->${u} ${d}`;return o&&_.set(o,a,p),r&&_.set(r,a,p),console.info(`Set '${a}' to '${u}' ${d}`),i&&await eventEmit(f.SINGLE_VARIABLE_UPDATED,t,a,c,n),!0}}return!1}function Z(e){return null==e||0===e.trim().length}async function K(t,a){const n=e(a),s=e(a),i={stat_data:{}},o=J(substitudeMacros(t));let r,l;_.set(a.stat_data,'$internal',{display_data:s.stat_data,delta_data:i.stat_data||{}}),await eventEmit(f.VARIABLE_UPDATE_STARTED,a);const c=function(e){console.warn(e),r={error_last:e,error_command:l}},v=a.schema,g=v?.strictTemplate??!1,h=v?.concatTemplateArray??!0,A=v?.strictSet??!1;for(const e of o)'remove'===e.type?e.type='delete':'assign'===e.type?e.type='insert':'unset'===e.type&&(e.type='delete');await eventEmit(f.COMMAND_PARSED,a,o,t),await eventEmit(f.COMMAND_PARSED+'_for_zod',a,o,t),function(e,t){for(const e of t)e.args[0]=W(B(e.args[0]))}(0,o);for(const t of o){const n=t.args[0],o=t.reason?`(${t.reason})`:'';let r='';switch(l=t,t.type){case'set':{if(''!==n&&!_.has(a.stat_data,n)){c(`Path '${n}' does not exist in stat_data, skipping set command ${o}`);continue}let s=''===n?e(a.stat_data):_.get(a.stat_data,n),i=G(t.args.at(-1));i instanceof Date&&(i=i.toISOString());let l=!1;if(A||!Array.isArray(s)||2!==s.length||'string'!=typeof s[1]||Array.isArray(s[0]))'number'==typeof s&&null!==i&&'string'==typeof i?_.set(a.stat_data,n,Number(i)):n?_.set(a.stat_data,n,i):a.stat_data=i;else{const t=e(s[0]);s[0]='number'==typeof s[0]&&null!==i?Number(i):i,s=t,l=!0}let p=''===n?a.stat_data:_.get(a.stat_data,n);d(),l&&(p=p[0]);r=!A&&u(s)&&Array.isArray(p)?`${B(JSON.stringify(s[0]))}->${B(JSON.stringify(p[0]))} ${o}`:`${B(JSON.stringify(s))}->${B(JSON.stringify(p))} ${o}`,console.info(`Set '${n}' to '${JSON.stringify(p)}' ${o}`),await eventEmit(f.SINGLE_VARIABLE_UPDATED,a.stat_data,n,s,p);break}case'insert':case'assign':{const s=n,i=''===s?a.stat_data:_.get(a.stat_data,s),l=y(v,s);if(null!==i&&!Array.isArray(i)&&!_.isObject(i)){c(`Cannot assign into path '${s}' because it holds a primitive value (${typeof i}). Operation skipped. ${o}`);continue}if(l){if('object'===l.type&&!1===l.extensible){if(2===t.args.length){c(`SCHEMA VIOLATION: Cannot merge data into non-extensible object at path '${s}'. ${o}`);continue}if(t.args.length>=3){const e=String(G(t.args[1]));if(!_.has(l.properties,e)){c(`SCHEMA VIOLATION: Cannot assign new key '${e}' into non-extensible object at path '${s}'. ${o}`);continue}}}else if('array'===l.type&&(!1===l.extensible||void 0===l.extensible)){c(`SCHEMA VIOLATION: Cannot assign elements into non-extensible array at path '${s}'. ${o}`);continue}}else if(''!==s&&!_.get(a.stat_data,_.toPath(s).slice(0,-1).join('.'))){c(`Cannot assign into non-existent path '${s}' without an extensible parent. ${o}`);continue}const d=e(i);let u=!1;if(2===t.args.length){let e=G(t.args[1]);e instanceof Date?e=e.toISOString():Array.isArray(e)&&(e=e.map(e=>e instanceof Date?e.toISOString():e));let i=''===s?a.stat_data:_.get(a.stat_data,n);if(Array.isArray(i)||_.isObject(i)||(i=Array.isArray(e)?[]:{},_.set(a.stat_data,n,i)),Array.isArray(i)){e=F(e,l&&p(l)?l.template:void 0,g,h),i.push(e),r=`ASSIGNED ${JSON.stringify(e)} into array '${n}' ${o}`,u=!0}else if(_.isObject(i)){if(!_.isObject(e)||Array.isArray(e)){c(`Cannot merge ${Array.isArray(e)?'array':'non-object'} into object at '${n}'`);continue}_.merge(i,e),r=`MERGED object ${JSON.stringify(e)} into object '${n}' ${o}`,u=!0}}else if(t.args.length>=3){let e=G(t.args[2]);const i=G(t.args[1]);e instanceof Date?e=e.toISOString():Array.isArray(e)&&(e=e.map(e=>e instanceof Date?e.toISOString():e));let c=''===s?a.stat_data:_.get(a.stat_data,n);const d=l&&(p(l)||m(l))?l.template:void 0;Array.isArray(c)&&'number'==typeof i?(e=F(e,d,g,h),c.splice(i,0,e),r=`ASSIGNED ${JSON.stringify(e)} into '${n}' at index ${i} ${o}`,u=!0):_.isObject(c)?(e=F(e,d,g,h),c[String(i)]=e,r=`ASSIGNED key '${i}' with value ${JSON.stringify(e)} into object '${n}' ${o}`,u=!0):(c={},_.set(a.stat_data,n,c),e=F(e,d,g,h),c[String(i)]=e,r=`CREATED object at '${n}' and ASSIGNED key '${i}' ${o}`,u=!0)}if(!u){c(`Invalid arguments for _.assign on path '${n}'`);continue}{const t=Z(n)?a.stat_data:_.get(a.stat_data,n);console.info(r),await eventEmit(f.SINGLE_VARIABLE_UPDATED,a.stat_data,n,d,t);try{const a=b(e(t),l);_.merge(l,a),x(t)}catch(e){e instanceof Error?c(`Failed to resolve template meta at '${n}', '${e.message}'`):c(`Failed to resolve template meta at '${n}', '${e}'`)}}break}case'unset':case'delete':case'remove':{const s=_.toPath(n),i=s[s.length-1],l=/^\d+$/.test(i);if(1===t.args.length&&l){const t=s.slice(0,-1).join('.'),n=_.get(a.stat_data,t),l=parseInt(i,10);if(Array.isArray(n)&&l<n.length){const s=e(n);n.splice(l,1),r=`REMOVED item from '${t}' at index ${l} ${o}`,console.info(r),await eventEmit(f.SINGLE_VARIABLE_UPDATED,a.stat_data,t,s,n);continue}}if(!_.has(a.stat_data,n)){c(`undefined Path: ${n} in _.remove command`);continue}let d,u=n;if(t.args.length>1)d=G(t.args[1]),'string'==typeof d&&(d=B(d));else{const e=_.toPath(n),t=e.pop();t&&(d=/^\d+$/.test(t)?Number(t):t,u=e.join('.'))}if(void 0===d){c(`Could not determine target for deletion for command on path '${n}' ${o}`);continue}if(''!==u&&!_.has(a.stat_data,u)){c(`Cannot remove from non-existent path '${u}'. ${o}`);continue}const p=y(v,u);if(p)if('array'===p.type){if(!0!==p.extensible){c(`SCHEMA VIOLATION: Cannot remove element from non-extensible array at path '${u}'. ${o}`);continue}}else if('object'===p.type){const e=String(d);if(_.has(p.properties,e)&&!0===p.properties[e].required){c(`SCHEMA VIOLATION: Cannot remove required key '${e}' from path '${u}'. ${o}`);continue}}const m=t.args.length>1?G(t.args[1]):void 0;let g=!1;if(void 0===m){const e=_.get(a.stat_data,n);_.unset(a.stat_data,n),r=`REMOVED path '${n}' ${o}`,g=!0,await eventEmit(f.SINGLE_VARIABLE_UPDATED,a.stat_data,n,e,void 0)}else{const t=_.get(a.stat_data,n);if(!Array.isArray(t)&&!_.isObject(t)){c(`Cannot remove from path '${n}' because it is not an array or object. Skipping command. ${o}`);continue}if(Array.isArray(t)){const s=e(t);let i=-1;i='number'==typeof m?m:t.findIndex(e=>_.isEqual(e,m)),i>=0&&i<t.length&&(t.splice(i,1),g=!0,r=`REMOVED item from '${n}' ${o}`,await eventEmit(f.SINGLE_VARIABLE_UPDATED,a.stat_data,n,s,t))}else if(_.isObject(t))if('number'==typeof m){const e=Object.keys(t),a=m;if(a>=0&&a<e.length){const s=e[a];_.unset(t,s),g=!0,r=`REMOVED ${a+1}th entry ('${s}') from object '${n}' ${o}`}}else{const e=String(m);_.has(t,e)&&(delete t[e],g=!0,r=`REMOVED key '${e}' from object '${n}' ${o}`)}}if(!g){c(`Failed to execute remove on '${n}'`);continue}console.info(r);break}case'add':{if(!_.has(a.stat_data,n)){c(`Path '${n}' does not exist in stat_data, skipping add command ${o}`);continue}const s=e(_.get(a.stat_data,n)),i=_.get(a.stat_data,n);let l=i;const p=u(i)&&'object'!=typeof i[0];p&&(d(),l=i[0]);let m=null;if(l instanceof Date)m=l;else if('string'==typeof l){const e=new Date(l);!isNaN(e.getTime())&&isNaN(Number(l))&&(m=e)}if(2!==t.args.length){c(`Invalid number of arguments for _.add on path '${n}' ${o}`);continue}{const e=G(t.args[1]);if(m){if('number'!=typeof e){c(`Delta '${t.args[1]}' for Date operation is not a number, skipping add command ${o}`);continue}const l=new Date(m.getTime()+e),u=l.toISOString();p?(d(),i[0]=u,_.set(a.stat_data,n,i)):_.set(a.stat_data,n,u);const v=_.get(a.stat_data,n);r=p?`${JSON.stringify(s[0])}->${JSON.stringify(v[0])} ${o}`:`${JSON.stringify(s)}->${JSON.stringify(v)} ${o}`,console.info(`ADDED date '${n}' from '${m.toISOString()}' to '${l.toISOString()}' by delta '${e}'ms ${o}`),await eventEmit(f.SINGLE_VARIABLE_UPDATED,a.stat_data,n,s,v)}else{if('number'!=typeof l){c(`Path '${n}' value is not a date or number; skipping add command ${o}`);continue}{if('number'!=typeof e){c(`Delta '${t.args[1]}' is not a number, skipping add command ${o}`);continue}let d=l+e;d=parseFloat(d.toPrecision(12)),p?(i[0]=d,_.set(a.stat_data,n,i)):_.set(a.stat_data,n,d);const u=_.get(a.stat_data,n);r=p?`${JSON.stringify(s[0])}->${JSON.stringify(u[0])} ${o}`:`${JSON.stringify(s)}->${JSON.stringify(u)} ${o}`,console.info(`ADDED number '${n}' from '${l}' to '${d}' by delta '${e}' ${o}`),await eventEmit(f.SINGLE_VARIABLE_UPDATED,a.stat_data,n,s,u)}}}break}}r&&(_.set(s.stat_data,n,r),_.set(i.stat_data,n,r))}a.display_data=s.stat_data,a.delta_data=i.stat_data,await eventEmit(f.VARIABLE_UPDATE_ENDED,a,n),await eventEmit(f.VARIABLE_UPDATE_ENDED+'_for_zod',a,n),_.unset(a.stat_data,'$internal');const S=!_.isEqual(a.stat_data,n.stat_data);if(S&&E(a),r&&L().settings.通知.变量更新出错){const e=r.error_command.full_match;'undefined'!=typeof toastr&&toastr.warning(`最近错误: ${r.error_last}`,`[MVU]发生变量更新错误，可能需要重Roll: ${e}`,{timeOut:6e3})}return S}async function Q(e){const t=getChatMessages(e).at(-1);if(!t)return;let a=t.message;if('assistant'===t.role&&a.length<5)return;const n=0===e?0:e-1,s=await Y(n),i=L().settings;if(!_.has(s,'stat_data'))return void console.error(`cannot found stat_data for ${n}`);const o=await K(a,s);if(o&&'user'!==t.role){const e={variables:s,message_content:a};await eventEmit(f.BEFORE_MESSAGE_UPDATE,e),a=e.message_content}const r=e=>(e.initialized_lorebooks=s.initialized_lorebooks,e.stat_data=s.stat_data,void 0!==s.schema?_.set(e,'schema',s.schema):_.unset(e,'schema'),void 0!==s.display_data?_.set(e,'display_data',s.display_data):_.unset(e,'display_data'),void 0!==s.delta_data?_.set(e,'delta_data',s.delta_data):_.unset(e,'delta_data'),e);o&&i.更新到聊天变量&&await updateVariablesWith(r,{type:'chat'}),await updateVariablesWith(r,{type:'message',message_id:e}),'user'!==t.role&&(a.includes('<StatusPlaceHolderImpl/>')||(a+='\n\n<StatusPlaceHolderImpl/>'),await setChatMessages([{message_id:e,message:a}],{refresh:'affected'}))}async function ee(t,a){if(void 0!==a.old_variables)return a.new_variables=e(a.old_variables),await K(t,a.new_variables),a.new_variables}function te(e,t,a){let n=0;return _(SillyTavern.chat).slice(e,t+1).forEach((t,s)=>{if(void 0===t.variables)return;let i=!1;t.variables=_.range(0,t.swipes?.length??1).map(o=>void 0===t?.variables?.[o]?{}:!0===_.get(t?.variables?.[o],'snapshot')?t.variables[o]:(e+s)%a===0?(_.set(t,['variables',o,'snapshot'],!0),t.variables[o]):(i||(i=!0,++n),_.omit(t.variables[o],'initialized_lorebooks','stat_data','display_data','delta_data','schema')))}),C(),n}function ae(e,t,a,n){_.forEach(t,(e,t)=>{const s=t;if(_.isArray(e)){if(2===e.length&&_.isString(e[1])){if(_.isArray(_.get(a,s))){const i=_.get(a,s);if(2===i.length)if(_.set(n,`${s}[1]`,e[1]),_.isObject(e[0])&&!_.isArray(e[0])){const a=_.get(n,`${t}[0]`);_.has(e[0],'description')&&_.isString(e[0].description)&&_.has(i[0],'description')&&_.set(n,`${s}[0].description`,e[0].description),ae(`${s}[0]`,e[0],i[0],a)}else _.isArray(e[0])&&ae(`${s}[0]`,e[0],i[0],n[0])}}else if(_.isArray(_.get(a,s))){const t=_.get(a,s);e.forEach((a,i)=>{if(i<t.length&&_.isObject(a)){const o=_.get(n,`${s}[${i}]`);_.has(a,'description')&&_.isString(a.description)&&_.has(t[i],'description')&&_.set(o,'description',a.description),ae(`${s}[${i}]`,e[i],t[i],o)}})}}else if(_.isObject(e)){if(_.has(e,'description')&&_.isString(e.description)){const s=`${t}.description`;_.has(a,s)&&_.set(n,s,e.description)}_.has(a,t)&&_.isObject(a[t])&&ae(s,e,a[t],n[t])}})}async function ne(){let t;try{if(0===SillyTavern.chat.length)return console.error('不存在任何一条消息，退出'),void toastr.error('需要有开场白才能初始化变量','[MVU]变量初始化失败');t=await Y(getLastMessageId())??{display_data:{},initialized_lorebooks:{},stat_data:{},delta_data:{},schema:{type:'object',properties:{}}}}catch(e){return void console.error('不存在任何一条消息，退出')}if(void 0===t&&(t={display_data:{},initialized_lorebooks:{},stat_data:{},delta_data:{},schema:{type:'object',properties:{}}}),_.has(t,'initialized_lorebooks')||(t.initialized_lorebooks={}),Array.isArray(t.initialized_lorebooks)){console.warn('Old "initialized_lorebooks" array format detected. Migrating to the new object format.');const e=t.initialized_lorebooks,a={};for(const t of e)a[t]=[];t.initialized_lorebooks=a}t.stat_data||(t.stat_data={}),t.schema||(t.schema={extensible:!1,properties:{},type:'object'});const a=await se(t);if(a){}if(a||!t.schema||_.isEmpty(t.schema)){const a=b(e(t.stat_data),t.schema);m(a)?(_.has(t.stat_data,'$meta.strictTemplate')&&(a.strictTemplate=t.stat_data.$meta?.strictTemplate),_.has(t.stat_data,'$meta.concatTemplateArray')&&(a.concatTemplateArray=t.stat_data.$meta?.concatTemplateArray),_.has(t.stat_data,'$meta.strictSet')&&(a.strictSet=t.stat_data.$meta?.strictSet),t.schema=a):console.error('Generated schema is not an object schema, which is unexpected for stat_data root'),x(t.stat_data)}if(a){if(L().settings.更新到聊天变量&&(console.info('Init chat variables.'),await updateVariablesWith(e=>_.assign(e,t),{type:'chat'})),0==getLastMessageId()){const a=getChatMessages(0,{include_swipes:!0})[0];await setChatMessages([{message_id:0,swipes_data:await Promise.all(a.swipes.map(async(n,s)=>{let i=e(a.swipes_data[s]);void 0===i&&(i={});const o=_.merge(i,e(t)),r=n.matchAll(/<(initvar)>(?:\s*```.*)?([\s\S]*?)(?:```\s*)?<\/\1>/gim);let l=!1;const c={};for(const e of r){const t=e[2];try{const e=O(substitudeMacros(t));_.merge(c,e),l=!0}catch(e){console.error('failed to parse initvar block:'+e)}}if(l){o.stat_data=c;const e=getCharWorldbookNames('current').primary??'unknown';o.initialized_lorebooks={},o.initialized_lorebooks[e]=[],await se(o)}return await eventEmit(f.VARIABLE_INITIALIZED,o,s),await K(n,o),console.log('变量初始化完成'),o}))}])}else await setChatMessage({data:t},getLastMessageId());try{toastr.info(`有新的世界书初始化变量被加载，当前使用世界书:<br>${Object.entries(t.initialized_lorebooks??{}).map(([e,t])=>`- ${e}: ${JSON.stringify(t)}`).join('<br>')}`,'[MVU]变量初始化成功',{escapeHtml:!1})}catch(e){}await async function(){const e={scan_depth:2,context_percentage:100,budget_cap:0,min_activations:0,max_depth:0,max_recursion_steps:0,insertion_strategy:'character_first',include_names:!1,recursive:!0,case_sensitive:!1,match_whole_words:!1,use_group_scoring:!1,overflow_alert:!1},t=getLorebookSettings();_.isEqual(_.merge({},t,e),t)||setLorebookSettings(e)}()}}async function se(e,t){const a=t||await async function(){const e=[...(await getLorebookSettings()).selected_global_lorebooks],t=await getCurrentCharPrimaryLorebook();return null!==t&&e.push(t),e}();let n=!1;e.initialized_lorebooks&&!Array.isArray(e.initialized_lorebooks)||(e.initialized_lorebooks={});for(const t of a){if(_.has(e.initialized_lorebooks,t))continue;e.initialized_lorebooks[t]=[];const a=await getLorebookEntries(t);for(const t of a)if(t.comment?.toLowerCase().includes('[initvar]')){const a=t.content.trim().match(/```.*\n([\s\S]*)\n```/m);a&&(t.content=a[1]);const n=substitudeMacros(t.content);let s=null,i=null;try{s=O(n)}catch(e){i=e}if(i)throw console.error(`解析世界书条目'${t.comment}'失败: ${i}`),toastr.error(i.message,`[MVU] 解析世界书条目'${t.comment}'失败`,{timeOut:5e3}),i;s&&(e.stat_data=_.merge(e.stat_data,s))}n=!0}return n}let ie,oe;const re=[{name:'重新处理变量',function:async()=>{const e=getLastMessageId();e<1||0!==SillyTavern.chat.length&&(await updateVariablesWith(e=>(_.unset(e,'stat_data'),_.unset(e,'delta_data'),_.unset(e,'display_data'),_.unset(e,'schema'),e),{type:'message',message_id:e}),await Q(getLastMessageId()))}},{name:'重新读取初始变量',function:async()=>{const t={display_data:{},initialized_lorebooks:{},stat_data:{},delta_data:{},schema:{type:'object',properties:{}}};try{if(!await se(t))return console.error('没有找到 InitVar 数据'),void toastr.error('没有找到 InitVar 数据','[MVU]',{timeOut:3e3})}catch(e){return void console.error('加载 InitVar 数据失败:',e)}await E(t),x(t.stat_data);const a=getLastMessageId();if(a<0)return console.error('没有找到消息'),void toastr.error('没有找到消息','[MVU]',{timeOut:3e3});const n=await Y(a);if(!_.has(n,'stat_data'))return console.error('最新消息中没有找到 stat_data'),void toastr.error('最新消息中没有 stat_data','[MVU]',{timeOut:3e3});const s={stat_data:void 0,schema:void 0};s.stat_data=_.merge({},t.stat_data,n.stat_data),s.schema=_.merge({},n.schema,t.schema),s.initialized_lorebooks=_.merge({},t.initialized_lorebooks,n.initialized_lorebooks),s.display_data=e(s.stat_data),s.delta_data=n.delta_data,ae(0,t.stat_data,n.stat_data,s.stat_data),await E(s),x(s.stat_data),await replaceVariables(s,{type:'message',message_id:a}),await setChatMessage({},a),L().settings.更新到聊天变量&&await replaceVariables(s,{type:'chat'}),console.info('InitVar更新完成'),toastr.success('InitVar描述已更新','[MVU]',{timeOut:3e3})}},{name:'快照楼层',function:async()=>{const e=await SillyTavern.callGenericPopup('<h4>设置快照楼层可以避免指定的楼层在清理操作中被移除变量信息</h4>请填写要保留变量信息的楼层 (如 10 为第 10 层)<br><strong>后续楼层的重演将可以从这一层开始</strong>',SillyTavern.POPUP_TYPE.INPUT,'10');if(!e)return;const t=parseInt(e);if(isNaN(t))return void toastr.error(`请输入有效的楼层数, 你输入的是 '${e}'`,'[MVU]配置楼层快照失败');const a=SillyTavern.chat[t];void 0!==a?(_.range(0,a.swipes?.length??1).forEach(e=>{void 0!==a?.variables?.[e]&&(a.variables[e].snapshot=!0)}),SillyTavern.saveChat().then(()=>toastr.success(`已将 ${t} 层配置为快照楼层`,'[MVU]配置楼层快照'))):toastr.error(`无效的楼层 '${e}'`,'[MVU]配置楼层快照失败')}},{name:'重演楼层',function:async function(){const t=await SillyTavern.callGenericPopup('<h4>当变量更新出现 required/extensible 相关问题时，可以尝试通过从过去的楼层重演解决</h4>请填写要进行重演的楼层 (如 10 为第 10 层, -1 为最新楼层)<br><strong>也就是出现问题的楼层</strong>',SillyTavern.POPUP_TYPE.INPUT,'-1');if(!t)return;let a=parseInt(t);if(-1===a&&(a=getLastMessageId()),isNaN(a)||void 0===SillyTavern.chat[a])return void toastr.error(`请输入有效的楼层数, 你输入的是 '${t}'`,'[MVU]楼层重演失败');const n=k(a);if(-1===n)return void toastr.error('无法找到可以进行重演的楼层','[MVU]楼层重演失败');const s=await SillyTavern.callGenericPopup(`请填写从哪个楼层开始重演，找到最近的支持重演楼层为 [${n}]`,SillyTavern.POPUP_TYPE.INPUT,n.toString());if(!s)return;const i=parseInt(s);if(isNaN(i))return void toastr.error(`请输入有效的楼层数, 你输入的是 '${s}'`,'[MVU]楼层重演失败');const o=e(getVariables({type:'message',message_id:i}));if(void 0===o||!_.has(o,'stat_data')||!_.has(o,'schema'))return void toastr.error(`请输入含变量信息的楼层, 你输入的是 '${s}'`,'[MVU]楼层重演失败');let r=0;for(let e=i+1;e<=a;e++){const t=SillyTavern.chat[e],n=e-(i+1);console.log(`正在重演 ${n}, 内容 ${t.mes}`),await K(t.mes,o),r++,r%50==0&&toastr.info(`处理变量中 (${r} / ${a-i})`,'[MVU]楼层重演')}await updateVariablesWith(e=>(e.stat_data=o.stat_data,e.display_data=o.display_data,e.delta_data=o.delta_data,e.initialized_lorebooks=o.initialized_lorebooks,e.schema=o.schema,e),{type:'message',message_id:a}),SillyTavern.saveChat().then(()=>toastr.success(`已将 ${a} 层变量状态重演完毕，共重演 ${r} 楼`,'[MVU]楼层重演')),await setChatMessages([{message_id:a}],{refresh:'affected'})}},{name:'重试额外模型解析',function:async function(){const e=L().settings;if('随AI输出'===e.更新方式)return void toastr.info('当前配置没有启用额外模型解析，不需要进行此操作','[MVU]重试额外模型解析',{timeOut:3e3});if(e.额外模型解析配置.使用函数调用&&!N())return void toastr.info('当前配置指定的LLM不支持函数调用，不需要进行此操作','[MVU]重试额外模型解析',{timeOut:3e3});if(!oe)return void toastr.info('当前角色卡不支持额外模型解析，或是刚刚刷新页面，无法进行此操作','[MVU]重试额外模型解析',{timeOut:3e3});const t=getLastMessageId(),a=getChatMessages(t).at(-1),n=a?.message??'',s=n.lastIndexOf('<UpdateVariable>');if(s>=0){const e=n.lastIndexOf('</UpdateVariable>');let a='';a=-1===e?n.slice(0,s):n.slice(0,s)+n.slice(e+17),await setChatMessages([{message_id:t,message:a}],{refresh:'none'})}await ie(t),toastr.info('解析完成','[MVU]重试额外模型解析')}},{name:'清除旧楼层变量',function:async()=>{const e=L().settings.快照保留间隔,t=await SillyTavern.callGenericPopup(`<h4>清除旧楼层变量信息以减小聊天文件大小避免手机崩溃</h4>请填写要保留变量信息的楼层数 (如 10 为保留最后 10 层，每 [${e}] 层保留一层作为快照)，每 <br><strong>注意: 你需要通过重演才能回退游玩到没保留变量信息的楼层</strong>`,SillyTavern.POPUP_TYPE.INPUT,'10');if(!t)return;const a=parseInt(t);isNaN(a)?toastr.error(`请输入有效的楼层数, 你输入的是 '${t}'`,'[MVU]清理旧楼层变量失败'):(SillyTavern.chat.slice(1,-a-1).forEach((t,a)=>{void 0!==t.variables&&(t.variables=_.range(0,t.swipes?.length??1).map(n=>void 0===t?.variables?.[n]?{}:!0===_.get(t.variables[n],'snapshot')?t.variables[n]:(a+1)%e===0?(t.variables[n].snapshot=!0,console.log(`将 [${a+1}] 层作为快照楼层`),t.variables[n]):_.omit(t.variables[n],'stat_data','display_data','delta_data','schema')))}),SillyTavern.saveChat().then(()=>toastr.success(`已清理旧变量, 保留了最后 ${a} 层的变量`,'[MVU]清理旧楼层变量成功')))}}];function le(){return{events:f,parseMessage:async function(e,t){const a={old_variables:t};return await ee(e,a),a.new_variables},getMvuData:function(e){return getVariables(e)},replaceMvuData:async function(e,t){await replaceVariables(e,t)},getCurrentMvuData:function(){return getVariables({type:'message',message_id:getCurrentMessageId()})},replaceCurrentMvuData:async function(e){await replaceVariables(e,{type:'message',message_id:getCurrentMessageId()})},reloadInitVar:async function(e){return await se(e)},setMvuVariable:async function(e,t,a,{reason:n='',is_recursive:s=!1}={}){return await X(e.stat_data,t,a,n,s)},getMvuVariable:function(e,t,{category:a='stat',default_value:n}={}){let s;switch(a){case'stat':s=e.stat_data;break;case'display':s=e.display_data;break;case'delta':s=e.delta_data}const i=_.get(s,t,n);return function(e){return Array.isArray(e)&&2===e.length&&'string'==typeof e[1]}(i)?i[0]:i},getRecordFromMvuData:function(e,t){return function(e,t){let a;switch(e){case'stat':a=t.stat_data;break;case'display':a=t.display_data;break;case'delta':a=t.delta_data}return a}(t,e)}}}const ce='mvu_VariableUpdate';let de=!1;function ue(e){de=e}async function pe(e){if(!e?.delta)return'';let t=getLastMessageId(),a=getChatMessages(t).at(-1);if(a&&'system'===a.role&&(t-=1,a=getChatMessages(t).at(-1)),!a)return'';let n=a.message;const s=await Y(t);if(!_.has(s,'stat_data'))return console.error(`cannot found stat_data for ${t}`),'';return await K(e.delta,s)&&L().settings.更新到聊天变量&&await replaceVariables(s,{type:'chat'}),await replaceVariables(s,{type:'message',message_id:t}),n+=`<UpdateVariable>\n<Analysis>${e.analysis}</Analysis></Analysis>${e.delta}\n</UpdateVariable>`,'user'===a.role||n.includes('<StatusPlaceHolderImpl/>')?await setChatMessages([{message_id:t,message:n}],{refresh:'affected'}):await setChatMessages([{message_id:t,message:n+'\n\n<StatusPlaceHolderImpl/>'}],{refresh:'affected'}),JSON.stringify(s.delta_data)}function _e(e){const t=L().settings;'额外模型解析'===t.更新方式&&!0===t.额外模型解析配置.使用函数调用&&de&&void 0!==e.tools&&_.size(e.tools)>0&&(e.tool_choice='required')}const me={class:'inline-drawer'},fe={class:'inline-drawer-content'},ve={class:'flex-container flexFlowColumn'},ge={class:'checkbox_label',for:'mvu_notification_error'},he={class:'checkbox_label',for:'mvu_notification_extra_model_parsing'},be={class:'flex-container flexFlowColumn'},ye={class:'checkbox_label',for:'mvu_extra_model_send_preset'},Ee={class:'checkbox_label',for:'mvu_extra_model_use_function_calling'},xe={class:'flex-container flexFlowColumn'},Ae={class:'flex-container flexFlowColumn'},Se={class:'flex-container flexFlowColumn'},Ve={key:0},$e={class:'flex-container flexFlowColumn'},we=['disabled'],Te={class:'flex-container flexFlowColumn'},Ne=['disabled'],Me={class:'flex-container flexFlowColumn'},Ce=['disabled'],ke={class:'flex-container flexFlowColumn'},Ie=['disabled'],Ue={class:'flex-container flexFlowColumn'},Oe=['disabled'],Pe={class:'flex-container flexFlowColumn'},De={class:'collapse-container'},je={class:'collapse-content'},Le={class:'flex-container flexFlowColumn'},Re={class:'flex-container flexFlowColumn'},Be={class:'flex-container flexFlowColumn'},Fe={class:'collapse-container'},Ge={class:'collapse-content'},Je={class:'checkbox_label',for:'mvu_update_to_chat'},ze={class:'checkbox_label',for:'mvu_auto_clean_checkbox'},qe={class:'flex-container flexFlowColumn'},He={class:'flex-container flex'},Ye=['onClick'],We=(0,P.defineComponent)({__name:'Panel',setup(e){const t=L(),a=o(T(),'4.0.14','>='),n=(0,P.ref)(!1),s=(0,P.ref)(!1);async function i(){SillyTavern.callGenericPopup('<h1>使用说明</h1> <h2>选择你的变量更新方式</h2> <p>为了让剧情模型更专注于剧情，你可以选择变量更新的方式：</p> <ul> <li><strong>随AI输出</strong>：条目将会正常发给 AI，因此 AI 将会在回复时输出变量更新分析及更新命令，进而更新变量。</li> <li><strong>额外模型解析</strong>：先由一个 AI 专门输出剧情，再由一个 AI 专门解析剧情来更新变量，这个过程中： <ul> <li>名字中有 <code>[mvu_plot]</code> 的条目只会发给输出剧情 AI</li> <li>名字中有 <code>[mvu_update]</code> 的条目只会发给更新变量 AI</li> <li>名字中既没有 <code>[mvu_plot]</code> 也没有 <code>[mvu_update]</code> 将会发送给两个 AI</li> </ul> </li> </ul> <p>除“随AI输出”以外的方式，只有在作者适配世界书后才能使用——但没适配也没关系——如果作者没有适配，则 MVU 依旧会使用“随AI输出”的方式更新变量。</p> <h2>适配世界书</h2> <p>你只需要拆分一下条目、给条目改一下名字就能让世界书适配其他变量更新方式。</p> <p>具体地，MVU 变量框架的提示词分为：</p> <ul> <li><strong>变量列表</strong>：让 AI 知道有什么变量，如 <code>{{get_message_variable::stat_data}}</code>、<code>&#x3C;%= getvar(\'stat_data\') _%></code> 等。</li> <li><strong>变量更新规则</strong>：让 AI 知道变量该如何更新，如<code>药物依赖度应该每分钟增加1点</code>等。</li> <li><strong>输出规则</strong>：让 AI 知道该输出什么来表达变量发生变化，如提示词中要求输出的 <code>&#x3C;UpdateVariable></code> 块。</li> </ul> <p>你需要做的，是给“变量更新规则”和“输出规则”条目的名字添加 <code>[mvu_update]</code>，也就是改成：</p> <ul> <li><code>变量列表</code></li> <li><code>[mvu_update]变量更新规则</code></li> <li><code>[mvu_update]输出规则</code></li> </ul> <p>此外，如果你有其他输出格式，为了不对变量更新 AI 产生干扰，你可以用 <code>[mvu_plot]</code> 指定它只发给负责输出剧情的 AI：</p> <ul> <li><code>[mvu_plot]剧情思维链</code></li> </ul> <p>这样修改名字只是区分什么情况下发送条目, 绿灯等功能依旧会生效.</p> ',SillyTavern.POPUP_TYPE.TEXT,'',{allowVerticalScrolling:!0,leftAlign:!0,wide:!0})}async function r(){SillyTavern.callGenericPopup('<p>启用后，所有变量更新结果也会输出到聊天变量中。如果部分老角色卡无法正常游玩，可以开启这个开关。</p> ',SillyTavern.POPUP_TYPE.TEXT,'',{allowVerticalScrolling:!0,leftAlign:!0,wide:!0})}async function l(){SillyTavern.callGenericPopup('<h1>额外模型解析方式</h1> <ul> <li> <p>发送预设：是否要把预设里的条目也发给额外模型</p> <ul> <li>开启：额外模型将会被预设破限; 但是预设往往规定了写作任务，因此额外模型可能会选择继续剧情而不是更新变量。</li> <li>关闭：额外模型可能因为没有被破限而道歉。</li> </ul> </li> <li> <p>使用函数调用：一些渠道的模型支持函数调用</p> <ul> <li>开启：额外模型将使用函数调用来更新变量，不受预设的写作任务影响; 但很多渠道不支持函数调用。</li> <li>关闭：额外模型会通过输出文本来更新变量，可能受预设的写作任务影响而选择继续剧情而不是更新变量。</li> </ul> </li> </ul> <h2>什么时候需要调整解析方式</h2> <p>默认情况下，更新变量的 AI 请求也会包含预设的内容，不过 AI 因此有一定概率受预设的写作任务而继续剧情，导致其实是在推进剧情的同时分析了变量——变量的更新结果实际上是属于未来剧情的，与当前回复并不吻合。</p> <p>如果发现了这种不吻合，在 SFW 的场合可以关闭<code>发送预设</code>，避免预设对变量分析请求的影响; 在 NSFW 的场合，则可以尝试开启<code>使用函数调用</code>来稳定覆盖掉预设中的任务。</p> <p>但<code>函数调用</code>存在限制:</p> <ul> <li>MVU 的<code>函数调用</code>要求支持的函数调用类型为 <code>required</code></li> <li>目前只有一部分模型/提供商/反代支持函数调用</li> <li>已知支持的模型至少包括 Claude 4+、Gemini 2.5 Pro、Deepseek V3/V3.1 (官方渠道，硅基流动等的不支持); 如果你使用的是上述模型，但是请求报错，建议换个渠道使用这些模型</li> </ul> ',SillyTavern.POPUP_TYPE.TEXT,'',{allowVerticalScrolling:!0,leftAlign:!0,wide:!0})}return(0,P.watch)(()=>t.settings.更新方式,e=>{'额外模型解析'===e&&o(V(),'1.13.4','<')&&(toastr.error('检查到酒馆版本过低，要使用\'额外模型解析\'请保证酒馆版本大于等于 1.13.4','[MVU]无法使用\'额外模型解析\'',{timeOut:5e3}),t.settings.更新方式='随AI输出')}),(0,P.watch)(()=>t.settings.额外模型解析配置.使用函数调用,e=>{!0===e&&(SillyTavern.ToolManager.isToolCallingSupported()||toastr.error('请在 API 配置 (插头) 处将提示词后处理改为\'含工具\'的选项','[MVU]无法使用\'函数调用\'',{timeOut:5e3}),!1===SillyTavern.chatCompletionSettings.function_calling&&toastr.error('请在预设面板勾选\'启用函数调用\'选项','[MVU]无法使用\'函数调用\'',{timeOut:5e3}),t.settings.额外模型解析配置.使用函数调用=!0)}),(e,o)=>((0,P.openBlock)(),(0,P.createElementBlock)('div',me,[o[50]||(o[50]=(0,P.createElementVNode)('div',{class:'inline-drawer-toggle inline-drawer-header'},[(0,P.createElementVNode)('b',null,'MVU 变量框架'),(0,P.createElementVNode)('div',{class:'inline-drawer-icon fa-solid fa-circle-chevron-down down'})],-1)),(0,P.createElementVNode)('div',fe,[(0,P.createElementVNode)('div',ve,[o[23]||(o[23]=(0,P.createElementVNode)('div',null,[(0,P.createElementVNode)('strong',null,'通知设置')],-1)),(0,P.createElementVNode)('label',ge,[(0,P.withDirectives)((0,P.createElementVNode)('input',{id:'mvu_notification_error','onUpdate:modelValue':o[0]||(o[0]=e=>(0,P.unref)(t).settings.通知.变量更新出错=e),type:'checkbox'},null,512),[[P.vModelCheckbox,(0,P.unref)(t).settings.通知.变量更新出错]]),o[21]||(o[21]=(0,P.createElementVNode)('span',null,'变量更新出错时通知',-1))]),(0,P.createElementVNode)('label',he,[(0,P.withDirectives)((0,P.createElementVNode)('input',{id:'mvu_notification_extra_model_parsing','onUpdate:modelValue':o[1]||(o[1]=e=>(0,P.unref)(t).settings.通知.额外模型解析中=e),type:'checkbox'},null,512),[[P.vModelCheckbox,(0,P.unref)(t).settings.通知.额外模型解析中]]),o[22]||(o[22]=(0,P.createElementVNode)('span',null,'额外模型解析中通知',-1))])]),o[47]||(o[47]=(0,P.createElementVNode)('hr',null,null,-1)),(0,P.createElementVNode)('div',be,[(0,P.createElementVNode)('div',null,[o[24]||(o[24]=(0,P.createElementVNode)('strong',null,'变量更新方式',-1)),(0,P.createElementVNode)('i',{class:'fa-solid fa-circle-question fa-sm note-link-span',style:{cursor:'pointer'},onClick:i})]),(0,P.withDirectives)((0,P.createElementVNode)('select',{id:'mvu_update_method','onUpdate:modelValue':o[2]||(o[2]=e=>(0,P.unref)(t).settings.更新方式=e),class:'text_pole'},[...o[25]||(o[25]=[(0,P.createElementVNode)('option',{value:'随AI输出'},'随AI输出',-1),(0,P.createElementVNode)('option',{value:'额外模型解析'},'额外模型解析',-1)])],512),[[P.vModelSelect,(0,P.unref)(t).settings.更新方式]]),'额外模型解析'===(0,P.unref)(t).settings.更新方式?((0,P.openBlock)(),(0,P.createElementBlock)(P.Fragment,{key:0},[(0,P.createElementVNode)('label',null,[o[26]||(o[26]=(0,P.createTextVNode)(' 解析方式 ',-1)),(0,P.createElementVNode)('i',{class:'fa-solid fa-circle-question fa-sm note-link-span',style:{cursor:'pointer'},onClick:l})]),(0,P.createElementVNode)('label',ye,[(0,P.withDirectives)((0,P.createElementVNode)('input',{id:'mvu_extra_model_send_preset','onUpdate:modelValue':o[3]||(o[3]=e=>(0,P.unref)(t).settings.额外模型解析配置.发送预设=e),type:'checkbox'},null,512),[[P.vModelCheckbox,(0,P.unref)(t).settings.额外模型解析配置.发送预设]]),o[27]||(o[27]=(0,P.createElementVNode)('span',null,'发送预设',-1))]),(0,P.createElementVNode)('label',Ee,[(0,P.withDirectives)((0,P.createElementVNode)('input',{id:'mvu_extra_model_use_function_calling','onUpdate:modelValue':o[4]||(o[4]=e=>(0,P.unref)(t).settings.额外模型解析配置.使用函数调用=e),type:'checkbox'},null,512),[[P.vModelCheckbox,(0,P.unref)(t).settings.额外模型解析配置.使用函数调用]]),o[28]||(o[28]=(0,P.createElementVNode)('span',null,'使用函数调用',-1))]),o[39]||(o[39]=(0,P.createElementVNode)('label',{for:'mvu_extra_model_source'},'模型来源',-1)),(0,P.withDirectives)((0,P.createElementVNode)('select',{id:'mvu_extra_model_source','onUpdate:modelValue':o[5]||(o[5]=e=>(0,P.unref)(t).settings.额外模型解析配置.模型来源=e),class:'text_pole'},[...o[29]||(o[29]=[(0,P.createElementVNode)('option',{value:'与插头相同'},'与插头相同',-1),(0,P.createElementVNode)('option',{value:'自定义'},'自定义',-1)])],512),[[P.vModelSelect,(0,P.unref)(t).settings.额外模型解析配置.模型来源]]),'自定义'===(0,P.unref)(t).settings.额外模型解析配置.模型来源?((0,P.openBlock)(),(0,P.createElementBlock)(P.Fragment,{key:0},[(0,P.createElementVNode)('div',xe,[o[30]||(o[30]=(0,P.createElementVNode)('label',{for:'mvu_api_url'},'API 地址',-1)),(0,P.withDirectives)((0,P.createElementVNode)('input',{id:'mvu_api_url','onUpdate:modelValue':o[6]||(o[6]=e=>(0,P.unref)(t).settings.额外模型解析配置.api地址=e),type:'text',class:'text_pole',placeholder:'http://localhost:1234/v1'},null,512),[[P.vModelText,(0,P.unref)(t).settings.额外模型解析配置.api地址]])]),(0,P.createElementVNode)('div',Ae,[o[31]||(o[31]=(0,P.createElementVNode)('label',{for:'mvu_api_key'},'API 密钥',-1)),(0,P.withDirectives)((0,P.createElementVNode)('input',{id:'mvu_api_key','onUpdate:modelValue':o[7]||(o[7]=e=>(0,P.unref)(t).settings.额外模型解析配置.密钥=e),type:'password',class:'text_pole',placeholder:'留空表示无需密钥'},null,512),[[P.vModelText,(0,P.unref)(t).settings.额外模型解析配置.密钥]])]),(0,P.createElementVNode)('div',Se,[o[32]||(o[32]=(0,P.createElementVNode)('label',{for:'mvu_model_name'},'模型名称',-1)),(0,P.withDirectives)((0,P.createElementVNode)('input',{id:'mvu_model_name','onUpdate:modelValue':o[8]||(o[8]=e=>(0,P.unref)(t).settings.额外模型解析配置.模型名称=e),type:'text',class:'text_pole',placeholder:'gemini-2.5-flash'},null,512),[[P.vModelText,(0,P.unref)(t).settings.额外模型解析配置.模型名称]])]),(0,P.unref)(a)?(0,P.createCommentVNode)('v-if',!0):((0,P.openBlock)(),(0,P.createElementBlock)('div',Ve,[...o[33]||(o[33]=[(0,P.createElementVNode)('hr',null,null,-1),(0,P.createTextVNode)(' ⚠️酒馆助手版本过低, 不支持以下配置⚠️ ',-1)])])),(0,P.createElementVNode)('div',$e,[o[34]||(o[34]=(0,P.createElementVNode)('label',{for:'mvu_max_tokens'},'最大回复token数',-1)),(0,P.withDirectives)((0,P.createElementVNode)('input',{id:'mvu_max_tokens','onUpdate:modelValue':o[9]||(o[9]=e=>(0,P.unref)(t).settings.额外模型解析配置.最大回复token数=e),disabled:!(0,P.unref)(a),type:'number',class:'text_pole',min:'0',step:'128',placeholder:'1000'},null,8,we),[[P.vModelText,(0,P.unref)(t).settings.额外模型解析配置.最大回复token数]])]),(0,P.createElementVNode)('div',Te,[o[35]||(o[35]=(0,P.createElementVNode)('label',{for:'mvu_temperature'},'温度',-1)),(0,P.withDirectives)((0,P.createElementVNode)('input',{id:'mvu_temperature','onUpdate:modelValue':o[10]||(o[10]=e=>(0,P.unref)(t).settings.额外模型解析配置.温度=e),disabled:!(0,P.unref)(a),type:'number',class:'text_pole',min:'0',max:'2',step:'0.01',placeholder:'1.0'},null,8,Ne),[[P.vModelText,(0,P.unref)(t).settings.额外模型解析配置.温度]])]),(0,P.createElementVNode)('div',Me,[o[36]||(o[36]=(0,P.createElementVNode)('label',{for:'mvu_frequency_penalty'},'频率惩罚',-1)),(0,P.withDirectives)((0,P.createElementVNode)('input',{id:'mvu_frequency_penalty','onUpdate:modelValue':o[11]||(o[11]=e=>(0,P.unref)(t).settings.额外模型解析配置.频率惩罚=e),disabled:!(0,P.unref)(a),type:'number',class:'text_pole',min:'-2',max:'2',step:'0.01',placeholder:'0.0'},null,8,Ce),[[P.vModelText,(0,P.unref)(t).settings.额外模型解析配置.频率惩罚]])]),(0,P.createElementVNode)('div',ke,[o[37]||(o[37]=(0,P.createElementVNode)('label',{for:'mvu_presence_penalty'},'存在惩罚',-1)),(0,P.withDirectives)((0,P.createElementVNode)('input',{id:'mvu_presence_penalty','onUpdate:modelValue':o[12]||(o[12]=e=>(0,P.unref)(t).settings.额外模型解析配置.存在惩罚=e),disabled:!(0,P.unref)(a),type:'number',class:'text_pole',min:'-2',max:'2',step:'0.01',placeholder:'0.0'},null,8,Ie),[[P.vModelText,(0,P.unref)(t).settings.额外模型解析配置.存在惩罚]])]),(0,P.createElementVNode)('div',Ue,[o[38]||(o[38]=(0,P.createElementVNode)('label',{for:'mvu_presence_penalty'},'Top P',-1)),(0,P.withDirectives)((0,P.createElementVNode)('input',{id:'mvu_presence_penalty','onUpdate:modelValue':o[13]||(o[13]=e=>(0,P.unref)(t).settings.额外模型解析配置.top_p=e),disabled:!(0,P.unref)(a),type:'number',class:'text_pole',min:'0',max:'1',step:'0.01',placeholder:'1.0'},null,8,Oe),[[P.vModelText,(0,P.unref)(t).settings.额外模型解析配置.top_p]])])],64)):(0,P.createCommentVNode)('v-if',!0)],64)):(0,P.createCommentVNode)('v-if',!0)]),o[48]||(o[48]=(0,P.createElementVNode)('hr',null,null,-1)),(0,P.createElementVNode)('div',Pe,[o[45]||(o[45]=(0,P.createElementVNode)('div',null,[(0,P.createElementVNode)('strong',null,'杂项配置')],-1)),(0,P.createElementVNode)('div',De,[(0,P.createElementVNode)('button',{style:{background:'transparent'},onClick:o[14]||(o[14]=e=>n.value=!n.value)},(0,P.toDisplayString)(n.value?'收起-变量清理配置':'展开-变量清理配置'),1),(0,P.createVNode)(P.Transition,{name:'collapse',persisted:''},{default:(0,P.withCtx)(()=>[(0,P.withDirectives)((0,P.createElementVNode)('div',je,[(0,P.createElementVNode)('div',Le,[o[40]||(o[40]=(0,P.createElementVNode)('label',{for:'mvu_snapshot_interval'},'快照保留间隔',-1)),(0,P.withDirectives)((0,P.createElementVNode)('input',{id:'mvu_snapshot_interval','onUpdate:modelValue':o[15]||(o[15]=e=>(0,P.unref)(t).settings.快照保留间隔=e),type:'number',min:'1',step:'1',class:'text_pole',placeholder:'50'},null,512),[[P.vModelText,(0,P.unref)(t).settings.快照保留间隔,void 0,{number:!0}]])]),(0,P.createElementVNode)('div',Re,[o[41]||(o[41]=(0,P.createElementVNode)('label',{for:'mvu_snapshot_interval'},'要保留变量的最近楼层数',-1)),(0,P.withDirectives)((0,P.createElementVNode)('input',{id:'mvu_snapshot_interval','onUpdate:modelValue':o[16]||(o[16]=e=>(0,P.unref)(t).settings.auto_cleanup.要保留变量的最近楼层数=e),type:'number',min:'1',step:'1',class:'text_pole',placeholder:'50'},null,512),[[P.vModelText,(0,P.unref)(t).settings.auto_cleanup.要保留变量的最近楼层数,void 0,{number:!0}]])]),(0,P.createElementVNode)('div',Be,[o[42]||(o[42]=(0,P.createElementVNode)('label',{for:'mvu_snapshot_interval'},'触发恢复变量的最近楼层数',-1)),(0,P.withDirectives)((0,P.createElementVNode)('input',{id:'mvu_snapshot_interval','onUpdate:modelValue':o[17]||(o[17]=e=>(0,P.unref)(t).settings.auto_cleanup.触发恢复变量的最近楼层数=e),type:'number',min:'1',step:'1',class:'text_pole',placeholder:'50'},null,512),[[P.vModelText,(0,P.unref)(t).settings.auto_cleanup.触发恢复变量的最近楼层数,void 0,{number:!0}]])])],512),[[P.vShow,n.value]])]),_:1})]),(0,P.createElementVNode)('div',Fe,[(0,P.createElementVNode)('button',{style:{background:'transparent'},onClick:o[18]||(o[18]=e=>s.value=!s.value)},(0,P.toDisplayString)(s.value?'收起-兼容配置':'展开-兼容配置'),1),(0,P.createVNode)(P.Transition,{name:'collapse',persisted:''},{default:(0,P.withCtx)(()=>[(0,P.withDirectives)((0,P.createElementVNode)('div',Ge,[(0,P.createElementVNode)('label',Je,[(0,P.withDirectives)((0,P.createElementVNode)('input',{id:'mvu_update_to_chat','onUpdate:modelValue':o[19]||(o[19]=e=>(0,P.unref)(t).settings.更新到聊天变量=e),type:'checkbox'},null,512),[[P.vModelCheckbox,(0,P.unref)(t).settings.更新到聊天变量]]),o[43]||(o[43]=(0,P.createElementVNode)('span',null,'变量更新到聊天变量',-1)),(0,P.createElementVNode)('i',{class:'fa-solid fa-circle-question fa-sm note-link-span',style:{cursor:'pointer'},onClick:r})])],512),[[P.vShow,s.value]])]),_:1})]),(0,P.createElementVNode)('label',ze,[(0,P.withDirectives)((0,P.createElementVNode)('input',{id:'mvu_auto_clean_checkbox','onUpdate:modelValue':o[20]||(o[20]=e=>(0,P.unref)(t).settings.auto_cleanup.启用=e),type:'checkbox'},null,512),[[P.vModelCheckbox,(0,P.unref)(t).settings.auto_cleanup.启用]]),o[44]||(o[44]=(0,P.createElementVNode)('span',null,'变量自动清理',-1))])]),o[49]||(o[49]=(0,P.createElementVNode)('hr',null,null,-1)),(0,P.createElementVNode)('div',qe,[o[46]||(o[46]=(0,P.createElementVNode)('div',null,[(0,P.createElementVNode)('strong',null,'修复按钮')],-1)),(0,P.createElementVNode)('div',He,[((0,P.openBlock)(!0),(0,P.createElementBlock)(P.Fragment,null,(0,P.renderList)((0,P.unref)(re),e=>((0,P.openBlock)(),(0,P.createElementBlock)('div',{key:e.name,class:'menu_button menu_button_icon interactable',tabindex:'0',role:'button',onClick:e.function},(0,P.toDisplayString)(e.name),9,Ye))),128))])])])]))}});c(866);const Xe=(0,c(262).A)(We,[['__scopeId','data-v-5fd73bac']]),Ze=(0,P.createApp)(Xe);function Ke(){!function(){if($(`head > div[script_id="${getScriptId()}"]`).length>0)return;const e=$('<div>').attr('script_id',getScriptId()).append($('head > style',document).clone());$('head').append(e)}();const e=$('<div>').attr('script_id',getScriptId());$('#extensions_settings2').append(e),Ze.use(n()).mount(e[0])}function Qe(){Ze.unmount(),$(`#extensions_settings2 > div[script_id="${getScriptId()}"]`).remove(),$(`head > div[script_id="${getScriptId()}"]`).remove()}let et=!1,tt=!1;async function at(e){const t=L().settings;if(tt=!1,'随AI输出'===t.更新方式)return;if(t.额外模型解析配置.使用函数调用&&!N())return void toastr.warning('当前预设/API 不支持函数调用，已退化回 `随AI输出`','[MVU]无法使用函数调用',{timeOut:2e3});const a=/\[mvu_update\]/i,n=/\[mvu_plot\]/i,s=e=>{_.remove(e,e=>{const t=e.comment.match(a),s=e.comment.match(n);return et?s&&!t:!s&&t}).length>0&&(tt=!0)};s(e.globalLore),s(e.characterLore),s(e.chatLore),s(e.personaLore)}let nt=null;async function st(e){const t=getChatMessages(e).at(-1);if(!t)return;if(t.message.length<5)return;const a=L().settings;if(et=!1,oe=tt,'随AI输出'===a.更新方式||a.额外模型解析配置.使用函数调用&&!N()||!1===tt)return void await Q(e);if(SillyTavern.chat.length<=1)return void console.log('[MVU] 对第一层永不进行额外模型解析');et=!0;let n='---\n<must>\n紧急变量更新任务:\n  description: 你收到了一个关乎用户生死存亡的紧急任务，为了拯救用户，你必须立即停止角色扮演，不再续写发送给你的任何剧情，以最高优先级仅按照给定要求和格式对变量进行更新\n  reference: 在`<past_observe>`中包含了最新的剧情情况，而给定的变量状态是在该剧情发生之前的状态\n  rule: 你必须立即停止角色扮演，以旁白视角，根据剧情情况和给定的剧情发生前变量状态，分析经过这段剧情后，变量会发生什么变化，并按规则输出变量更新命令\n  format: |-\n    <UpdateVariable>$(除了<UpdateVariable>块外不输出任何内容)\n    ...\n    </UpdateVariable>\n</must>';a.额外模型解析配置.使用函数调用&&(n+='\n use `mvu_VariableUpdate` tool to update variables.');const s=!1===a.额外模型解析配置.发送预设?generateRaw:generate;let i='',r=0;try{ue(!0),console.log('Before RegisterMacro'),o(V(),'1.13.4','<=')&&await new Promise(e=>setTimeout(e,1e3)),SillyTavern.registerMacro('lastUserMessage',()=>n),console.log('After RegisterMacro');const e=[{id:'817114514',position:'in_chat',depth:0,should_scan:!1,role:'system',content:n},{id:'817114515',position:'in_chat',depth:2,should_scan:!1,role:'assistant',content:'<past_observe>'},{id:'817114516',position:'in_chat',depth:1,should_scan:!1,role:'assistant',content:'</past_observe>'}];let t;if(a.额外模型解析配置.使用函数调用){nt=SillyTavern.ToolManager.parseToolCalls;const e=SillyTavern.ToolManager.parseToolCalls.bind(SillyTavern.ToolManager);SillyTavern.ToolManager.parseToolCalls=(a,n)=>{e(a,n),t=a}}for(r=0;r<3;r++){a.通知.额外模型解析中&&toastr.info('[MVU]额外模型分析变量更新中...'+(0===r?'':` 重试 ${r}/3`)),t=void 0;const n=(e,t)=>o(T(),'4.3.9','>=')&&e===t?'unset':e,l=await s('与插头相同'===a.额外模型解析配置.模型来源?{user_input:'遵循后续的 <must> 指令',injects:e,max_chat_history:2,should_stream:a.额外模型解析配置.使用函数调用}:{user_input:'遵循后续的 <must> 指令',custom_api:{apiurl:a.额外模型解析配置.api地址,key:a.额外模型解析配置.密钥,model:a.额外模型解析配置.模型名称,max_tokens:a.额外模型解析配置.最大回复token数,temperature:n(a.额外模型解析配置.温度,1),frequency_penalty:n(a.额外模型解析配置.频率惩罚,0),presence_penalty:n(a.额外模型解析配置.存在惩罚,0),top_p:n(a.额外模型解析配置.top_p,1)},injects:e,max_chat_history:2,should_stream:a.额外模型解析配置.使用函数调用});if(void 0!==t){const e=_.get(t,'[0]');if(e){const t=_(e).findLast(e=>e.function.name===ce);if(t){const e=_.get(t,'function.arguments');if(e)try{const t=JSON.parse(e);if(t.delta&&t.delta.length>5){i+='<UpdateVariable>\n',i+=`<Analyze>\n${t.analysis}\n</Analyze>\n`;try{O(t.delta.replaceAll(/```.*/gm,'')),i+=`<JSONPatch>${t.delta}</JSONPatch>\n`}catch(e){i+=`${t.delta}\n`}i+='</UpdateVariable>';break}}catch(t){console.log(`failed to parse function call content,retry: ${e}: ${t}`)}}}}console.log(`Vanilla Response: ${l}`);const c=_([...l.matchAll(/<(update(?:variable)?|variableupdate)>/gi)]).last()?.[1];if(!c)continue;const d=l.lastIndexOf(`<${c}>`);if(-1===d)continue;const u=l.indexOf(`</${c}>`,d),p=l.slice(d+2+c.length,-1===u?void 0:u);if(p){const e=/_\.(?:set|insert|assign|remove|unset|delete|add)\s*\([\s\S]*?\)\s*;/.test(p),t=/json_?patch/i.test(p);if(e||t){i=`<UpdateVariable>${p}</UpdateVariable>`;break}}}}catch(t){return console.error(`变量更新请求发生错误: ${t}`),void await Q(e)}finally{null!==nt&&(SillyTavern.ToolManager.parseToolCalls=nt,nt=null),SillyTavern.unregisterMacro('lastUserMessage'),ue(!1),et=!1,tt=!0}if(''!==i){const t=getChatMessages(e);await setChatMessages([{message_id:e,message:t[0].message+i}],{refresh:'none'})}else toastr.error('建议调整变量更新方式/额外模型解析模式','[MVU]额外模型分析变量更新失败');await Q(e)}async function it(){o(T(),'3.4.17','<')&&toastr.warning('酒馆助手版本过低, 无法正常处理, 请更新至 3.4.17 或更高版本（建议保持酒馆助手最新）','[MVU]不支持当前酒馆助手版本');const t=L();appendInexistentScriptButtons(re.map(e=>({name:e.name,visible:!1}))),re.forEach(e=>{U(getButtonEvent(e.name),e.function)}),!1===t.settings.更新到聊天变量&&await async function(){updateVariablesWith(e=>(_.unset(e,'initialized_lorebooks'),_.unset(e,'stat_data'),_.unset(e,'schema'),_.unset(e,'display_data'),_.unset(e,'delta_data'),e),{type:'chat'})}();const{要保留变量的最近楼层数:a,启用:n}=t.settings.auto_cleanup;if(n&&SillyTavern.chat.length>a+5&&_.has(SillyTavern.chat,[1,'variables',0,'stat_data'])&&!_.has(SillyTavern.chat,[1,'variables',0,'ignore_cleanup'])){const e=await SillyTavern.callGenericPopup('检测可以清理本聊天文件的旧变量从而减少文件体积, 是否清理?(备份会消耗较多内存，手机上建议关闭其他后台应用后进行，或是在计算机上备份)',SillyTavern.POPUP_TYPE.CONFIRM,'',{okButton:'仅清理',cancelButton:'不再提醒',customButtons:['备份并清理']});if(e===SillyTavern.POPUP_RESULT.CANCELLED||e===SillyTavern.POPUP_RESULT.NEGATIVE)_.set(SillyTavern.chat,[1,'variables',0,'ignore_cleanup'],!0);else{toastr.info(`即将开始清理就聊天记录的变量${e===SillyTavern.POPUP_RESULT.CUSTOM1?'，自动生成备份':''}...`,'[MVU]自动清理');let n=!1;if(e===SillyTavern.POPUP_RESULT.CUSTOM1||2===e)try{const e={is_group:!1,avatar_url:SillyTavern.characters[Number(SillyTavern.characterId)]?.avatar,file:`${SillyTavern.getCurrentChatId()}.jsonl`,exportfilename:`${SillyTavern.getCurrentChatId()}.jsonl`,format:'jsonl'},t=await fetch('/api/chats/export',{method:'POST',body:JSON.stringify(e),headers:SillyTavern.getRequestHeaders()}),a=await t.json();if(t.ok){toastr.success(a.message);const t=a.result,s=new Blob([t],{type:'text/plain'}),i=URL.createObjectURL(s),o=document.createElement('a');o.href=i,o.download=e.exportfilename,o.click(),URL.revokeObjectURL(i),n=!0}else toastr.error(`聊天记录导出失败，放弃清理: ${a.message}`,'[MVU]自动清理')}catch(e){toastr.error(`聊天记录导出失败，放弃清理: ${e}`,'[MVU]自动清理')}if(e===SillyTavern.POPUP_RESULT.AFFIRMATIVE||n){const e=te(1,SillyTavern.chat.length-1-a,t.settings.快照保留间隔);e>0&&toastr.info(`已清理老聊天记录中的 ${e} 条消息`,'[MVU]自动清理',{timeOut:1e3})}}}U(tavern_events.MESSAGE_DELETED,_.debounce(async()=>{const t=SillyTavern.chat.length-1,n=L(),{触发恢复变量的最近楼层数:s}=n.settings.auto_cleanup,i=Math.max(1,t-s),o=SillyTavern.chat.findLastIndex(e=>!_.has(e,['variables',e.swipe_id??0,'stat_data'])||!_.has(e,['variables',e.swipe_id??0,'schema']));if(i>o)return void console.info(`最近 ${s} 层都包含变量数据，不需要进行恢复。`);const r=Math.max(1,t-a),l=k(r);if(-1===l||!_.has(SillyTavern.chat,[l,'variables',0,'stat_data']))return void toastr.warning(`在 0 ~ ${r} 层找不到有效的变量信息，无法进行楼层变量恢复`,'[MVU]恢复旧楼层变量');const c=SillyTavern.chat[l];toastr.info('恢复变量内容中...','[MVU]恢复旧楼层变量',{timeOut:1e3});let d=SillyTavern.chat[l+1].mes,u=e(c.variables[c.swipe_id??0]);for(let t=l+1;t<=o;t++){d=SillyTavern.chat[t].mes,await K(d,u);const a=SillyTavern.chat[t],n=_.has(a,['variables',a.swipe_id??0,'stat_data'])&&_.has(a,['variables',a.swipe_id??0,'schema']);t>=r&&!n&&(await updateVariablesWith(e=>(e.initialized_lorebooks=u.initialized_lorebooks,e.stat_data=u.stat_data,void 0!==u.schema?e.schema=u.schema:_.unset(e,'schema'),e.display_data=u.display_data,e.delta_data=u.delta_data,e),{type:'message',message_id:t}),u=e(u))}toastr.info('恢复完成。','[MVU]恢复旧楼层变量',{timeOut:3e3})},2e3)),U(tavern_events.GENERATION_STARTED,ne),U(tavern_events.MESSAGE_SENT,ne),U(tavern_events.MESSAGE_SENT,Q),U('worldinfo_entries_loaded',at),U(tavern_events.MESSAGE_RECEIVED,M?st:_.throttle(st,3e3)),ie=st,U(v,ee),U(g,X),U(tavern_events.CHAT_COMPLETION_SETTINGS_READY,_e),_.set(window.parent,'handleVariablesInMessage',Q),function(){const{registerFunctionTool:e}=SillyTavern;if(!e)return void console.debug('MVU: function tools are not supported');const t=Object.freeze({$schema:'http://json-schema.org/draft-04/schema#',type:'object',additionalProperties:!1,properties:{analysis:{type:'string',minLength:1,description:'Write in ENGLISH. A compact reasoning summary that includes: (1) calculate time passed; (2) decide whether dramatic updates are allowed (special case or sufficiently long time); (3) list every variable name BEFORE actual variable analysis, without revealing their contents; (4) for each variable, judge whether it satisfies its change conditions and output only Y/N without reasons; (5) only evaluate stories inside <past_observe> block.'},delta:{type:'string',minLength:0,description:'variable update block'}},required:['delta']});e({name:ce,displayName:'MVU update',stealth:!0,description:'use this tool to UpdateVariable.',parameters:t,shouldRegister:()=>!!de&&L().settings.额外模型解析配置.使用函数调用,action:pe,formatMessage:()=>''})}(),U(tavern_events.MESSAGE_RECEIVED,e=>{const t=L(),{启用:n}=t.settings.auto_cleanup;if(!n)return;if(SillyTavern.chat.length%5!=0)return;const s=e-a;if(s>0){const e=te(Math.max(1,s-2-2*a),s,t.settings.快照保留间隔);console.log(`[MVU]已清理 ${e} 层的消息`)}}),function(){const e=L();!1===e.settings.internal.已提醒更新了配置界面&&(toastr.info('配置界面位于酒馆扩展界面-「正则」下方, 请点开了解新功能或自定义配置','[MVU]已更新独立配置界面'),e.settings.internal.已提醒更新了配置界面=!0),!1===e.settings.internal.已提醒自动清理旧变量功能&&(toastr.info('MVU 现在可以自动清理旧变量来减少聊天文件大小; 这不会影响你回退游玩以前的楼层；在设置中开启 `变量自动清理` 启用','[MVU]已更新自动清理旧变量功能'),e.settings.internal.已提醒自动清理旧变量功能=!0),!1===e.settings.internal.已提醒更新了API温度等配置&&(toastr.info('MVU 现在可以自定义 API 的温度、频率惩罚、存在惩罚、最大回复 token 数；需要酒馆助手版本 >= 4.0.14','[MVU]已更新更多自定义API配置'),e.settings.internal.已提醒更新了API温度等配置=!0),!1===e.settings.internal.已默认开启自动清理旧变量功能&&toastr.info('MVU 现在会自动清理较老楼层上的变量信息，以降低聊天文件大小。','[MVU]已更新自动清理配置')}(),!1===t.settings.internal.已默认开启自动清理旧变量功能&&(t.settings.internal.已默认开启自动清理旧变量功能=!0,t.settings.auto_cleanup.启用=!0),toastr.info('构建信息: 2025-12-19T17:02:37.686Z (b7ebd7a)','[MVU]脚本加载成功')}async function ot(){null!==nt&&(SillyTavern.ToolManager.parseToolCalls=nt,nt=null),SillyTavern.unregisterFunctionTool(ce),SillyTavern.unregisterFunctionTool('mvu_updateRound'),I.forEach(e=>e())}$(async()=>{await async function(){S=await fetch('/version').then(e=>e.json()).then(e=>e.pkgVersion).catch(()=>'1.0.0')}(),await async function(){w=await A.getTavernHelperVersion()}(),function(){const e=le();_.set(window,'Mvu',e),_.set(window.parent,'Mvu',e),eventEmit('global_Mvu_initialized')}(),await Ke(),eventOn(tavern_events.CHAT_CHANGED,lt),await it()}),$(window).on('pagehide',async()=>{Qe(),ot(),_.unset(window.parent,'Mvu')});let rt=SillyTavern.getCurrentChatId();function lt(e){rt!==e&&(rt=e,ot(),it())}
//# sourceMappingURL=bundle.js.map