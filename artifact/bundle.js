import*as t from'https://testingcf.jsdelivr.net/npm/json5/+esm';import*as e from'https://testingcf.jsdelivr.net/npm/toml/+esm';var a={};a.d=(t,e)=>{for(var s in e)a.o(e,s)&&!a.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},a.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);const s={SINGLE_VARIABLE_UPDATED:'mag_variable_updated',VARIABLE_UPDATE_ENDED:'mag_variable_update_ended',VARIABLE_UPDATE_STARTED:'mag_variable_update_started'},n='mag_invoke_mvu',i='mag_update_variable';const r={是否显示变量更新错误:'是'},o={type:'script',script_id:getScriptId()};function c(t){const e=['是否显示变量更新错误'];for(const a of e)if(a in t){const e=t[a];('string'!=typeof e||'是'!==e)&&(t[a]='否')}}async function l(){const t=getVariables(o)||{};if(!function(t){return!(!t||'object'!=typeof t)&&'是否显示变量更新错误'in t&&'string'==typeof t.是否显示变量更新错误}(t)){const e=_.merge({},r,t);return c(e),await replaceVariables(e,o),e}const e=_.merge({},r,t);return c(e),_.isEqual(t,e)||await replaceVariables(e,o),e}function d(t){return _.isString(t)?t.replace(/^[\\"'` ]*(.*?)[\\"'` ]*$/,'$1'):t}function u(t,e){let a=1,s=!1,n='';for(let i=e;i<t.length;i++){const e=t[i],r=i>0?t[i-1]:'';if('"'!==e&&'\''!==e&&'`'!==e||'\\'===r||(s?e===n&&(s=!1):(s=!0,n=e)),!s)if('('===e)a++;else if(')'===e&&(a--,0===a))return i}return-1}function g(t){const e=[];let a='',s=!1,n='',i=0,r=0;for(let o=0;o<t.length;o++){const c=t[o];'"'!==c&&'\''!==c&&'`'!==c||0!==o&&'\\'===t[o-1]||(s?c===n&&(s=!1):(s=!0,n=c)),'['===c&&i++,']'===c&&i--,'{'===c&&r++,'}'===c&&r--,','!==c||s||0!==i||0!==r?a+=c:(e.push(a.trim()),a='')}return a.trim()&&e.push(a.trim()),e}async function f(t){return structuredClone(_(SillyTavern.chat).slice(0,t+1).map((t=>_.get(t,['variables',t.swipe_id??0]))).findLast((t=>_.has(t,'stat_data'))))??getVariables()}function p(t){const e=[];let a='',s=!1,n='';for(let i=0;i<t.length;i++){const r=t[i];'"'!==r&&'\''!==r||0!==i&&'\\'===t[i-1]?'.'!==r||s?a+=r:(e.push(a),a=''):s?r===n?s=!1:a+=r:(s=!0,n=r)}return a&&e.push(a),e.join('.')}async function y(t,e,a,n='',i=!1){const r=t.$internal?.display_data,o=t.$internal?.delta_data;if(_.has(t,e)){const c=_.get(t,e);if(Array.isArray(c)&&2===c.length){const l=_.cloneDeep(c[0]);c[0]=a,_.set(t,e,c);const u=n?`(${n})`:'',g=`${d(JSON.stringify(l))}->${d(JSON.stringify(a))} ${u}`;return r&&_.set(r,e,g),o&&_.set(o,e,g),console.info(`Set '${e}' to '${d(JSON.stringify(a))}' ${u}`),i&&await eventEmit(s.SINGLE_VARIABLE_UPDATED,t,e,l,a),!0}{const l=_.cloneDeep(c);_.set(t,e,a);const u=n?`(${n})`:'',g=d(JSON.stringify(a)),f=`${d(JSON.stringify(l))}->${g} ${u}`;return r&&_.set(r,e,f),o&&_.set(o,e,f),console.info(`Set '${e}' to '${g}' ${u}`),i&&await eventEmit(s.SINGLE_VARIABLE_UPDATED,t,e,l,a),!0}}return!1}async function h(t,e){const a=!1,n=_.cloneDeep(e),i={stat_data:{}},r=function(t){const e=[];let a=0;for(;a<t.length;){const s=t.indexOf('_.set(',a);if(-1===s)break;const n=s+6,i=u(t,n);if(-1===i){a=n+1;continue}let r=i+1;if(r<t.length&&';'===t[r]){for(r++;r<t.length&&' '===t[r];)r++;let o='';if(r+1<t.length&&'/'===t[r]&&'/'===t[r+1]){const e=t.indexOf('\n',r);-1!==e?(o=t.substring(r+2,e).trim(),r=e):(o=t.substring(r+2).trim(),r=t.length)}const c=t.substring(n,i),l=t.substring(s,r),u=g(c);u.length>=3?e.push({fullMatch:l,path:d(u[0]),oldValue:d(u[1]),newValue:d(u[2]),reason:o}):2===u.length&&e.push({fullMatch:l,path:d(u[0]),oldValue:d(u[1]),newValue:d(u[1]),reason:o}),a=r}else a=i+1}return e}(t),o=await l();e.stat_data.$internal={display_data:n.stat_data,delta_data:i.stat_data},await eventEmit(s.VARIABLE_UPDATE_STARTED,e,a);let c,f=!1,y=!1;for(const t of r){let{path:a,newValue:r,reason:o}=t;if(a=p(a),_.has(e.stat_data,a)){const t=_.get(e.stat_data,a);if(_.isString(r)&&r.trim().startsWith('[')&&r.trim().endsWith(']'))try{const t=YAML.parse(r);Array.isArray(t)&&t.length>0&&(r=t[0])}catch(t){console.error(`Error parsing JSON array for '${a}': ${t.message}`)}if('number'==typeof t){const c=Number(r),l=t;_.set(e.stat_data,a,c);const d=o?`(${o})`:'',u=`${l}->${c} ${d}`;_.set(n.stat_data,a,u),_.set(i.stat_data,a,u),f=!0,console.info(`Set '${a}' to '${c}' ${d}`),await eventEmit(s.SINGLE_VARIABLE_UPDATED,e.stat_data,a,l,c)}else if(Array.isArray(t)&&2===t.length){const c='number'==typeof t[0]?Number(r):d(r),l=_.cloneDeep(t[0]);t[0]=c,_.set(e.stat_data,a,t);const u=o?`(${o})`:'',g=`${d(JSON.stringify(l))}->${d(JSON.stringify(r))} ${u}`;_.set(n.stat_data,a,g),_.set(i.stat_data,a,g),f=!0,console.info(`Set '${a}' to '${d(JSON.stringify(c))}' ${u}`),await eventEmit(s.SINGLE_VARIABLE_UPDATED,e.stat_data,a,l,c)}else{const c=d(r),l=_.cloneDeep(t);_.set(e.stat_data,a,c);const u=o?`(${o})`:'',g=d(JSON.stringify(c)),p=`${d(JSON.stringify(l))}->${g} ${u}`;_.set(n.stat_data,a,p),_.set(i.stat_data,a,p),f=!0,console.info(`Set '${a}' to '${g}' ${u}`),await eventEmit(s.SINGLE_VARIABLE_UPDATED,e.stat_data,a,l,c)}}else{const t=`undefined Path: ${a}->${r} (${o})`;console.error(t),y=!0,c=t}}return y&&'是'===o.是否显示变量更新错误&&toastr.warning(`最近错误: ${c}`,'发生变量更新错误，可能需要重Roll',{timeOut:6e3}),e.display_data=n.stat_data,e.delta_data=i.stat_data,await eventEmit(s.VARIABLE_UPDATE_ENDED,e,a),delete e.stat_data.$internal,f||a}async function m(t){const e=getChatMessages(t).at(-1);if(!e)return;const a=e.message,s=await f(t);if(!_.has(s,'stat_data'))return void console.error(`cannot found stat_data for ${t}`);if(await h(a,s)){const t=getVariables({type:'chat'});t.stat_data=s.stat_data,t.display_data=s.display_data,t.delta_data=s.delta_data,t.initialized_lorebooks=s.initialized_lorebooks,await replaceVariables(t,{type:'chat'})}await insertOrAssignVariables({stat_data:s.stat_data,display_data:s.display_data,delta_data:s.delta_data,initialized_lorebooks:s.initialized_lorebooks},{type:'message',message_id:t}),'user'===e.role||a.includes('<StatusPlaceHolderImpl/>')||await setChatMessages([{message_id:t,message:a+'\n\n<StatusPlaceHolderImpl/>'}],{refresh:'affected'})}async function b(t,e){if(void 0===e.old_variables)return;e.new_variables=_.cloneDeep(e.old_variables);const a=e.new_variables;await h(t,a)||delete e.new_variables}function v(t,e,a,s){_.forEach(e,((t,e)=>{const n=e;if(_.isArray(t)){if(2===t.length&&_.isString(t[1])){if(_.isArray(_.get(a,n))){const i=_.get(a,n);if(2===i.length)if(_.set(s,`${n}[1]`,t[1]),_.isObject(t[0])&&!_.isArray(t[0])){const a=_.get(s,`${e}[0]`);_.has(t[0],'description')&&_.isString(t[0].description)&&_.has(i[0],'description')&&_.set(s,`${n}[0].description`,t[0].description),v(`${n}[0]`,t[0],i[0],a)}else _.isArray(t[0])&&v(`${n}[0]`,t[0],i[0],s[0])}}else if(_.isArray(_.get(a,n))){const e=_.get(a,n);t.forEach(((a,i)=>{if(i<e.length&&_.isObject(a)){const r=_.get(s,`${n}[${i}]`);_.has(a,'description')&&_.isString(a.description)&&_.has(e[i],'description')&&_.set(r,'description',a.description),v(`${n}[${i}]`,t[i],e[i],r)}}))}}else if(_.isObject(t)){if(_.has(t,'description')&&_.isString(t.description)){const n=`${e}.description`;_.has(a,n)&&_.set(s,n,t.description)}_.has(a,e)&&_.isObject(a[e])&&v(n,t,a[e],s[e])}}))}const w=(t=>{var e={};return a.d(e,t),e})({parse:()=>t.parse});const E=(t=>{var e={};return a.d(e,t),e})({parse:()=>e.parse});async function A(t,e){const a=e||await async function(){const t=[...(await getLorebookSettings()).selected_global_lorebooks],e=await getCurrentCharPrimaryLorebook();return null!==e&&t.push(e),t}();let s=!1;for(const e of a){if(t.initialized_lorebooks.includes(e))continue;t.initialized_lorebooks.push(e);const a=await getLorebookEntries(e);for(const e of a)if(e.comment?.toLowerCase().includes('[initvar]')){const a=substitudeMacros(e.content);let s=null,n=null;try{s=YAML.parse(a)}catch(t){try{s=w.parse(a)}catch(t){try{s=E.parse(a)}catch(t){n=new Error(`Failed to parse content as YAML/JSON, JSON5, or TOML: ${t}`)}}}if(n)throw console.error(`Failed to parse lorebook entry: ${n}`),toastr.error(n.message,'Failed to parse lorebook entry',{timeOut:5e3}),n;s&&(t.stat_data=_.merge(t.stat_data,s))}s=!0}return s}async function S(){let t,e;try{const a=await async function(){let t=[];try{t=await getChatMessages(-2,{role:'assistant',include_swipes:!0})}catch(t){}if(!t||t.length<=0){const e=await getChatMessages(0,{include_swipes:!0});if(!(e&&e.length>0))throw new Error('不存在任何一条消息');t=e}const e=t[0];return{message:e,variables:e.swipes_data[e.swipe_id]}}();t=a.message,e=a.variables??{display_data:{},initialized_lorebooks:[],stat_data:{},delta_data:{}}}catch(t){return void console.error('不存在任何一条消息，退出')}void 0===e&&(e={display_data:{},initialized_lorebooks:[],stat_data:{},delta_data:{}}),_.has(e,'initialized_lorebooks')||(e.initialized_lorebooks=[]),e.stat_data||(e.stat_data={});if(await A(e)){console.info('Init chat variables.'),await insertOrAssignVariables(e);for(let a=0;a<t.swipes.length;a++){const s=_.cloneDeep(e);await h(substitudeMacros(t.swipes[a]),s),await setChatMessage({data:s},t.message_id,{refresh:'none',swipe_id:a})}await async function(){const t={scan_depth:2,context_percentage:100,budget_cap:0,min_activations:0,max_depth:0,max_recursion_steps:0,insertion_strategy:'character_first',include_names:!1,recursive:!0,case_sensitive:!1,match_whole_words:!1,use_group_scoring:!1,overflow_alert:!1},e=getLorebookSettings();_.isEqual(_.merge({},e,t),e)||setLorebookSettings(t)}()}}const V=['重新处理变量','重新读取初始变量'];function O(){!function(){const t=getScriptButtons(getScriptId()),e=t.map((t=>t.name));for(const a of V.filter((t=>!e.includes(t))))t.push({name:a,visible:!1});replaceScriptButtons(getScriptId(),t)}(),eventOnButton('重新处理变量',(async function(){const t=getLastMessageId();t<1||0!==SillyTavern.chat.length&&(await deleteVariable('stat_data',{type:'message',message_id:t}),await deleteVariable('delta_data',{type:'message',message_id:t}),await deleteVariable('display_data',{type:'message',message_id:t}),await m(getLastMessageId()))})),eventOnButton('重新读取初始变量',(async function(){const t={display_data:{},initialized_lorebooks:[],stat_data:{},delta_data:{}};try{if(!await A(t))return console.error('没有找到 InitVar 数据'),void toastr.error('没有找到 InitVar 数据','',{timeOut:3e3})}catch(t){return void console.error('加载 InitVar 数据失败:',t)}const e=getLastMessageId();if(e<0)return console.error('没有找到消息'),void toastr.error('没有找到消息','',{timeOut:3e3});const a=await f(e);if(!_.has(a,'stat_data'))return console.error('最新消息中没有找到 stat_data'),void toastr.error('最新消息中没有 stat_data','',{timeOut:3e3});const s=structuredClone(t);s.stat_data=_.merge(s.stat_data,a.stat_data),v(0,t.stat_data,a.stat_data,s.stat_data),await replaceVariables(s,{type:'message',message_id:e}),console.info('InitVar更新完成'),toastr.success('InitVar描述已更新','',{timeOut:3e3})}))}function D(){return{events:s,parseMessage:async function(t,e){const a={old_variables:e};return await b(t,a),a.new_variables},getMvuData:function(t){return getVariables(t)},replaceMvuData:async function(t,e){await replaceVariables(t,e)},getCurrentMvuData:function(){return getVariables({type:'message',message_id:getCurrentMessageId()})},replaceCurrentMvuData:async function(t){await replaceVariables(t,{type:'message',message_id:getCurrentMessageId()})},reloadInitVar:async function(t){return await A(t)},setMvuVariable:async function(t,e,a,{reason:s='',is_recursive:n=!1}={}){return await y(t.stat_data,e,a,s,n)},getMvuVariable:function(t,e,{category:a='stat',default_value:s}={}){let n;switch(a){case'stat':n=t.stat_data;break;case'display':n=t.display_data;break;case'delta':n=t.delta_data}const i=_.get(n,e,s);return function(t){return Array.isArray(t)&&2===t.length&&'string'==typeof t[1]}(i)?i[0]:i},getRecordFromMvuData:function(t,e){return function(t,e){let a;switch(t){case'stat':a=e.stat_data;break;case'display':a=e.display_data;break;case'delta':a=e.delta_data}return a}(e,t)}}}$((async()=>{O(),function(){const t=D();_.set(window,'Mvu',t),_.set(window.parent,'Mvu',t)}(),eventOn(tavern_events.GENERATION_STARTED,S),eventOn(tavern_events.MESSAGE_SENT,S),eventOn(tavern_events.MESSAGE_SENT,m),eventOn(tavern_events.MESSAGE_RECEIVED,m),eventOn(n,b),eventOn(i,y),await l();try{_.set(parent.window,'handleVariablesInMessage',m)}catch(t){}}));
//# sourceMappingURL=bundle.js.map