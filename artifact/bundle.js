import*as t from'https://fastly.jsdelivr.net/npm/json5';import*as e from'https://fastly.jsdelivr.net/npm/toml';var a={d:(t,e)=>{for(var s in e)a.o(e,s)&&!a.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};const s='mag_variable_updated',n='mag_variable_update_ended',r='mag_variable_update_started',i='mag_invoke_mvu';function o(t){return _.isString(t)?t.replace(/^[\\"'` ]*(.*?)[\\"'` ]*$/,'$1'):t}function c(t,e){let a=1,s=!1,n='';for(let r=e;r<t.length;r++){const e=t[r],i=r>0?t[r-1]:'';if('"'!==e&&'\''!==e&&'`'!==e||'\\'===i||(s?e===n&&(s=!1):(s=!0,n=e)),!s)if('('===e)a++;else if(')'===e&&(a--,0===a))return r}return-1}function l(t){const e=[];let a='',s=!1,n='',r=0,i=0;for(let o=0;o<t.length;o++){const c=t[o];'"'!==c&&'\''!==c&&'`'!==c||0!==o&&'\\'===t[o-1]||(s?c===n&&(s=!1):(s=!0,n=c)),'['===c&&r++,']'===c&&r--,'{'===c&&i++,'}'===c&&i--,','!==c||s||0!==r||0!==i?a+=c:(e.push(a.trim()),a='')}return a.trim()&&e.push(a.trim()),e}async function d(t){return structuredClone(SillyTavern.chat.slice(0,t+1).map((t=>_.get(t,['variables',t.swipe_id??0]))).findLast((t=>_.has(t,'stat_data'))))??getVariables()}function u(t){const e=[];let a='',s=!1,n='';for(let r=0;r<t.length;r++){const i=t[r];'"'!==i&&'\''!==i||0!==r&&'\\'===t[r-1]?'.'!==i||s?a+=i:(e.push(a),a=''):s?i===n?s=!1:a+=i:(s=!0,n=i)}return a&&e.push(a),e.join('.')}async function f(t,e){const a=!1;await eventEmit(r,e,a);const i=_.cloneDeep(e),d={},f=function(t){const e=[];let a=0;for(;a<t.length;){const s=t.indexOf('_.set(',a);if(-1===s)break;const n=s+6,r=c(t,n);if(-1===r){a=n+1;continue}let i=r+1;if(i<t.length&&';'===t[i]){for(i++;i<t.length&&' '===t[i];)i++;let c='';if(i+1<t.length&&'/'===t[i]&&'/'===t[i+1]){const e=t.indexOf('\n',i);-1!==e?(c=t.substring(i+2,e).trim(),i=e):(c=t.substring(i+2).trim(),i=t.length)}const _=t.substring(n,r),d=t.substring(s,i),u=l(_);u.length>=3?e.push({fullMatch:d,path:o(u[0]),oldValue:o(u[1]),newValue:o(u[2]),reason:c}):2===u.length&&e.push({fullMatch:d,path:o(u[0]),oldValue:o(u[1]),newValue:o(u[1]),reason:c}),a=i}else a=r+1}return e}(t);let g=!1;for(const t of f){let{path:a,newValue:n,reason:r}=t;if(a=u(a),_.has(e.stat_data,a)){const t=_.get(e.stat_data,a);if(_.isString(n)&&n.trim().startsWith('[')&&n.trim().endsWith(']'))try{const t=YAML.parse(n);Array.isArray(t)&&t.length>0&&(n=t[0])}catch(t){console.error(`Error parsing JSON array for '${a}': ${t.message}`)}if('number'==typeof t){const o=Number(n),c=t;_.set(e.stat_data,a,o);const l=r?`(${r})`:'',u=`${c}->${o} ${l}`;_.set(i.stat_data,a,u),_.set(d,a,u),g=!0,console.info(`Set '${a}' to '${o}' ${l}`),await eventEmit(s,e.stat_data,a,c,o)}else if(Array.isArray(t)&&2===t.length){const c='number'==typeof t[0]?Number(n):o(n),l=_.cloneDeep(t[0]);t[0]=c,_.set(e.stat_data,a,t);const u=r?`(${r})`:'',f=`${o(JSON.stringify(l))}->${o(JSON.stringify(n))} ${u}`;_.set(i.stat_data,a,f),_.set(d,a,f),g=!0,console.info(`Set '${a}' to '${o(JSON.stringify(c))}' ${u}`),await eventEmit(s,e.stat_data,a,l,c)}else{const c=o(n),l=_.cloneDeep(t);_.set(e.stat_data,a,c);const u=r?`(${r})`:'',f=o(JSON.stringify(c)),p=`${o(JSON.stringify(l))}->${f} ${u}`;_.set(i.stat_data,a,p),_.set(d,a,p),g=!0,console.info(`Set '${a}' to '${f}' ${u}`),await eventEmit(s,e.stat_data,a,l,c)}}else{const t=`undefined Path: ${a}->${n} (${r})`;console.error(t)}}return e.display_data=i.stat_data,e.delta_data=d,await eventEmit(n,e,a),g||a}async function g(t){const e=getChatMessages(t).at(-1);if(!e)return;const a=e.message,s=await d(t);if(!_.has(s,'stat_data'))return void console.error(`cannot found stat_data for ${t}`);await f(a,s)&&await replaceVariables(s,{type:'chat'}),await replaceVariables(s,{type:'message',message_id:t}),'user'===e.role||a.includes('<StatusPlaceHolderImpl/>')||await setChatMessages([{message_id:t,message:a+'\n\n<StatusPlaceHolderImpl/>'}],{refresh:'affected'})}async function p(t,e){if(void 0===e.old_variables)return;e.new_variables=_.cloneDeep(e.old_variables);const a=e.new_variables;await f(t,a)||delete e.new_variables}const h=(t=>{var e={};return a.d(e,t),e})({parse:()=>t.parse});const v=(t=>{var e={};return a.d(e,t),e})({parse:()=>e.parse});async function m(t,e){const a=e||await async function(){const t=[...(await getLorebookSettings()).selected_global_lorebooks],e=await getCurrentCharPrimaryLorebook();return null!==e&&t.push(e),t}();let s=!1;for(const e of a){if(t.initialized_lorebooks.includes(e))continue;t.initialized_lorebooks.push(e);const a=await getLorebookEntries(e);for(const e of a)if(e.comment?.toLowerCase().includes('[initvar]')){const a=substitudeMacros(e.content);let s=null,n=null;try{s=YAML.parse(a)}catch(t){try{s=h.parse(a)}catch(t){try{s=v.parse(a)}catch(t){n=new Error(`Failed to parse content as YAML/JSON, JSON5, or TOML: ${t}`)}}}if(n)throw console.error(`Failed to parse lorebook entry: ${n}`),toastr.error(n.message,'Failed to parse lorebook entry',{timeOut:5e3}),n;s&&(t.stat_data=_.merge(t.stat_data,s))}s=!0}return s}async function w(){let t,e;try{const a=await async function(){let t=[];try{t=await getChatMessages(-2,{role:'assistant',include_swipes:!0})}catch(t){}if(!t||t.length<=0){const e=await getChatMessages(0,{include_swipes:!0});if(!(e&&e.length>0))throw new Error('不存在任何一条消息');t=e}const e=t[0];return{message:e,variables:e.swipes_data[e.swipe_id]}}();t=a.message,e=a.variables??{display_data:{},initialized_lorebooks:[],stat_data:{},delta_data:{}}}catch(t){return void console.error('不存在任何一条消息，退出')}void 0===e&&(e={display_data:{},initialized_lorebooks:[],stat_data:{},delta_data:{}}),_.has(e,'initialized_lorebooks')||(e.initialized_lorebooks=[]),e.stat_data||(e.stat_data={});if(await m(e)){console.info('Init chat variables.'),await insertOrAssignVariables(e);for(let a=0;a<t.swipes.length;a++){const s=_.cloneDeep(e);await f(substitudeMacros(t.swipes[a]),s),await setChatMessage({data:s},t.message_id,{refresh:'none',swipe_id:a})}await async function(){const t={scan_depth:2,context_percentage:100,budget_cap:0,min_activations:0,max_depth:0,max_recursion_steps:0,insertion_strategy:'character_first',include_names:!1,recursive:!0,case_sensitive:!1,match_whole_words:!1,use_group_scoring:!1,overflow_alert:!1},e=getLorebookSettings();_.isEqual(_.merge({},e,t),e)||setLorebookSettings(t)}()}}function b(t,e,a,s){_.forEach(e,((t,e)=>{const n=e;if(_.isArray(t)){if(2===t.length&&_.isString(t[1])){if(_.isArray(_.get(a,n))){const r=_.get(a,n);if(2===r.length)if(_.set(s,`${n}[1]`,t[1]),_.isObject(t[0])&&!_.isArray(t[0])){const a=_.get(s,`${e}[0]`);_.has(t[0],'description')&&_.isString(t[0].description)&&_.has(r[0],'description')&&_.set(s,`${n}[0].description`,t[0].description),b(`${n}[0]`,t[0],r[0],a)}else _.isArray(t[0])&&b(`${n}[0]`,t[0],r[0],s[0])}}else if(_.isArray(_.get(a,n))){const e=_.get(a,n);t.forEach(((a,r)=>{if(r<e.length&&_.isObject(a)){const i=_.get(s,`${n}[${r}]`);_.has(a,'description')&&_.isString(a.description)&&_.has(e[r],'description')&&_.set(i,'description',a.description),b(`${n}[${r}]`,t[r],e[r],i)}}))}}else if(_.isObject(t)){if(_.has(t,'description')&&_.isString(t.description)){const n=`${e}.description`;_.has(a,n)&&_.set(s,n,t.description)}_.has(a,e)&&_.isObject(a[e])&&b(n,t,a[e],s[e])}}))}$((()=>{eventOn(tavern_events.GENERATION_STARTED,w),eventOn(tavern_events.MESSAGE_SENT,w),eventOn(tavern_events.MESSAGE_SENT,g),eventOn(tavern_events.MESSAGE_RECEIVED,g),eventOn(i,p),_.set(window,'handleVariablesInMessage',g)})),$(window).on('unload',(()=>{eventRemoveListener(tavern_events.GENERATION_STARTED,w),eventRemoveListener(tavern_events.MESSAGE_SENT,w),eventRemoveListener(tavern_events.MESSAGE_SENT,g),eventRemoveListener(tavern_events.MESSAGE_RECEIVED,g),eventRemoveListener(i,p)})),eventOnButton('重新处理变量',(async function(){const t=getLastMessageId();t<1||0!==SillyTavern.chat.length&&(await deleteVariable('stat_data',{type:'message',message_id:t}),await g(getLastMessageId()))})),eventOnButton('重新读取初始变量',(async function(){const t={display_data:{},initialized_lorebooks:[],stat_data:{},delta_data:{}};try{if(!await m(t))return console.error('没有找到 InitVar 数据'),void toastr.error('没有找到 InitVar 数据','',{timeOut:3e3})}catch(t){return void console.error('加载 InitVar 数据失败:',t)}const e=getLastMessageId();if(e<0)return console.error('没有找到消息'),void toastr.error('没有找到消息','',{timeOut:3e3});const a=await d(e);if(!_.has(a,'stat_data'))return console.error('最新消息中没有找到 stat_data'),void toastr.error('最新消息中没有 stat_data','',{timeOut:3e3});const s=structuredClone(t);s.stat_data=_.merge(s.stat_data,a.stat_data),b(0,t.stat_data,a.stat_data,s.stat_data),await replaceVariables(s,{type:'message',message_id:e}),console.info('InitVar更新完成'),toastr.success('InitVar描述已更新','',{timeOut:3e3})}));
//# sourceMappingURL=bundle.js.map