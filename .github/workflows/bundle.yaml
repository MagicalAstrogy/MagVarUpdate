name: bundle

on:
    push:
        branches:
            - master
        paths-ignore:
            - artifact/**
    workflow_dispatch:

permissions:
    actions: read
    contents: write

concurrency:
    group: ${{ github.workflow }}

jobs:
    compile:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4
              with:
                  ssh-key: ${{ secrets.GITHUB_TOKEN }}
                  fetch-depth: 0 # ‚Üê ÂøÖÈ°ª
                  submodules: 'recursive'

            - name: Use Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22
            - name: Corepack & Yarn
              run: |
                  corepack enable
                  corepack prepare yarn@3.4.1 --activate
                  if [ -f yarn.lock ]; then
                    echo "üîí Lockfile exists, using immutable install"
                    yarn install --immutable
                  else
                    echo "‚ö†Ô∏è  Lockfile missing, generating..."
                    yarn install
                  fi
            - name: format Code
              run: yarn format
            - run: yarn build
            - name: Commit changes
              uses: EndBug/add-and-commit@v9.1.3
              with:
                  default_author: github_actions
                  message: '[bot] Bundle'

    sync:
        runs-on: ubuntu-latest
        needs: compile
        steps:
            - uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  fetch-depth: 0
            - run: git push origin beta:master -f

    bump_tag:
        runs-on: ubuntu-latest
        needs: sync
        steps:
            - uses: actions/checkout@v4
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  fetch-depth: 0 # ‚Üê ÂøÖÈ°ª

            - name: Github Tag Bump
              uses: anothrNick/github-tag-action@1.73.0
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  TAG_PREFIX: v
                  RELEASE_BRANCHES: master

